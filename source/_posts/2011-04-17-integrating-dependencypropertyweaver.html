---
layout: post
title: "Integrating DependencyPropertyWeaver Into Your Build"
date: 2011-04-17
comments: false
categories:
 - Coding
 - Software Tools
---

<div class='post'>
<p>See the <a href="http://blingcode.blogspot.com/2011/04/introducing-dependencypropertyweaver.html">introduction</a> here.</p> <p>The MSBuild task as it stands currently by default will attempt to weave everything that it finds.&nbsp; This is probably not optimal in most use cases, but any changes is a simple modification to the LINQ query in the code.&nbsp; For now, it’s only available in source format since there are bound to be bugs here and there, and once those get ironed out it’ll be easier to release a “point something” release.</p> <p>An example of how its used can be seen in the unit tests, in the project DependencyPropertyWeaver.Tests.Models.&nbsp; If you open it up in your favorite text editor, you will see this crucial line:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&lt;</span><span style="color: #800000">Target</span> <span style="color: #ff0000">Name</span>=<span style="color: #0000ff">"AfterBuild"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">Exec</span> <span style="color: #ff0000">Command</span>=<span style="color: #0000ff">"C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe postbuild.proj /p:Files=DependencyPropertyWeaver.Tests.Models.dll"</span> <span style="color: #ff0000">WorkingDirectory</span>=<span style="color: #0000ff">"$(OutputPath)"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Target</span><span style="color: #0000ff">&gt;</span></pre></pre>
<p>And the contents of <em>postbuild.proj</em> is simply this:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&lt;?</span>xml version="1.0" encoding="utf-8"<span style="color: #0000ff">?&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&lt;</span><span style="color: #800000">Project</span> <span style="color: #ff0000">ToolsVersion</span>=<span style="color: #0000ff">"4.0"</span> <span style="color: #ff0000">DefaultTargets</span>=<span style="color: #0000ff">"Weave"</span> <span style="color: #ff0000">xmlns</span>=<span style="color: #0000ff">"http://schemas.microsoft.com/developer/msbuild/2003"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">UsingTask</span> <span style="color: #ff0000">TaskName</span>=<span style="color: #0000ff">"DependencyPropertyWeaver.DependencyPropertyWeaverTask"</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">             <span style="color: #ff0000">AssemblyFile</span>=<span style="color: #0000ff">"DependencyPropertyWeaver.dll"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">Target</span> <span style="color: #ff0000">Name</span>=<span style="color: #0000ff">"Weave"</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">ItemGroup</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">Input</span> <span style="color: #ff0000">Include</span>=<span style="color: #0000ff">"$(Files)"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">ItemGroup</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">DependencyPropertyWeaverTask</span> <span style="color: #ff0000">Files</span>=<span style="color: #0000ff">"@(Input)"</span> <span style="color: #0000ff">/&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">Target</span><span style="color: #0000ff">&gt;</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">Project</span><span style="color: #0000ff">&gt;</span></pre></pre>
<p>The <em>AfterBuild</em> target is a special target with MSBuild, which, as the name implies, will run after the target has been built.&nbsp; In this case, after the project is completed, it will invoke another MSBuild instance to perform the weaving.&nbsp; Invoking a new MSBuild process is required because the &lt;UsingTask&gt; will load the assembly into the current AppDomain, and once loaded it cannot be unloaded.</p>
<p>If you don’t mind the unloading part, you can simply add the &lt;UsingTask&gt; directly into the project file and invoked the &lt;DependencyPropertyWeaverTask&gt; there, and avoid the hassle of having a separate file.</p>
<p>Currently, the DependencyPropertyWeaverTask supports the <em>TypePatternMatch</em> and <em>AttributePatternMatch</em>, which as the names imply will use regular expression filtering on type names or properties with the attribute you want to weave.&nbsp; If these properties are null, they are ignored.</p>
<p>Next on the feature list is weaving attached properties ;-)</p>  </div>
