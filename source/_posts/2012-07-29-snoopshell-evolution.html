---
layout: post
title: "SnoopShell: Evolution"
date: 2012-07-29
comments: false
categories:
 - Coding
 - Software Tools
---

<div class='post'>
<p>It’s been a while since I last announced <a href="http://blingcode.blogspot.com/2012/07/snoopshell-marriage-of-snoop-wpf-and.html">SnoopShell</a>, where I took some PowerShell and injected that into Snoop.&nbsp; Well, I didn’t stop there!&nbsp; I decided to continue working on it and adding more useful features.</p> <p>Well, a bunch of things have changed.&nbsp; For one, it’s no longer targeted at .NET 4 and PS v3 anymore (and you’ll soon know why).&nbsp; Second, there’s a bunch of new features!</p> <h2>Automatic Profile Loading</h2> <p>Upon startup, the shell will look for a couple well known locations and automatically dot-source them to load them into the current session.&nbsp; This works the same as the standard $profile.&nbsp; The filename needs to be <em>SnoopProfile.ps1</em>, and the search paths are %USERPROFILE%, the <em>WindowsPowerShell</em>, and the <em>Scripts</em> folder deployed with Snoop.exe.</p> <p>This is incredibly useful since you can write your own custom functions and scripts and have them available to you all the time.&nbsp; As an added bonus, because of the dynamic nature of PowerShell, you can make modifications to the <em>SnoopProfile.ps1,</em> save, and then invoke a “. $profile” to reload the profile and update the session with your changes (all without restarting the application).</p> <p>That’s awesome sauce indeed ;-)</p> <h2>PowerShell Provider</h2> <p>This was more of a for-fun thing at first just to see if I could do it.&nbsp; Writing a PS provider is not fun at all, since it’s not very well documented and I actually needed some help from ILSpy to figure out how things really worked.&nbsp; Nonetheless, it’s got some basic functionality that is helpful to navigate around.</p> <p><a href="http://lh6.ggpht.com/-hpRCncySB3g/UBXOagD2xII/AAAAAAAAALs/qBCKmxV-B0M/s1600-h/image%25255B10%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/-QMqNxt2DmZ8/UBXOa1SVqwI/AAAAAAAAAL0/ULMweSOFso0/image_thumb%25255B8%25255D.png?imgmax=800" width="654" height="399"></a></p> <p>Yep, the selected grid actually has a path, like how you would navigate the file system.&nbsp; Let’s see what happens with a <em>cd</em>.</p> <p><a href="http://lh4.ggpht.com/-R3wQmpiA7dw/UBXObb7FNsI/AAAAAAAAAL8/z3mgZwnFLok/s1600-h/image%25255B15%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh3.ggpht.com/-mdRas9rg4gs/UBXOb4W6z7I/AAAAAAAAAME/pNH-1jzMbGA/image_thumb%25255B11%25255D.png?imgmax=800" width="654" height="399"></a></p> <p>Cool, you can <em>cd</em> into the child “directory”, and it’ll automatically select the item in the tree view as well.&nbsp; What if you’re lazy and don’t want to type?</p> <p><a href="http://lh3.ggpht.com/-QgZ0iBA1AKw/UBXOcPU9uDI/AAAAAAAAAMM/iy9qHsS0zHA/s1600-h/image%25255B20%25255D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh5.ggpht.com/-YV-f5-aPnP0/UBXOcRFGPkI/AAAAAAAAAMU/oo85Qg9fohU/image_thumb%25255B14%25255D.png?imgmax=800" width="654" height="399"></a></p> <p>Wildcards are supported.&nbsp; And because the visual tree doesn’t exactly require unique names, I needed to trick it by adding a number after each duplicate item.&nbsp; So the above matches the third Rectangle child of the Grid.</p> <h2>Code Injection</h2> <p>One of the cool things about Javascript is that it’s so darn easy to test.&nbsp; You make a change, save, reload, and you’ll immediately see if something worked or not.&nbsp; This feedback loop is so fast it changes how you work and formulate ideas.</p> <p>In the static world, we don’t really have this luxury, and especially not when you’re working on a large project, which at work, takes just under a minute for a full rebuild.&nbsp; And this is on a monster machine.&nbsp; Because of this, we had to employ tricks and workarounds to speed things up, like messing with build configurations and build output paths to minimize duplicate work.&nbsp; Despite that, it’s still a pain to wait for the application to start and all that jazz.</p> <p>What if we could do the super fast feedback loop development, in a static world?&nbsp; Well, now you can!</p> <p>It starts with a simple function:</p> <div id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; background-color: #f4f4f4; margin: 0em; border-left-style: none; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; border-right-style: none; font-size: 8pt; overflow: visible; padding-top: 0px" id="codeSnippet">function replace-command([<span style="color: #0000ff">string</span>]$msg = <span style="color: #006080">'hello world'</span>) {<br>    $action = { [system.windows.messagebox]::show($msg) }.GetNewClosure()<br>    $cmd = <span style="color: #0000ff">new</span>-<span style="color: #0000ff">object</span> galasoft.mvvmlight.command.relaycommand([system.action]$action)<br>    $selected.target.command = $cmd<br>}<br></pre><br></div>
<p>The above function will replace anything that has a <em>Command</em> property on the target, like a Button or MenuItem, with a MessageBox showing a message.&nbsp; For the curious, <em>GetNewClosure</em> is needed so that $msg is available within the inner script block.&nbsp; Unlike C#, closures are not automatic.</p>
<p>Since PowerShell is dynamic, if you need to make a change, simply save the script, reload it with a dot-source, which will overwrite the existing function, and then set the target’s <em>Command</em> property again.&nbsp; Awesome!</p>
<p>The only annoyance is converting PowerShell code back into C# code once you’re done.</p>
<h2>Evolution</h2>
<p>If you made it this far you didn’t forget about my comment about untargeting .NET 4 and PS v3.&nbsp; Well, changes have been <a href="https://github.com/cplotts/snoopwpf/commit/16030418b14778029d10e198b288b4efa9bad65c">merged into the main branch</a>!&nbsp; Soon the masses will be able to experiment with supercharging their applications with PowerShell!</p>
<p>I’ll likely continue working on my <a href="https://github.com/bling/snoopwpf">fork</a> as there’s still more goodies I’d like to add.&nbsp; Stay tuned!</p>  </div>
