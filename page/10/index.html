<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>bling on software</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.16-DEV" />
    <link href="http://bling.github.io/index.xml" rel="alternate" type="application/rss+xml" title="bling on software" />
    <link href="http://bling.github.io/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://bling.github.io/css/hc.css" rel="stylesheet">
    <link href="http://bling.github.io/css/custom.css" rel="stylesheet">
    <link href="http://bling.github.io/css/highlight.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    
    
  </head>
  <body>
    <div id = "wrapper">

      <div class="navbar navbar-default" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a href="http://bling.github.io/"><p class="navbar-brand">bling on software</p></a>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              
              
            </ul>
          </div>
        </div>
      </div>



      
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <a href="http://bling.github.io/">
              <h1 class="brand">bling on software</h1>
            </a>
            <a href="/about">
              <img src="https://pbs.twimg.com/profile_images/1188386482/Untitled_bigger.png" />
            </a>
            <h3>when pragmatism meets minimalism</h3>
          </li>

          <hr />

          <div id="social-wrapper">
            <li> <a href="https://github.com/bling"><i class="fa fa-github-square"></i> github</a> </li>
            <li> <a href="https://twitter.com/blingcoder"><i class="fa fa-twitter-square"></i> @twitter</a></li>
            <li> <a href="https://linkedin.com/in/baileyling"><i class="fa fa-linkedin-square"></i> linkedin</a> </li>
          </div>

          <hr />

          <li class="sidebar-categories">
            <div>
              <span>Categories</span>
              <a href="/post" style="float:right">show all</a>
            </div>
            <div>
              
              <a href="/categories/blend">blend</a>
              
              <a href="/categories/castle">castle</a>
              
              <a href="/categories/castle-coding">castle-coding</a>
              
              <a href="/categories/coding">coding</a>
              
              <a href="/categories/cqrs">cqrs</a>
              
              <a href="/categories/emacs">emacs</a>
              
              <a href="/categories/forex">forex</a>
              
              <a href="/categories/ioc">ioc</a>
              
              <a href="/categories/javascript">javascript</a>
              
              <a href="/categories/logging">logging</a>
              
              <a href="/categories/powershell">powershell</a>
              
              <a href="/categories/rx">rx</a>
              
              <a href="/categories/software-tools">software-tools</a>
              
              <a href="/categories/source-control-management">source-control-management</a>
              
              <a href="/categories/testing">testing</a>
              
              <a href="/categories/twitter">twitter</a>
              
              <a href="/categories/vim">vim</a>
              
              <a href="/categories/visual-studio">visual-studio</a>
              
            </div>
          </li>
        </ul>
      </div>



      <div class="container">





<div class="article">
  <div class="article-title">
    <a href="http://bling.github.io/blog/2010/05/14/contextual-lifestyle-with-castle/">Contextual Lifestyle with Castle Windsor</a>
  </div>
  <p class="meta"><small><i class="fa fa-calendar-o"></i> 2010-05-14</small></p> <hr/>
  <div class="post">
    EDIT:&nbsp;As of version 3, scoped lifestyles are now a first class citizen supported out of the box (http://docs.castleproject.org/Windsor.Whats-New-In-Windsor-3.ashx) EDIT: A much better implementation can be found at https://github.com/castleprojectcontrib/Castle.Windsor.Lifestyles IMO, one of the big missing features of Castle Windsor is that it doesn’t come with a built-in way for dealing with contextual lifestyles.&nbsp; It handles transients and singletons fairly well, but once you get to other lifestyles it’s pretty heavily dependent on having some “state manager” handling the instances.&nbsp; For example, PerWebRequest uses the HttpContext, PerThread uses thread static variables, etc. Contextual lifestyles is one of those things where it doesn’t seem all that useful at first, and then when you see the possibilities it’s like getting hit with a huge truck. A question was posted to the Castle Google Group recently, which I follow, which illustrates a relatively common example of why someone would want to have a contextual lifestyle.&nbsp; Basically, you have a whole bunch of components you want to resolve, but only within a context. Here’s some boiler plate code of the domain model: public interface IRepository { ISession Session { get; } } public interface ISession : IDisposable { bool IsDisposed { get; } } public class Session : ISession { public bool IsDisposed { get; set; } public void Dispose() { IsDisposed = true; } } public class Repository1 :IRepository { public ISession Session { get; private set; } public Repository1(ISession session){ Session = session; } } public class Repository2 : IRepository { public ISession Session { get; private set; } public Repository2(ISession session){ Session = session; } } public class Model1 { public IRepository First { get; private set; } public IRepository Second { get; private set; } public Model1(IRepository first, IRepository second) { First = first; Second = second; } } public class Model2 { public IRepository Second { get; private set; } public Model2(IRepository second) { Second = second; } } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } And here’s the unit test I want to pass: [Test] public void ResolutionsByContext() { IWindsorContainer root = new WindsorContainer(); root.Register(Component.For&lt;Model1&gt;().LifeStyle.Transient, Component.For&lt;Model2&gt;().LifeStyle.Transient, Component.For&lt;IRepository&gt;().ImplementedBy&lt;Repository1&gt;().LifeStyle.Transient, Component.For&lt;IRepository&gt;().ImplementedBy&lt;Repository2&gt;().LifeStyle.Transient, Component.For&lt;ISession&gt;().ImplementedBy&lt;Session&gt;().LifeStyle.PerContextScope()); Model1 model1; Model2 model2; ISession session1, session2; using (var context1 = root.BeginLifetimeScope()) { model1 = context1.Resolve&lt;Model1&gt;(); session1 = model1.First.Session; Assert.AreSame(model1.First.Session, model1.Second.Session); Assert.AreSame(context1.Resolve&lt;ISession&gt;(), context1.Resolve&lt;ISession&gt;()); using (var context2 = root.BeginLifetimeScope()) { model2 = context2.Resolve&lt;Model2&gt;(); session2 = model2.Second.Session; Assert.AreNotSame(model1.First.Session, model2.Second.Session); var anotherModel2 = context2.Resolve&lt;Model2&gt;(); Assert.AreSame(anotherModel2.Second.Session, model2.Second.Session); Assert.AreSame(session2, context2.Resolve&lt;ISession&gt;()); Assert.AreNotSame(context1.Resolve&lt;ISession&gt;(), context2.Resolve&lt;ISession&gt;()); } Assert.IsTrue(session2.IsDisposed); Assert.IsFalse(session1.IsDisposed); } Assert.IsTrue(session1.IsDisposed); } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } I copied the name BeginLifetimeScope from Autofac, which inherently supports contextual scopes as a first-class citizen (of which the test passes).&nbsp; The question now, is how do we get Castle Windsor to do the same? Initially, I took a look at ISubDependencyResolver and caching variables.&nbsp; Unfortunately, this didn’t work too well because sub resolvers never got hit if they were resolved from the container directly. The next step I tried was with lifestyle managers, but alas, the CreationContext was always transient and I was unable to store any state that distinguished between different context resolutions. After digging deeper into the Windsor codebase and getting into the subsystems and handlers, I found a solution that seems to work.&nbsp; It passes the test above, but that’s about it.&nbsp; Test well if you’re gonna use this in production code!!! Here goes! First, you have a lifestyle manager to distinguish between other lifestyles. public class ContextualLifestyleManager : AbstractLifestyleManager { private object instance; public override object Resolve(CreationContext context) { return instance ?? (instance = base.Resolve(context)); } public override void Dispose() { } }And finally, the magic happens with this: public static class ContextualExtensions { public static ComponentRegistration&lt;T&gt; PerContextScope&lt;T&gt;(this LifestyleGroup&lt;T&gt; group) { return group.Custom&lt;ContextualLifestyleManager&gt;(); } public static IWindsorContainer BeginLifetimeScope(this IWindsorContainer parent) { var child = new WindsorContainer(); var ss = (INamingSubSystem)parent.Kernel.GetSubSystem(SubSystemConstants.NamingKey); foreach (var handler in ss.GetHandlers()) { if (handler.ComponentModel.CustomLifestyle == typeof(ContextualLifestyleManager)) { child.Kernel.AddCustomComponent(handler.ComponentModel); } } parent.AddChildContainer(child); return child; } }First method is just a helper method to be a little more fluent in the registration for when you want many things to have contextual lifestyle.&nbsp; The second method is the guts.&nbsp; Long story short, we create a child container, and duplicate all component models of contextual lifestyle.&nbsp; Thus, whenever components are resolved, the “override” is found in the child and resolved.&nbsp; Anything else will be found in the parent. I was initially pretty happy with this, until I profiled the performance.&nbsp; With Autofac, creating and disposing 100,000 contexts took 5ms on my computer.&nbsp; Doing the same with with Windsor took 3.8 seconds.&nbsp; Out of curiosity, I profiled again, but this time just creating child containers without copying handlers down: 1.9 seconds.&nbsp; So while this implementation works, it’s not as performant as I’d like it to be…. Maybe I’ll come up with another solution, but for now if the performance is acceptable maybe this would be useful for others! Comments bling LOL I need to check these comments more often. Thanks for responding! Krzysztof Koźmic (2) That&#39;s my quick and dirty impl based on per-web-request lifestyle that is far more lightweight and should have similar perf characteristics to other lifestyles http://gist.github.com/400979 http://gist.github.com/400980 Krzysztof Koźmic (2) No wonder it is taking so long, you&#39;re doing it in very heavyweight fashion. It can be done w/o nested containers, much more lightweight.

    
  </div>
</div>

<div class="article">
  <div class="article-title">
    <a href="http://bling.github.io/blog/2010/04/21/forcing-castle-windsor-to-generate/">Forcing Castle Windsor to Generate Class Proxies</a>
  </div>
  <p class="meta"><small><i class="fa fa-calendar-o"></i> 2010-04-21</small></p> <hr/>
  <div class="post">
    I don't know why it took me so long to come up with this idea, but to save others potential headaches...have you ever thought "hmmmm, I registered this as an interface with an implementation, but I want Windsor to use a class proxy, not an interface proxy, how do I do that?" For me, initially I almost went as far as implementing my own ProxyFactory to force it to use class proxy no matter what, and then the light bulb hit me and it turns out that there's a much easier way to accomplish this. c.Register(Component.For&lt;ConcreteImpl, IService&gt;().Interceptors&lt;AnInterceptor&gt;()); Tada!&nbsp; The actual service is now a concrete type, so Windsor will go, OK, I need to create a class proxy.&nbsp; But since it's forwarded to the interface as well, all your dependencies can simply use the interface and everything magically works. Yay! Comments bling void IService.SomeLongRunningOperation() { Action1(); Action2(); Action3(); } protected virtual void Action1() {} protected virtual void Action2() {} protected virtual void Action3() {} Without class proxies, those action methods could not be intercepted, and in our case, we would not be able to collect metrics/statistics on those methods. Krzysztof Koźmic (2) Why did you want a class proxy for interface service?

    
  </div>
</div>

<div class="article">
  <div class="article-title">
    <a href="http://bling.github.io/blog/2010/04/05/how-to-advocate-test-driven-development/">How to Advocate Test Driven Development (TDD)</a>
  </div>
  <p class="meta"><small><i class="fa fa-calendar-o"></i> 2010-04-05</small></p> <hr/>
  <div class="post">
    It seems that everywhere you read you will find blog posts asserting that it is difficult to convince others to use TDD, and that everyone talking about TDD is already a believer preaching to other believers.&nbsp; So what's the best way convince others? I recently convinced a good buddy of me to starting doing TDD in his web development.&nbsp; It took a while, but finally he "saw the light."&nbsp; He tried to relay the information to his coworker, and his coworker didn't react as positively, citing the common "I don't want to waste time writing test code when I know my stuff works." There are many many MANY hurdles of overcome to begin writing software using TDD.&nbsp; I won't go into great detail since you can easily find relevant posts on the web, but basically, if you have successfully transitioned to TDD that also implies that you have in one way or another adopted&nbsp;S.O.L.I.D. principles in software design. The reason I say this is because it is literally impossible to do TDD otherwise.&nbsp; It is just plain painful.&nbsp; I've been there.&nbsp; It is so painful you shout in your head WTF are people thinking, how does this make my job easier?! Usually when this happens, you'll probably notice that most (or all) of the SOLID principles have been violated one way or another. &lt;sarcasm&gt; Single Responsibility Principle You mean 1 class to rule them all right? Open Closed Principle Does this have something to do with sockets? Liskov Substitution Principle I thought the point of Object Oriented Programming is that everything is an object! Interface Segregation Principle What's an interface? Dependency Inversion Principle I don't get it...I only have 1 super object anyway, I don't have dependencies. &lt;/sarcasm&gt; Notice that even though this post was supposed to be about how to advocate TDD, I ended up talking about SOLID instead for a bit.&nbsp; What am I trying to get at? TDD spans from the individual to the team to the organization.&nbsp; You need to be able to tackle it from all points of view.&nbsp; The obsession of the word 'test' has hurt TDD quite a bit.&nbsp; Anyone who's spent any reasonable amount of time will assert that tests are just a means to drive the design.&nbsp; Tests should read like a story (well to programmer eyes), and yes, I said read, as in readable! At the individual level, you must convince them it forces you to design better code, because testing against badly designed code is not worth the pain/annoyance.&nbsp; You must assert that better designed code is good because it also means being more maintainable and less bugs. At the team level, you must convince that collective code ownership is a good thing.&nbsp; There should never be a situation where "Bob's on vacation, we'll need to put a hold on Project A because only he knows it".&nbsp; Tests serve as a way on how to interact with a specific service, and are a jump-start to figuring out how to actually use a particular service.&nbsp; Moreover, collective code ownership is a means of sharing and distributing knowledge. At the organizational level, you must convince managers that you are a professional software developer, and that it is your job to produce high quality work.&nbsp; And if what is required to produce high quality work involves writing proper unit tests, following SOLID principles, and even other agile practices like pair programming, then you should be allowed (and optimally encouraged) to do so.&nbsp; Now TDD might not work for everyone, or every organization, but I think everyone owes it to themselves to give it a fair chance.

    
  </div>
</div>

<div class="article">
  <div class="article-title">
    <a href="http://bling.github.io/blog/2010/04/05/windsordynamicproxymixin-powers/">Windsor/DynamicProxy/Mixin Powers!</a>
  </div>
  <p class="meta"><small><i class="fa fa-calendar-o"></i> 2010-04-05</small></p> <hr/>
  <div class="post">
    Hmmm, I couldn’t really think of a good title except that this blog post has a little bit of everything of the title. As with any multithreaded program, deadlocks are a huge pain in the butt, and when they happen it costs time, money, and stress. In my code base I’ve introduced something called an ExtendedLock, which basically has something like this inside: 1: public class ExtendedLock : IExtendedLock { 2: public IDisposable Lock() { 3: while (!Monitor.TryEnter(this, 5000)) { 4: IncrementLockTime(); 5: } 6: return new Disposer(() =&gt; Release()); 7: } 8: public event Deadlock;9: } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } Pretty simple.&nbsp; IncrementLockTime, as the name implies keeps track of how long the current thread has been attempting to acquire the lock.&nbsp; It returns a Disposer which takes an Action, which releases the lock.&nbsp; This allows us to take advantage of the using syntax, and avoid boiler plate try/finally (oh, and it avoids typos in Monitor.Exit).&nbsp; After some configurable amount of time, if the lock cannot be acquired within, say, 2 minutes, it’s probably a good probability your application is blocked somewhere. Now, using this class basically means replacing lock(_syncRoot) type code with _elock.Lock().&nbsp; Also, I believe it’s a good candidate for “mixing” into any other component.&nbsp; Mixins are sort of like multiple-inheritance, but not.&nbsp; I like to think of mixins as a “can do” rather than “is a.” Now, we know that C# doesn’t let you do multiple inheritance, but with libraries like Castle’s DynamicProxy2, it lets you do something very similar, and is extremely powerful.&nbsp; In a sense, it will automatically generate the following code for you: 1: public class SomeService : ISomeService, IExtendedLock { 2: IExtendedLock _lock = new ExtendedLock(); 3: public void DoSomething() { } 4: IDisposable IExtendedLock.Lock() { return _lock.Lock(); } 5: } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } _lock is a private instance variable, SomeService implements IExtendedLock, and simply redirects all the interface methods to _lock.&nbsp; This seems pretty simple and straightforward, but becomes tedious when the type you want to mix in has many methods (as my actual IExtendedLock is). With Windsor/DynamicProxy, you can do this automatically with minimal amount of code.&nbsp; For example, first you define something like this: public interface ILockableDictionary : IDictionary, IExtendedLock { } Then, you register it in the container: 1: var container = new WindsorContainer(); 2: container.Register(Component.For(typeof(ILockableHashtable)) 3: .LifeStyle.Transient 4: .Activator&lt;LockableHashtableActivator&gt;()); .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } Now, whenever you need an instance of a lockable hashtable you can simply do something like this: var hash = container.Resolve&lt;ILockableHashtable&gt;(); using (hash.Lock()) { hash["1"] = 1; } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } You might be wondering why it’s worth all this trouble, and what’s wrong with regular locks and Monitor.&nbsp; For our system it’s pretty critical that it stays running 24/7, and every minute it’s down is money lost, so it is in our best interest to detect any problematic condition. Last but not least, here’s the important code that actually generates the proxy: 1: internal class LockableHashtableActivator : DefaultComponentActivator 2: { 3: public LockableHashtableActivator(ComponentModel model, IKernel kernel, ComponentInstanceDelegate onCreation, ComponentInstanceDelegate onDestruction) 4: : base(model, kernel, onCreation, onDestruction) 5: { 6: } 7: &nbsp; 8: public override object Create(CreationContext context) 9: { 10: IExtendedLock lockMixin = Kernel.Resolve&lt;IExtendedLock&gt;(); 11: &nbsp; 12: // an additional object we want to "mix" with the implementation to provide combined functionality 13: ProxyGenerationOptions options = new ProxyGenerationOptions(); 14: options.AddMixinInstance(lockMixin); 15: 16: return Kernel.Resolve&lt;ProxyGenerator&gt;().CreateInterfaceProxyWithTarget( 17: typeof(IDictionary), // the interface of the implementation 18: new[] { typeof(ILockableHashtable) }, // additional interfaces to use 19: Activator.CreateInstance&lt;Hashtable&gt;(), // concrete implementation to mix into 20: options); 21: } 22: } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } .csharpcode, .csharpcode pre { font-size: small; color: black; font-family: consolas, "Courier New", courier, monospace; background-color: #ffffff; /*white-space: pre;*/ } .csharpcode pre { margin: 0em; } .csharpcode .rem { color: #008000; } .csharpcode .kwrd { color: #0000ff; } .csharpcode .str { color: #006080; } .csharpcode .op { color: #0000c0; } .csharpcode .preproc { color: #cc6633; } .csharpcode .asp { background-color: #ffff00; } .csharpcode .html { color: #800000; } .csharpcode .attr { color: #ff0000; } .csharpcode .alt { background-color: #f4f4f4; width: 100%; margin: 0em; } .csharpcode .lnum { color: #606060; } For those who are familiar with Windsor and wondering why I didn’t use the fluent Proxy.Mixins method, it’s because those mixins are created once per registration.&nbsp; In this case, it is very important that each mixin (which is an extended lock), is transient, otherwise every lockable hashtable ends up with the same extended lock, which is just asking for trouble. Comments Krzysztof Koźmic actually, with the trunk version the limitation &quot;one mixin per registration&quot; was lifted off. Now Mixins behave pretty much like interceptors, which means they can have any lifestyle, including being transient.

    
  </div>
</div>

<div class="article">
  <div class="article-title">
    <a href="http://bling.github.io/blog/2009/11/23/real-world-performance-comparison/">Real World Performance Comparison: Enterprise Library Logging Block vs log4net</a>
  </div>
  <p class="meta"><small><i class="fa fa-calendar-o"></i> 2009-11-23</small></p> <hr/>
  <div class="post">
    Any search on the web you find will consistently show log4net outperforming EL by a factor of around 4:1.&nbsp; Most of these tests are typically tight for/loops, and comments will end up saying things like “oh well that’s not a realistic test” or “well you shouldn’t be logging that much anyway”, etc etc.&nbsp; Well, let’s see how important choosing your logging infrastructure is in terms of overall system performance in a multithreaded application. One of my recent tasks was hunting down a memory leak.&nbsp; So I downloaded the trial of the ANTS .NET Bundle which contains a memory profiler and performance profiler.&nbsp; Hunting the memory leak was a pain since I wasn’t the one who wrote the code, so it took a while for me to realize which objects were “leaked.”&nbsp; I eventually found it, and then I turned my attention to using the performance profiler to see if any obvious places could be optimized. At this point I decided to swap in the Enterprise Logging Block to see how it would fair.&nbsp; The logging migration project was still in progress, and we haven’t made the full switch yet, but I figured I should try out it anyway because I’m the curious type. The software already uses the Trace diagnostics extensively.&nbsp; Practically every message, error, you name it, will get Trace.WriteLined…and then a LogFileWriter will pick it up, and dump it to a file.&nbsp; In my testing, I simply added an extra line of code here, namely Logger.Write(LogEntry).&nbsp; Thus, anything that used to get logged, will also get logged by the EL. Then, it was basically running the application to a similar set of scenarios, and then seeing what the profiler says.&nbsp; Obviously each run will not be exactly the same as the previous, but overall I think if we look at percentages we can begin to see where the CPU is taking the most time. Here is what the application does without any modifications. Here is the application after adding Logger.Write(LogEntry). Yeah, I was pretty surprised too.&nbsp; That one method ended up being the most expensive method in the entire application. A quick look at the source revealed quite a bit of code dedicated to thread safety.&nbsp; So digging deeper, I decided to avoid the static Logger.Write method altogether, create instance LogWriters directly, and have them all go to a singleton FileTraceListener. That’s a noticeable improvement…it’s not #1 anymore.&nbsp; The CPU time also dropped from ~15% to ~10%.&nbsp; That means that ~5% of CPU time was in the static Logger.Write(LogEntry) method.&nbsp; If you look at the graphs you’ll notice a common pattern among them, because I wanted to test with the same scenario to get as close to as measurable results as possible…but to illustrate how bad the EL’s performance can get, here’s one: I literally fell off my chair when I first discovered this as I didn’t think it could be possible something that’s supposed to be non-invasive could end up taking this much CPU.&nbsp; This is one of the earlier tests I did where&nbsp; I didn't have a set scenario yet. And of course, here are the results with log4net. So what does that leave us? log4net:&nbsp; 5% EL static:&nbsp; 15% EL instance:&nbsp; 10% So what should you get out of this?&nbsp; Be very careful of how you invoke Logger.Write()…it may not be as cheap as you think it is.&nbsp; Even log4net took much more CPU time than I expected. I redid the test using Castle’s logging framework, which is a barebones dump messages to a file.&nbsp; The total CPU time for this was 0.016%.&nbsp; Yep!&nbsp; I had to scroll down to even find it! I guess this shows that even log4net, which is touted for high-performance, comes at a cost.

    
  </div>
</div>



    
    <ul class="pagination">
        
        <li>
            <a href="/" aria-label="First"><span aria-hidden="true">&laquo;&laquo;</span></a>
        </li>
        
        <li
        >
        <a href="/page/9/" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
        </li>
        
        <li
        ><a href="/">1</a></li>
        
        <li
        ><a href="/page/2/">2</a></li>
        
        <li
        ><a href="/page/3/">3</a></li>
        
        <li
        ><a href="/page/4/">4</a></li>
        
        <li
        ><a href="/page/5/">5</a></li>
        
        <li
        ><a href="/page/6/">6</a></li>
        
        <li
        ><a href="/page/7/">7</a></li>
        
        <li
        ><a href="/page/8/">8</a></li>
        
        <li
        ><a href="/page/9/">9</a></li>
        
        <li
        class="active"><a href="/page/10/">10</a></li>
        
        <li
        ><a href="/page/11/">11</a></li>
        
        <li
        ><a href="/page/12/">12</a></li>
        
        <li
        ><a href="/page/13/">13</a></li>
        
        <li
        ><a href="/page/14/">14</a></li>
        
        <li
        ><a href="/page/15/">15</a></li>
        
        <li
        ><a href="/page/16/">16</a></li>
        
        <li
        ><a href="/page/17/">17</a></li>
        
        <li
        >
        <a href="/page/11/" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
        </li>
        
        <li>
            <a href="/page/17/" aria-label="Last"><span aria-hidden="true">&raquo;&raquo;</span></a>
        </li>
        
    </ul>
    

    </div>

    <footer>
      <p class="text-muted credit">&copy; bling on software 2015. All rights reserved. </p>
    </footer>

    <script src="http://bling.github.io/js/jquery-1.10.2.min.js"></script>
    <script src="http://bling.github.io/js/bootstrap.min.js"></script>
    <script src="http://bling.github.io/js/bootstrap.js"></script>
    <script type="text/javascript" src="http://bling.github.io/js/hc.js"></script>

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38439430-2', 'auto');
ga('send', 'pageview');
</script>

  </body>
</html>

