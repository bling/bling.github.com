
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="I need to show some love and support for my favorite IoC tool because it’s most powerful feature needs more explaining.&nbsp; It’s not that the main &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io//blog/page/11">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/26/autofacs-extremely-powerful-containerscope/">Autofac’s Extremely Powerful and Flexible ContainerScope</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-26T00:00:00+00:00" pubdate data-updated="true">Sep 26<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
I need to show some love and support for my favorite IoC tool because it’s most powerful feature needs more explaining.&nbsp; It’s not that the main site doesn’t provide a good explanation, because it does, but because most people don’t really understand what the solution is solving.<br />
The following is on Autofac’s <a href="http://code.google.com/p/autofac/">front page</a>:<br />
<blockquote><pre class="csharpcode">var container = // ...
using (var inner = container.CreateInnerContainer())
{
  var controller = inner.Resolve&lt;IController&gt;();
  controller.Execute(); // use controller..
}</pre></blockquote>The first time I saw this I basically glanced right passed it.&nbsp; Honestly I didn’t think anything of it, and initially the reason I tried out Autofac was for its very slick lambda registrations.&nbsp; I didn’t realize I was in a world of surprises when I finally realized the power and flexibility of Autofac’s container scope.<br />
<br />
If <a href="http://www.codinginstinct.com/2008/05/ioc-container-benchmark-rerevisted.html">benchmarks</a> and <a href="http://blog.ashmind.com/index.php/2008/09/08/comparing-net-di-ioc-frameworks-part-2/">feature comparisons</a> are not enough show off Autofac’s features, this blog post hopes to show how to solve “complex” problems elegantly.<br />
<br />
Let’s start with the typical NHibernate use-case.&nbsp; Create 1 singleton, create many sessions-per-request.&nbsp; Here’s a solution with <a href="http://nhforge.org/blogs/nhibernate/archive/2009/08/29/part-7-nhibernate-and-ninject-for-asp-net-mvc.aspx">Ninject</a> (not that I’m picking on Ninject, because I love its very slick contextual binding, but because most other IoC containers have a similar solution, like <a href="http://ayende.com/Blog/archive/2007/06/14/Using-NHibernate-Session-Per-Request-with-WCF-Windsor-Integration.aspx">per-session with WCF &amp; Windsor</a>).<br />
<br />
Basically, the solutions mentioned above will following an approach like this: <br />
<br />
a) Hook into the beginning of a request, and create the ISession from the ISessionFactory. <br />
b) Set it in the HttpContext.Current or OperationContext.Current’s dictionaries. <br />
c) Get this property in all the dependencies that need it. <br />
d) At the end of the request, Dispose() the ISession.<br />
<br />
OK, pretty simple and straightforward solution, but there’s one key thing that really bugs me is that by doing this we have introduced a dependency…that is, HttpContext.Current[].&nbsp; That, or you could wrap that around a class, like SessionManager, again, basically coupling to a dependency under a different name.&nbsp; With Autofac, we can bypass steps b and c entirely and only worry about the beginning and end of a request.<br />
<br />
To start off, here&#8217;s the basic wiring needed:<br />
<div style="text-align: left;"><blockquote><div class="csharpcode"><pre class="alt">1:   var cb = new ContainerBuilder(); 
2:   cb.Register(x =&gt; CreateSessionFactory())
       .As&lt;ISessionFactory&gt;()
       .SingletonScoped(); 
3:   cb.Register(x =&gt; x.Resolve&lt;ISessionFactory&gt;().OpenSession())
       .As&lt;ISession&gt;()
       .ContainerScoped(); 
4:   IContainer c = cb.Build(); 
5:  &nbsp;
6:   Assert.AreSame(c.Resolve&lt;ISessionFactory&gt;(), c.Resolve&lt;ISessionFactory&gt;()); 
7:   Assert.AreSame(c.Resolve&lt;ISession&gt;(), c.Resolve&lt;ISession&gt;()); 
8:  &nbsp;
9:   var inner1 = c.CreateInnerContainer(); 
10:  Assert.AreSame(c.Resolve&lt;ISessionFactory&gt;(), inner1.Resolve&lt;ISessionFactory&gt;()); 
11:  Assert.AreNotSame(c.Resolve&lt;ISession&gt;(), inner1.Resolve&lt;ISession&gt;());</pre></div></blockquote></div>That’s the configuration.&nbsp; And that’s it!&nbsp; Nothing more.&nbsp; No additional SessionManager class.&nbsp; No need to use HttpContext.Current to store the session.&nbsp; Just pass ISession in with regular constructor/property injection.<br />
<br />
Here’s how it works:<br />
<br />
Line 2: ISessionFactory is created from CreateSessionFactory().&nbsp; This is a singleton so there will always be one and only one instance of it within the container (and all child containers).<br />
<br />
Line 3: This is where it’s interesting.&nbsp; We’re saying “whenever I need an ISession, resolve ISessionFactory and call OpenSession() on it”.&nbsp; Also, by specifying ContainerScope, we only get 1 instance per-container.<br />
<br />
And this is where it’s sort of confusing with the terminology.&nbsp; You can think of Autofac as a tree of containers.&nbsp; The root container (variable c in this case), can create children containers (inner1 in this case, and inner1 could create an inner2, and so on).&nbsp; So when something is Singleton scoped, that means that the root container, and any child containers (and child’s children) will only have 1 instance of a service.&nbsp; With ContainerScope, each “node = container” in the tree gets 1 instance.<br />
<br />
So back to the unit test above, in line 6 we verify that there is only 1 instance of ISessionFactory.&nbsp; We resolve ISession twice as well, which shows that we get the same instance.<br />
<br />
Line 9, we create an inner container, and here we see that ISessionFactory is the same for both the container <b>c</b> and inner container <b>inner1</b>.&nbsp; However, the ISession resolved is <b>different</b> between the two.<br />
Thus, by specifying ContainerScope, you can very easily group <i>multiple</i> services and dependencies together as one unit.&nbsp; Implementing the Unit of Work pattern is insanely easy with Autofac.&nbsp; Create services A, which depends on B, which depends on C, which all the previous depends on D.&nbsp; Resolve A within a new inner container, and B, C, and D will always be the same instances.&nbsp; Resolve A in another inner container and you will get a new set of instances.<br />
<br />
Last but not least, Autofac will automatically call Dispose() on all resolved services once the container is disposed.&nbsp; So for the above, once <b>inner1</b>.Dispose() is called, ISession.Dispose() is automatically called.&nbsp; If you needed to, you can very easily hook into this mechanism and implement things like transactions and rollbacks.<br />
<br />
I hope this blog post clears things up a little bit about Autofac’s ContainerScope!</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Nick</div>
<div class='content'>
Heya Bailey! Think there is more than one &#39;Nick&#39; lurking around your blog (or else I have a case of amnesia :))<br /><br />Love the article, definitely need more info like this around the &#39;net.<br /><br />Nick (mk II)</div>
</div>
<div class='comment'>
<div class='author'>bling</div>
<div class='content'>
Thanks for dropping by Nick!<br /><br />To answer the question, what I ended up doing was creating a set of services for each request/session, basically like how I described in my post.<br /><br />I also wrote my own custom interception module (took some ideas from the one in contrib) based on Castle&#39;s DynamicProxy2.<br /><br />The main difference was that my interceptors work iff methods have specific attributes, and with that I was able to selectively say which methods got transactions (among other things).<br /><br />This made things really easy because I could have the transaction span multiple methods as one huge call or a simple 1 line method depending on where my transaction attributes appear in the code.</div>
</div>
<div class='comment'>
<div class='author'>Nick</div>
<div class='content'>
I&#39;ve been toying with a similar approach, but I&#39;m uncertain about how to manage NHibernate&#39;s Transaction (Commits and Rollbacks) in this scenario.  I&#39;ve seen examples that make use of TransactionAttributes (in the case of MVC apps), and previously I had been managing transactions in the begin/end request events (in global.asax), but that ties every request to a transaction which isn&#39;t necessary.  How did you go about handling transactions in this scenario?</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/13/getting-code-coverage-working-on/">Getting Code Coverage Working on TeamCity 5 With Something Other Than NUnit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-13T00:00:00+00:00" pubdate data-updated="true">Sep 13<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been experimenting lately with <a href="http://www.jetbrains.net/confluence/display/TW/TeamCity+EAP?eap">TeamCity 5 EAP</a> and so far it&rsquo;s been a pretty awesome experience.  I was up and running within minutes and I was swarmed with beautiful graphs and statistics with specifics even per-test.  Getting something like that up with <a href="http://ccnet.thoughtworks.com/">CC.NET</a> is not a trivial task.</p>

<p>Anywho, with TC5 code coverage is one of the cool new features added for .NET, but unfortunately only <a href="http://nunit.org">NUnit</a> is supported.  Not that that&rsquo;s a bad thing, but some people  prefer to use other testing tools.  Two notable contenders are <a href="http://xunit.codeplex.com">xUnit.net</a> and <a href="http://www.gallio.org">MbUnit</a>.</p>

<p>I like the fact (pun intended) that xUnit.net makes it a point to prevent you from doing bad practices (like <code>[ExpectedException]</code>), and I like how MbUnit is so bleeding edge with useful features (like <code>[Parallelizable]</code> and a vast availability of assertions).</p>

<p>And with that I set up to figure out how to get TC working with Gallio, but the following should work with any test runner.</p>

<p>It certainly was a pain to set up because it took a lot of trial and error but eventually I figured it out.  I analyzed the build logs provided in each build report and noticed something interesting&hellip;specifically:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[13:51:23]: ##teamcity[importData type=’dotNetCoverage’ tool=’ncover’ file=’C:\TeamCity5\buildAgent\temp\buildTmp\tmp1C93.tmp’]</span></code></pre></td></tr></table></div></figure>


<p>and</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageL’ value=’94.85067’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageM’ value=’97.32143’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageC’ value=’98.68421’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsLCovered’ value=’921.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsMCovered’ value=’218.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsCCovered’ value=’75.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsLTotal’ value=’971.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsMTotal’ value=’224.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsCTotal’ value=’76.0’]</span></code></pre></td></tr></table></div></figure>


<p>The first message happens after NCover.Console is done its thing.  After NCoverExplorer is done its thing, the statistics are published.  I set out to mimic this functionality with Gallio, but what&rsquo;s described here should work with any test runner.</p>

<ol>
<li>Disable code coverage in TC.  We&rsquo;re doing it manually instead.</li>
<li>In your build script, run your unit tests with NCover and generate a coverage.xml report.</li>
<li>Run NCoverExplorer on coverage.xml and generate reports ncoverexplorer.xml and index.html.</li>
<li>Create a zip file of index.html and name it coverage.zip.</li>
<li>Configure coverage.zip to be an artifact in your TC configuration (this is to enable the tab).</li>
<li>Parse out ncoverexplorer.xml with XPath and output the statistics.</li>
</ol>


<p>Certainly a lot of things to do just for the sake of pretty statistics reporting&hellip;.but it was the weekend and I was bored.  With the help of <a href="http://msbuildtasks.tigris.org/">MSBuildCommunityTasks</a>, the zip file and XML parsing was made a lot easier.</p>

<p>After that, viola!  Code coverage + Gallio on TeamCity 5!!!</p>

<p>Unfortunately, NCoverExplorer&rsquo;s report only reports the # total of classes and nothing about unvisited or covered, so for those values I set to 0/0/0 (BTW, you need all values present for the statistics to show).  A task for next weekend!!!</p>

<p>(Edit: I suppose I could should also mention that you could technically avoid all the trouble above and hack it with this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#if NUNIT
</span><span class='line'>
</span><span class='line'>using TestFixtureAttribute = NUnit.Framework.TestFixtureAttribute;
</span><span class='line'>
</span><span class='line'>using TestAttribute = NUnit.Framework.TestAttribute;
</span><span class='line'>
</span><span class='line'>#endif</span></code></pre></td></tr></table></div></figure>


<p>And it&rsquo;ll work just fine as well).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/07/member-injection-module-for-autofac/">Member Injection Module for Autofac</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-07T00:00:00+00:00" pubdate data-updated="true">Sep 7<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Inevitably as a project gets more complicated, you will need to start using more features of your IoC container.  Autofac has built-in support for property injection by hooking into the OnActivating or OnActivated events, which basically set all public properties (or only those which are unset).

However, I didn&#8217;t really like this because once you start using properties, it&#8217;s not as clear cut as constructors that you are using injection.  It becomes hard to manage later on when you have many properties which some should be injected and others should be manually set in code.  Autofac&#8217;s inject all or only-null approach doesn&#8217;t fit the bill when a class gets a little more complicated.

I set up to fix this by writing a custom module, and it turned out to be very very simple.  With attributes, we can mimic functionality that&#8217;s used in Ninject.

Here&#8217;s the module code:
<pre>
public class MemberInjectionModule : IModule
{
  public void Configure(IContainer container)
  {
    container.ComponentRegistered += (oo, ee) =>
      ee.ComponentRegistration.Activated += (o, e) =>
    {
      const BindingFlags flags = BindingFlags.Instance |
                                 BindingFlags.NonPublic |
                                 BindingFlags.Public;
      var type = e.Instance.GetType();
      foreach (var field in type.GetFields(flags))
      {
        if (field.GetCustomAttributes(typeof(InjectedAttribute), true).Length > 0)
          field.SetValue(e.Instance, e.Context.Resolve(field.FieldType));
      }
      foreach (var prop in type.GetProperties(flags))
      {
        if (prop.GetCustomAttributes(typeof(InjectedAttribute), true).Length > 0)
        {
          if (prop.GetIndexParameters().Length > 0)
            throw new InvalidOperationException("Indexed properties cannot be injected.");

          prop.SetValue(e.Instance, e.Context.Resolve(prop.PropertyType), null);
        }
      }
    };
  }
}
[AttributeUsage(AttributeTargets.Field | AttributeTargets.Property)]
public class InjectedAttribute : Attribute { }
</pre>
And that&#8217;s it!  Pretty basic reflection here stuff here, but as you can see&#8230;iterate through all fields and properties (including privates), and try to resolve them.

Now, you can just RegisterModule(new MemberInjectionModule()), and inside your services you simply annotate your properties/fields with the [Injected] attribute, like so:
<pre>
public class SomeService : ISomeService
{
  [Injected]
  protected ISomeOtherService SomeOtherService { get; set; }
}
</pre>
And now, it&#8217;s a very clear cut way of explicitly defining which properties (and fields) should be injected.  Also, it&#8217;s also a simple string property away defined in the attribute if you want to specify a named service, which I&#8217;ll leave the the reader to implement :)</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/21/session-management-with-nhibernate-and-autofac-2/">Session Management With NHibernate and Autofac: Corollary</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-08-21T00:00:00+00:00" pubdate data-updated="true">Aug 21<span>st</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Ooops, I forgot to mention that it&#8217;s easily mockable as well.
<pre>
public class UserService : IUserService {
  public UserService(ISessionFactory factory, UsersRepositoryFactory usersFactory) { ... }
}
</pre>
So that&#8217;s the basic thing right.  So now, with <a href="http://code.google.com/p/moq/">Moq</a>, we can do this:
<pre>
var mockUserRepo = new Mock&lt;IUsersRepository&gt;();
mockUserRepo.Setup(x =&gt; x.GetUser(It.IsAny&lt;string&gt;())).Returns(() =&gt; someUser);

var userService = new UserService(..., x => mockUserRepo.Object);
</pre>
So what I&#8217;ve basically done is insert a lambda expression into the constructor, which is the delegate, which always returns my mock repository.  Pretty nifty methinks!</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/08/20/session-management-with-nhibernate-and-autofac-1/">Session Management With NHibernate and Autofac</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-08-20T00:00:00+00:00" pubdate data-updated="true">Aug 20<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
NHibernate is a beast let me tell you!  I think I already mentioned this in the previous post, but NHibernate definitely has a VERY high learning curve.  If it wasn&#8217;t for FluentNHibernate I&#8217;d probably still be struggling with XML mapping files right now.<br />
<br />
But anywho, it didn&#8217;t take long for me to run into very many problems with NHibernate.  It&#8217;s not really NHibernate&#8217;s fault, but more of maybe I&#8217;m trying to use the wrong tool for the job.<br />
<br />
I&#8217;m using DDD for my project, and there&#8217;s a clear separation between the client and the domain.  I got lazy and I didn&#8217;t make any DTOs for my entities, and just used the [DataContract] and [DataMember] to have WCF automatically generated &#8220;DTO&#8221;s for me (and in the options turn OFF reusing assemblies).<br />
<br />
(Disclaimer:  I am *not* by any means knowledgeable about NHibernate, but maybe, just maybe what I say here might point other people in the right direction)<br />
<br />
OK, all is good.  I can store my entities in the database, I can read them back.  So I fire up my client and read some users, and it blows up.  NHibernate by default lazy loads everything.  Here&#8217;s what I originally had in my UsersRepository<br />
<pre>public IEnumerable&lt;User&gt; GetAll() {
using (var session = _factory.OpenSession())
return session.CreateCriteria&lt;User&gt;().List&lt;User&gt;();
}
</pre><br />
It looks pretty innocent.  But it blows up.  Why?  If Users has a collection of other entities (which mine did), they are <span style="font-weight: bold;">not</span> loaded with the above code.  They are loaded on-demand, i.e. lazy loaded.  So when my WCF service finally returns the objects and serializes them, it pukes and throws an exception because the session was long closed already.<br />
<br />
Easy solution was to Not.LazyLoad() all my collections.  Now here&#8217;s what I&#8217;m thinking I might not be using the right tool for the job because I am purposely disabling one of the key features of NHibernate.  By default, caching is always enabled, and I couldn&#8217;t find anywhere how to globally turn it off.  You must go class by class.<br />
<br />
OK, so on to my next problem.  I soon ran into issues with entities not being unique.  I would have code like this in my UserService:<br />
<pre>public void AddProduct(string username, Guid productId) {
var user = _usersRepository.GetUser(username);
var product = _productRepository.GetProduct(productId);
user.Products.Add(product);
_usersRepository.Store(user);
}
</pre><br />
Again, this puked.  The problem here was after my GetUser call, inside my repository, like my first example, I had a using(session), which closed when the method ended.  Shortly after, I am trying to update the same user, but with a *different* session.  NHibernate doesn&#8217;t like this, an NHibernate.NonUniqueObjectException is thrown, and I had a new problem to deal with.<br />
<br />
It became clear I had to actively manage the sessions somehow, and the best place would be to have them in my services, which typically each method had a &#8220;unit of work&#8221; placed on them.<br />
<br />
So the goal I wanted to accomplish was to initiate a new session at the beginning of a service method, call a repository multiple times, close the session, and then exit the method.<br />
<br />
So how can we achieve that?<br />
<br />
I thought of a couple things, and the first thing I did actually was to use AOP style and use Autofac with Castle.DynamicProxy.  I created an interceptor for my service, and before invocation I opened a session, then manually called a property setter for a CurrentSession, and after invocation close the session.<br />
<br />
It did the job, but had some problems:<br />
a) It did a little too much black magic for me.  All methods got intercepted.<br />
b) I still had to manually set the CurrentSession property of my repositories.  Sooner or later I&#8217;m sure to run in the threading problems.<br />
<br />
After I got that half working I scrapped it and tried to come up with something better.  This is what I came up with:<br />
<pre>public delegate IUsersRepository UsersRepositoryFactory(ISession session);

public class UserService : IUserService {
public UserService(ISessionFactory factory, UsersRepositoryFactory usersFactory) { ... }
}

public class UsersRepository : IUsersRepository {
public UsersRepository(ISession session) { ... }
}
</pre><br />
Now, when I call a method on my UserService, I do this:<br />
<pre>public void AddProduct(string username, Guid productId) {
using (var session = _factory.OpenSession()) {
var userRepo = _userRepoFactory(session);
var productRepo = _productFactory(session);
...
}
}
</pre><br />
And, of course, the Autofac code:<br />
<pre>b.Register&lt;UsersRepository&gt;().As&lt;IUsersRepository&gt;().FactoryScoped();
b.RegisterGeneratedFactory&lt;UsersRepositoryFactory&gt;();
</pre><br />
More details on the delegate factory <a href="http://code.google.com/p/autofac/wiki/DelegateFactories">here</a>.  But basically, with Autofac I have told it to inject delegates into my UserService, and those delegates can create new instances of my user repository by passing in the current session.<br />
<br />
You&#8217;ll also notice I had a products repository as well.  With these delegate factories I can create up multiple repositories on the fly with the same session (and all the good NHibernate stuff that comes with that).<br />
<br />
Sure, there&#8217;s a whole bunch of using(var session) boilerplate now, but it&#8217;s explicit, clear, and allows for a lot of fine-grained control.<br />
<br />
EDIT: I have since dropped this approach and I&#8217;m currently injecting ISessions into my constructors by using Autofac&#8217;s container-scope (something that took me a while to understand).</div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/12/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/10/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/08/16/modularizing-vimscript/">Modularizing VimScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/30/1000-stars-in-1-month/">1000 stars in 1 month</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/21/smart-tab-expansions-in-vim-with-expression-mappings/">Smart tab expansions in Vim with expression mappings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/15/flight-of-an-open-source-project/">The flight of an open-source project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/02/unite-dot-vim-the-plugin-you-didnt-know-you-need/">Unite.vim, The plugin you didn&#8217;t know you need</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/on-typescript/">On TypeScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/13/dot-net-slash-wpf-to-html-slash-css-slash-javscript/">.NET/WPF to HTML/CSS/Javscript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/10/jumping-on-the-hacker-blog-bandwagon/">Jumping on the hacker blog bandwagon</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blingdev';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
