
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="I’ve been listening to a bunch of podcasts lately and I came across a gem that was pretty darn useful.&nbsp; It’s pretty old I suppose in technology &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io/blog/page/11">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/10/07/tdd-is-designunit-testing-legacy-code/">TDD Is Design…Unit Testing Legacy Code</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-10-07T00:00:00-04:00" pubdate data-updated="true">Oct 7<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
I’ve been listening to a bunch of podcasts lately and I came across a gem that was pretty darn useful.&nbsp; It’s pretty old I suppose in technology standards, since it was recorded January 12, 2009, but it’s still worth a listen.&nbsp; Scott Hanselman talks with Scott Bellware about TDD and design.&nbsp; Find it <a href="http://hanselminutes.com/default.aspx?showID=164">here</a>.<br />
I’m merely reiterating what Scott has already said in the podcast, but it’s different when I can personally say that I’m joining the ranks of countless others who have seen the benefits of TDD.<br />
<br />
Now I can’t say that I’m a 100% TDD practitioner since I’m still learning how to write tests before code effectively, but I’ve already seen the improvements in <b>design</b> in my code many times over just by merely writing unit tests.  At this point I&#8217;d say half of my tests are written first, and the other after are after the fact.<br />
<br />
I’ve been through many phases of writing unit tests, it it took me <b>a long time</b> to get it right (and I’m sure I have tons more to go).&nbsp; It takes some experience to figure out how to properly write unit tests, and as a by-product how to make classes easily testable.&nbsp; Code quality and testability go hand-in-hand, so if you find something difficult to test, it’s probably because it was badly designed to start.<br />
<br />
The first time I was introduced to unit testing in a work setting was when I was writing C++…and man it was ugly, not because it was C++, but because everything was tightly coupled and everything was a singleton.&nbsp; The fixture setup was outrageous, and it was common to ::Sleep(5000) to make tests pass.&nbsp; Needless to say, my first experience with unit testing was extremely painful.<br />
<br />
After a job switch and back to the C# world, I started reading more blogs, listening to more podcasts, and experimenting more.&nbsp; I was given a project to prototype, and for phase 1 it was an entirely DDD experience with I got the opportunity to experiment with writing unit tests the “proper” way with dependency injection and mocking frameworks.<br />
<blockquote>Unit tests are easy to write when you have highly decoupled components.<br />
</blockquote>Prototype was finished, and now I was back on the main project, and given a critical task to complete in 2 weeks.&nbsp; I had to modify a class which was 10,000 lines long, which has <b>mega</b> dependencies on everything else in the project.&nbsp; Anything I touched could potentially break something else.&nbsp; And of course…no unit tests whatsoever.&nbsp; I like challenges and responsibility – but this was close to overkill.&nbsp; This thing produces revenue for the company daily so I <i>really</i> don’t want to mess anything up.<br />
<br />
First thing I realized was that there’s no way I could possibly write any unit test for something like this.&nbsp; If the class file was 10,000 lines long, you can imagine the average line count for methods.<br />
<br />
And of course, the business team didn’t make things easy on me by asking that this feature be turned off in production, but turned on for QA.&nbsp; So, the best option was to refactor the existing logic out to a separate class, extract an interface, implement the new implementation, and swap between the 2 implementations dynamically.<br />
<br />
After 4 days of analyzing and reading code to make sure I have a very detailed battle plan, I started extracting the feature to a new class.&nbsp; The first iteration of the class was <b>UGLY</b>.&nbsp; I extracted out the feature I was changing to a separate class, but the method names were archaic and didn’t have any good “flow” to them.&nbsp; I felt that I had to comment my unit tests just so whoever’s reading them could understand what’s happening, which brings up a point.<br />
<blockquote>If you need to comment your unit tests, you need to redesign the API<br />
</blockquote>It took many iterations and refactoring of the interface to get it to the point where I found acceptable.&nbsp; If you compared the 1st batch of unit tests to the last batch of unit tests it is like night and day.&nbsp; The end result were unit tests which typically followed a 3-line pattern of setup/execute/verify.&nbsp; Brain dead simple.<br />
<br />
The last thing to do was to reintegrate the class into the original class.&nbsp; For this I was back to compile/run/debug/cross-fingers, but I had full confidence that whenever I called anything in the extracted class it would work.<br />
<br />
An added benefit is that I didn’t add another 500 lines of code to the already gigantic class.&nbsp; Basically, in summary:    <br />
<br />
<ul><li><span style="color: #4c4c4c;">Get super mega long legacy code class files</span> </li>
<li>Extract feature into separate file as close to original implementation as possible (initially will be copy-paste)</li>
<li>Run and make sure things don’t die</li>
<li>Write unit tests for extracted class (forces you to have a better understanding of the code modifications, and the requirements)</li>
<li>Make sure unit tests cover all possible scenarios of invocation from original class</li>
<li>Start refactoring and redesigning to better testability, while maintaining all previous tests</li>
<li>Done!&nbsp; Repeat as necessary!</li>
</ul></div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/27/dark-color-refresh/">Dark Color Refresh</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-27T00:00:00-04:00" pubdate data-updated="true">Sep 27<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p><a onblur="try {parent.deselectBloggerImageGracefully();} catch(e) {}" href="http://2.bp.blogspot.com/_WZr-_wsEf1c/Sqh4cikBOcI/AAAAAAAAABA/9NgFoJ5lIuA/s1600-h/colorscheme.png"><img style="text-align: center; margin: 0px 15px 10px 0px; width: 252px; display: inline; height: 400px; cursor: hand" id="BLOGGER_PHOTO_ID_5379682186603608514" border="0" alt="" align="left" src="http://2.bp.blogspot.com/_WZr-_wsEf1c/Sqh4cikBOcI/AAAAAAAAABA/9NgFoJ5lIuA/s400/colorscheme.png" /></a> There you have it!&#160; I started with Visual Studio’s default settings and configured each and every color one by one.&#160; 3 hours later I was finished and satisfied with what I have…but I think it was time well spent considering this is what I’m looking at for &gt;= 8 hours a day.</p>  <p>This was a complete re-do of my previous dark theme.&#160; This one is even more colorful than the <a href="http://blingcode.blogspot.com/2008/09/importance-of-color-schemes.html">previous</a>, mainly because <a href="http://www.jetbrains.com/resharper/index.html">Resharper</a> does an amazing job of detecting additional code elements like mutable vs unmutable, or unused code, in additional to many other things.</p>  <p>By the way, you should definitely spend the time to configure your own colors rather than using someone else’s template.&#160; The reason being is that each and every person is different, and obviously will have preferences towards different colors.&#160; I go through different moods and I’ll tweak the theme to be “blue” or “red” for a period of time.</p>  <p>Another reason why you configure it manually is that it drills into your brain more of what each color represents.&#160; If you just used my template you would probably never notice that orange means input parameter, and green is a local variable.</p>  <p>However, one thing you can and should take from this blog post is<strong> not to use pure black or pure white as your background </strong>(did you notice my current line indicator is darker than my background?).&#160; Set your background to (10,10,10) or (245,245,245).&#160; <em>Your eyes will thank me.</em></p>  </div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/26/autofacs-extremely-powerful-containerscope/">Autofac’s Extremely Powerful and Flexible ContainerScope</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-26T00:00:00-04:00" pubdate data-updated="true">Sep 26<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
I need to show some love and support for my favorite IoC tool because it’s most powerful feature needs more explaining.&nbsp; It’s not that the main site doesn’t provide a good explanation, because it does, but because most people don’t really understand what the solution is solving.<br />
The following is on Autofac’s <a href="http://code.google.com/p/autofac/">front page</a>:<br />
<blockquote><pre class="csharpcode">var container = // ...
using (var inner = container.CreateInnerContainer())
{
  var controller = inner.Resolve&lt;IController&gt;();
  controller.Execute(); // use controller..
}</pre></blockquote>The first time I saw this I basically glanced right passed it.&nbsp; Honestly I didn’t think anything of it, and initially the reason I tried out Autofac was for its very slick lambda registrations.&nbsp; I didn’t realize I was in a world of surprises when I finally realized the power and flexibility of Autofac’s container scope.<br />
<br />
If <a href="http://www.codinginstinct.com/2008/05/ioc-container-benchmark-rerevisted.html">benchmarks</a> and <a href="http://blog.ashmind.com/index.php/2008/09/08/comparing-net-di-ioc-frameworks-part-2/">feature comparisons</a> are not enough show off Autofac’s features, this blog post hopes to show how to solve “complex” problems elegantly.<br />
<br />
Let’s start with the typical NHibernate use-case.&nbsp; Create 1 singleton, create many sessions-per-request.&nbsp; Here’s a solution with <a href="http://nhforge.org/blogs/nhibernate/archive/2009/08/29/part-7-nhibernate-and-ninject-for-asp-net-mvc.aspx">Ninject</a> (not that I’m picking on Ninject, because I love its very slick contextual binding, but because most other IoC containers have a similar solution, like <a href="http://ayende.com/Blog/archive/2007/06/14/Using-NHibernate-Session-Per-Request-with-WCF-Windsor-Integration.aspx">per-session with WCF &amp; Windsor</a>).<br />
<br />
Basically, the solutions mentioned above will following an approach like this: <br />
<br />
a) Hook into the beginning of a request, and create the ISession from the ISessionFactory. <br />
b) Set it in the HttpContext.Current or OperationContext.Current’s dictionaries. <br />
c) Get this property in all the dependencies that need it. <br />
d) At the end of the request, Dispose() the ISession.<br />
<br />
OK, pretty simple and straightforward solution, but there’s one key thing that really bugs me is that by doing this we have introduced a dependency…that is, HttpContext.Current[].&nbsp; That, or you could wrap that around a class, like SessionManager, again, basically coupling to a dependency under a different name.&nbsp; With Autofac, we can bypass steps b and c entirely and only worry about the beginning and end of a request.<br />
<br />
To start off, here&#8217;s the basic wiring needed:<br />
<div style="text-align: left;"><blockquote><div class="csharpcode"><pre class="alt">1:   var cb = new ContainerBuilder(); 
2:   cb.Register(x =&gt; CreateSessionFactory())
       .As&lt;ISessionFactory&gt;()
       .SingletonScoped(); 
3:   cb.Register(x =&gt; x.Resolve&lt;ISessionFactory&gt;().OpenSession())
       .As&lt;ISession&gt;()
       .ContainerScoped(); 
4:   IContainer c = cb.Build(); 
5:  &nbsp;
6:   Assert.AreSame(c.Resolve&lt;ISessionFactory&gt;(), c.Resolve&lt;ISessionFactory&gt;()); 
7:   Assert.AreSame(c.Resolve&lt;ISession&gt;(), c.Resolve&lt;ISession&gt;()); 
8:  &nbsp;
9:   var inner1 = c.CreateInnerContainer(); 
10:  Assert.AreSame(c.Resolve&lt;ISessionFactory&gt;(), inner1.Resolve&lt;ISessionFactory&gt;()); 
11:  Assert.AreNotSame(c.Resolve&lt;ISession&gt;(), inner1.Resolve&lt;ISession&gt;());</pre></div></blockquote></div>That’s the configuration.&nbsp; And that’s it!&nbsp; Nothing more.&nbsp; No additional SessionManager class.&nbsp; No need to use HttpContext.Current to store the session.&nbsp; Just pass ISession in with regular constructor/property injection.<br />
<br />
Here’s how it works:<br />
<br />
Line 2: ISessionFactory is created from CreateSessionFactory().&nbsp; This is a singleton so there will always be one and only one instance of it within the container (and all child containers).<br />
<br />
Line 3: This is where it’s interesting.&nbsp; We’re saying “whenever I need an ISession, resolve ISessionFactory and call OpenSession() on it”.&nbsp; Also, by specifying ContainerScope, we only get 1 instance per-container.<br />
<br />
And this is where it’s sort of confusing with the terminology.&nbsp; You can think of Autofac as a tree of containers.&nbsp; The root container (variable c in this case), can create children containers (inner1 in this case, and inner1 could create an inner2, and so on).&nbsp; So when something is Singleton scoped, that means that the root container, and any child containers (and child’s children) will only have 1 instance of a service.&nbsp; With ContainerScope, each “node = container” in the tree gets 1 instance.<br />
<br />
So back to the unit test above, in line 6 we verify that there is only 1 instance of ISessionFactory.&nbsp; We resolve ISession twice as well, which shows that we get the same instance.<br />
<br />
Line 9, we create an inner container, and here we see that ISessionFactory is the same for both the container <b>c</b> and inner container <b>inner1</b>.&nbsp; However, the ISession resolved is <b>different</b> between the two.<br />
Thus, by specifying ContainerScope, you can very easily group <i>multiple</i> services and dependencies together as one unit.&nbsp; Implementing the Unit of Work pattern is insanely easy with Autofac.&nbsp; Create services A, which depends on B, which depends on C, which all the previous depends on D.&nbsp; Resolve A within a new inner container, and B, C, and D will always be the same instances.&nbsp; Resolve A in another inner container and you will get a new set of instances.<br />
<br />
Last but not least, Autofac will automatically call Dispose() on all resolved services once the container is disposed.&nbsp; So for the above, once <b>inner1</b>.Dispose() is called, ISession.Dispose() is automatically called.&nbsp; If you needed to, you can very easily hook into this mechanism and implement things like transactions and rollbacks.<br />
<br />
I hope this blog post clears things up a little bit about Autofac’s ContainerScope!</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Nick</div>
<div class='content'>
Heya Bailey! Think there is more than one &#39;Nick&#39; lurking around your blog (or else I have a case of amnesia :))<br /><br />Love the article, definitely need more info like this around the &#39;net.<br /><br />Nick (mk II)</div>
</div>
<div class='comment'>
<div class='author'>bling</div>
<div class='content'>
Thanks for dropping by Nick!<br /><br />To answer the question, what I ended up doing was creating a set of services for each request/session, basically like how I described in my post.<br /><br />I also wrote my own custom interception module (took some ideas from the one in contrib) based on Castle&#39;s DynamicProxy2.<br /><br />The main difference was that my interceptors work iff methods have specific attributes, and with that I was able to selectively say which methods got transactions (among other things).<br /><br />This made things really easy because I could have the transaction span multiple methods as one huge call or a simple 1 line method depending on where my transaction attributes appear in the code.</div>
</div>
<div class='comment'>
<div class='author'>Nick</div>
<div class='content'>
I&#39;ve been toying with a similar approach, but I&#39;m uncertain about how to manage NHibernate&#39;s Transaction (Commits and Rollbacks) in this scenario.  I&#39;ve seen examples that make use of TransactionAttributes (in the case of MVC apps), and previously I had been managing transactions in the begin/end request events (in global.asax), but that ties every request to a transaction which isn&#39;t necessary.  How did you go about handling transactions in this scenario?</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/13/getting-code-coverage-working-on/">Getting Code Coverage Working on TeamCity 5 With Something Other Than NUnit</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-13T00:00:00-04:00" pubdate data-updated="true">Sep 13<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been experimenting lately with <a href="http://www.jetbrains.net/confluence/display/TW/TeamCity+EAP?eap">TeamCity 5 EAP</a> and so far it&rsquo;s been a pretty awesome experience.  I was up and running within minutes and I was swarmed with beautiful graphs and statistics with specifics even per-test.  Getting something like that up with <a href="http://ccnet.thoughtworks.com/">CC.NET</a> is not a trivial task.</p>

<p>Anywho, with TC5 code coverage is one of the cool new features added for .NET, but unfortunately only <a href="http://nunit.org">NUnit</a> is supported.  Not that that&rsquo;s a bad thing, but some people  prefer to use other testing tools.  Two notable contenders are <a href="http://xunit.codeplex.com">xUnit.net</a> and <a href="http://www.gallio.org">MbUnit</a>.</p>

<p>I like the fact (pun intended) that xUnit.net makes it a point to prevent you from doing bad practices (like <code>[ExpectedException]</code>), and I like how MbUnit is so bleeding edge with useful features (like <code>[Parallelizable]</code> and a vast availability of assertions).</p>

<p>And with that I set up to figure out how to get TC working with Gallio, but the following should work with any test runner.</p>

<p>It certainly was a pain to set up because it took a lot of trial and error but eventually I figured it out.  I analyzed the build logs provided in each build report and noticed something interesting&hellip;specifically:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[13:51:23]: ##teamcity[importData type=’dotNetCoverage’ tool=’ncover’ file=’C:\TeamCity5\buildAgent\temp\buildTmp\tmp1C93.tmp’]</span></code></pre></td></tr></table></div></figure>


<p>and</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageL’ value=’94.85067’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageM’ value=’97.32143’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageC’ value=’98.68421’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsLCovered’ value=’921.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsMCovered’ value=’218.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsCCovered’ value=’75.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsLTotal’ value=’971.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsMTotal’ value=’224.0’]
</span><span class='line'>[13:51:30]: ##teamcity[buildStatisticValue key=’CodeCoverageAbsCTotal’ value=’76.0’]</span></code></pre></td></tr></table></div></figure>


<p>The first message happens after NCover.Console is done its thing.  After NCoverExplorer is done its thing, the statistics are published.  I set out to mimic this functionality with Gallio, but what&rsquo;s described here should work with any test runner.</p>

<ol>
<li>Disable code coverage in TC.  We&rsquo;re doing it manually instead.</li>
<li>In your build script, run your unit tests with NCover and generate a coverage.xml report.</li>
<li>Run NCoverExplorer on coverage.xml and generate reports ncoverexplorer.xml and index.html.</li>
<li>Create a zip file of index.html and name it coverage.zip.</li>
<li>Configure coverage.zip to be an artifact in your TC configuration (this is to enable the tab).</li>
<li>Parse out ncoverexplorer.xml with XPath and output the statistics.</li>
</ol>


<p>Certainly a lot of things to do just for the sake of pretty statistics reporting&hellip;.but it was the weekend and I was bored.  With the help of <a href="http://msbuildtasks.tigris.org/">MSBuildCommunityTasks</a>, the zip file and XML parsing was made a lot easier.</p>

<p>After that, viola!  Code coverage + Gallio on TeamCity 5!!!</p>

<p>Unfortunately, NCoverExplorer&rsquo;s report only reports the # total of classes and nothing about unvisited or covered, so for those values I set to 0/0/0 (BTW, you need all values present for the statistics to show).  A task for next weekend!!!</p>

<p>(Edit: I suppose I could should also mention that you could technically avoid all the trouble above and hack it with this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#if NUNIT
</span><span class='line'>
</span><span class='line'>using TestFixtureAttribute = NUnit.Framework.TestFixtureAttribute;
</span><span class='line'>
</span><span class='line'>using TestAttribute = NUnit.Framework.TestAttribute;
</span><span class='line'>
</span><span class='line'>#endif</span></code></pre></td></tr></table></div></figure>


<p>And it&rsquo;ll work just fine as well).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/09/07/member-injection-module-for-autofac/">Member Injection Module for Autofac</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-09-07T00:00:00-04:00" pubdate data-updated="true">Sep 7<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Inevitably as a project gets more complicated, you will need to start using more features of your IoC container.  Autofac has built-in support for property injection by hooking into the OnActivating or OnActivated events, which basically set all public properties (or only those which are unset).

However, I didn&#8217;t really like this because once you start using properties, it&#8217;s not as clear cut as constructors that you are using injection.  It becomes hard to manage later on when you have many properties which some should be injected and others should be manually set in code.  Autofac&#8217;s inject all or only-null approach doesn&#8217;t fit the bill when a class gets a little more complicated.

I set up to fix this by writing a custom module, and it turned out to be very very simple.  With attributes, we can mimic functionality that&#8217;s used in Ninject.

Here&#8217;s the module code:
<pre>
public class MemberInjectionModule : IModule
{
  public void Configure(IContainer container)
  {
    container.ComponentRegistered += (oo, ee) =>
      ee.ComponentRegistration.Activated += (o, e) =>
    {
      const BindingFlags flags = BindingFlags.Instance |
                                 BindingFlags.NonPublic |
                                 BindingFlags.Public;
      var type = e.Instance.GetType();
      foreach (var field in type.GetFields(flags))
      {
        if (field.GetCustomAttributes(typeof(InjectedAttribute), true).Length > 0)
          field.SetValue(e.Instance, e.Context.Resolve(field.FieldType));
      }
      foreach (var prop in type.GetProperties(flags))
      {
        if (prop.GetCustomAttributes(typeof(InjectedAttribute), true).Length > 0)
        {
          if (prop.GetIndexParameters().Length > 0)
            throw new InvalidOperationException("Indexed properties cannot be injected.");

          prop.SetValue(e.Instance, e.Context.Resolve(prop.PropertyType), null);
        }
      }
    };
  }
}
[AttributeUsage(AttributeTargets.Field | AttributeTargets.Property)]
public class InjectedAttribute : Attribute { }
</pre>
And that&#8217;s it!  Pretty basic reflection here stuff here, but as you can see&#8230;iterate through all fields and properties (including privates), and try to resolve them.

Now, you can just RegisterModule(new MemberInjectionModule()), and inside your services you simply annotate your properties/fields with the [Injected] attribute, like so:
<pre>
public class SomeService : ISomeService
{
  [Injected]
  protected ISomeOtherService SomeOtherService { get; set; }
}
</pre>
And now, it&#8217;s a very clear cut way of explicitly defining which properties (and fields) should be injected.  Also, it&#8217;s also a simple string property away defined in the attribute if you want to specify a named service, which I&#8217;ll leave the the reader to implement :)</div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/12/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/10/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/16/emacs-as-my-evil-mode/">Emacs as my Leader: evil-mode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/09/vim-in-emacs-bootstrap/">Vim in Emacs Bootstrap</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/16/modularizing-vimscript/">Modularizing VimScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/30/1000-stars-in-1-month/">1000 stars in 1 month</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/21/smart-tab-expansions-in-vim-with-expression-mappings/">Smart tab expansions in Vim with expression mappings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/15/flight-of-an-open-source-project/">The flight of an open-source project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/02/unite-dot-vim-the-plugin-you-didnt-know-you-need/">Unite.vim, The plugin you didn&#8217;t know you need</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/on-typescript/">On TypeScript</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blingdev';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
