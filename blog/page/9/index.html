
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="Apparently, setting IsUndoEnabled to false isn’t enough. You must also set UndoLimit=0 as well otherwise it&rsquo;ll still keep track of undo history &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io/blog/page/9">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/10/05/memory-leak-with-wpfs-richtextbox/">Memory Leak With WPF’s RichTextBox</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-05T00:00:00-04:00" pubdate data-updated="true">Oct 5<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Apparently, setting <code>IsUndoEnabled</code> to false isn’t enough.  You must also set <code>UndoLimit=0</code> as well otherwise it&rsquo;ll still keep track of undo history.  Doh!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/10/04/yet-another-weak-event-for-wpf/">Yet Another Weak Event Implementation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-04T00:00:00-04:00" pubdate data-updated="true">Oct 4<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I gotta say that WPF is a complete pain in the butt when it comes to memory leaks.  A simple google/bing search shows up more than enough results for weak events, so why am I making yet another blog post about another implementation of a weak event?  Well, if someone else out there happens to have the same requirements/needs that I do right now, maybe this will save them a little time.</p>

<p>In my particular case, I needed to accomplish a couple goals:
&ndash; Minimal performance hit.  a.k.a minimal use of reflection.
&ndash; Generic and easy to use.
&ndash; Thread safe.
&ndash; Support for explicit registration and unregistration.</p>

<p>One of the better implementations on weak events I found was from Dustin Campbell&rsquo;s <a href="http://diditwith.net/PermaLink,guid,aacdb8ae-7baa-4423-a953-c18c1c7940ab.aspx">blog post</a>.  Unfortunately, this implementation has one major problem: you cannot explicitly unregister.  In fact, the only way an attached listener no longer receives messages is if it gets garbage collected.  Our application happened to use this for an especially special event on our base entity: the infamous INotifyPropertyChanged event.  Needless to say, all the static WPF dependency objects left a whole bunch of leaked WeakReferences around (ironic?).</p>

<p>But wait, doesn&rsquo;t WPF already have a IWeakEventManager that solves this problem?  The problem with this is a couple things.  It&rsquo;s slow.  It&rsquo;s painful to use.  It&rsquo;s annoying to implement.  Long story short, you need a static WeakEventManager for <em>every</em> unique delegate.  Yes, sure, you can override a lot of the methods to make it more perform faster, but if you need to go that far you might as well write your own that does just what you need, and no more.</p>

<p>If you haven&rsquo;t found it already, Daniel Grunwald&rsquo;s Code Project <a href="http://www.codeproject.com/KB/cs/WeakEvents.aspx">article</a> is yet another great resource.  My implementation was a mix of this and the earlier mentioned link.  Anywho, here it is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">SynchronizationPriority</span> <span class="n">priority</span><span class="p">,</span> <span class="n">TSender</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WeakEventEntry</span><span class="p">&lt;</span><span class="n">TTarget</span><span class="p">,</span> <span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TTarget</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'><span class="err">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">OpenForwardingEventHandler</span><span class="p">(</span><span class="n">TTarget</span> <span class="n">target</span><span class="p">,</span> <span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">WeakReference</span> <span class="n">m_TargetRef</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">OpenForwardingEventHandler</span> <span class="n">m_OpenHandler</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MethodInfo</span> <span class="n">m_Method</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">WeakEventEntry</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">m_OpenHandler</span> <span class="p">=</span> <span class="p">(</span><span class="n">OpenForwardingEventHandler</span><span class="p">)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">OpenForwardingEventHandler</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">);</span>
</span><span class='line'>        <span class="n">m_TargetRef</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span><span class="p">);</span>
</span><span class='line'>        <span class="n">m_Method</span> <span class="p">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">IsAlive</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span> <span class="p">==</span> <span class="n">m_Method</span> <span class="p">&amp;&amp;</span> <span class="n">handler</span><span class="p">.</span><span class="n">Target</span> <span class="p">==</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">Target</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">TTarget</span> <span class="n">target</span> <span class="p">=</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">Target</span> <span class="k">as</span> <span class="n">TTarget</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">m_OpenHandler</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WeakEvent</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">EMPTY_LIST</span> <span class="p">=</span> <span class="k">new</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;&gt;</span> <span class="n">m_Events</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">EMPTY_LIST</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_InvokeList</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="c1">// static method</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">StrongEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;(</span><span class="n">handler</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">WeakEventEntry</span><span class="p">&lt;,,&gt;).</span><span class="n">MakeGenericType</span><span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span><span class="p">.</span><span class="n">GetType</span><span class="p">(),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TSender</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TArgs</span><span class="p">));</span>
</span><span class='line'>            <span class="n">Add</span><span class="p">((</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;)</span><span class="n">type</span><span class="p">.</span><span class="n">GetConstructors</span><span class="p">()[</span><span class="m">0</span><span class="p">].</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">handler</span> <span class="p">}));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="n">entry</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>                <span class="n">m_Events</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;&gt;(</span><span class="m">8</span><span class="p">);</span>
</span><span class='line'>            <span class="n">m_Events</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span><span class='line'>            <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Remove</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Matches</span><span class="p">(</span><span class="n">handler</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="n">m_Events</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">m_Events</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>            <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">EMPTY_LIST</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Raise</span><span class="p">(</span><span class="n">TSender</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">events</span> <span class="p">=</span> <span class="n">m_InvokeList</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">bool</span> <span class="n">removeDead</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">events</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
</span><span class='line'>            <span class="n">removeDead</span> <span class="p">|=</span> <span class="p">!</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Invoke</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">removeDead</span><span class="p">)</span>
</span><span class='line'>            <span class="n">RemoveDeadReferences</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">void</span> <span class="nf">RemoveDeadReferences</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(!</span><span class="n">m_Events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">IsAlive</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">m_Events</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing too special here.  For performance, a copy of all events are stored in an array so that raising events doesn&rsquo;t need to be in a lock.  And while locking on &ldquo;this&rdquo; is usually bad practice, in this case I didn&rsquo;t have any other local variable to use, and creating an object just for the sake of locking in my eyes was not worth it in this scenario.</p>

<p>I tried generating the OpenForwardingDelegate using DynamicMethod and IL, but the result was negligible because it doesn&rsquo;t actually affect invoking speed, which is what we&rsquo;re most concerned with.</p>

<p>Also, if you didn&rsquo;t notice, this implementation also supports static methods attaching, hence why there is an IWeakEventEntry interface.  Here&rsquo;s the StrongEventEntry implementation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">StrongEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">ClosedForwardingEventHandler</span><span class="p">(</span><span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ClosedForwardingEventHandler</span> <span class="n">m_ClosedHandler</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MethodInfo</span> <span class="n">m_Method</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">StrongEventEntry</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">m_Method</span> <span class="p">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
</span><span class='line'>        <span class="n">m_ClosedHandler</span> <span class="p">=</span> <span class="p">(</span><span class="n">ClosedForwardingEventHandler</span><span class="p">)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ClosedForwardingEventHandler</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">m_Method</span> <span class="p">==</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">SynchronizationPriority</span> <span class="n">priority</span><span class="p">,</span> <span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">m_ClosedHandler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last but not least, usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="n">WeakEvent</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">PropertyChangedEventArgs</span><span class="p">&gt;</span> <span class="n">_propertyChanged</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WeakEvent</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">PropertyChangedEventArgs</span><span class="p">&gt;();</span>
</span><span class='line'><span class="k">public</span> <span class="k">event</span> <span class="n">PropertyChangedEventHandler</span> <span class="n">PropertyChanged</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">add</span> <span class="p">{</span> <span class="n">_propertyChanged</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">remove</span> <span class="p">{</span> <span class="n">_propertyChanged</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Performance is quite good.  On my machine for 1,000,000,000 invocations, it takes the WeakEvent ~17.3 seconds, vs 4.2 seconds for a standard delegate, for roughly 4x invocation cost.</p>

<p>And there you have it!  A simple, generic, and fast weak event in ~200 lines of code.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/05/14/contextual-lifestyle-with-castle/">Contextual Lifestyle With Castle Windsor</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-14T00:00:00-04:00" pubdate data-updated="true">May 14<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<b>EDIT:</b>&nbsp;As of version 3, scoped lifestyles are now a first class citizen supported out of the box (<a href="http://docs.castleproject.org/Windsor.Whats-New-In-Windsor-3.ashx">http://docs.castleproject.org/Windsor.Whats-New-In-Windsor-3.ashx</a>)<br />
<strong>EDIT:</strong> A much better implementation can be found at <a href="https://github.com/castleprojectcontrib/Castle.Windsor.Lifestyles" title="https://github.com/castleprojectcontrib/Castle.Windsor.Lifestyles">https://github.com/castleprojectcontrib/Castle.Windsor.Lifestyles</a><br />
<br />
IMO, one of the big missing features of Castle Windsor is that it doesn’t come with a built-in way for dealing with contextual lifestyles.&nbsp; It handles transients and singletons fairly well, but once you get to other lifestyles it’s pretty heavily dependent on having some “state manager” handling the instances.&nbsp; For example, PerWebRequest uses the HttpContext, PerThread uses thread static variables, etc.<br />
Contextual lifestyles is one of those things where it doesn’t seem all that useful at first, and then when you see the possibilities it’s like getting hit with a huge truck.<br />
A question was posted to the Castle Google Group recently, which I follow, which illustrates a relatively common example of why someone would want to have a contextual lifestyle.&nbsp; Basically, you have a whole bunch of components you want to resolve, but only within a context.<br />
Here’s some boiler plate code of the domain model:<br />
<pre class="csharpcode"><span class="kwrd">public</span> <span class="kwrd">interface</span> IRepository { ISession Session { get; } }
<span class="kwrd">public</span> <span class="kwrd">interface</span> ISession : IDisposable { <span class="kwrd">bool</span> IsDisposed { get; } }
<span class="kwrd">public</span> <span class="kwrd">class</span> Session : ISession
{
    <span class="kwrd">public</span> <span class="kwrd">bool</span> IsDisposed { get; set; }
    <span class="kwrd">public</span> <span class="kwrd">void</span> Dispose() { IsDisposed = <span class="kwrd">true</span>; }
}
<span class="kwrd">public</span> <span class="kwrd">class</span> Repository1 :IRepository
{
    <span class="kwrd">public</span> ISession Session { get; <span class="kwrd">private</span> set; }
    <span class="kwrd">public</span> Repository1(ISession session){ Session = session; }
}
<span class="kwrd">public</span> <span class="kwrd">class</span> Repository2 : IRepository
{
    <span class="kwrd">public</span> ISession Session { get; <span class="kwrd">private</span> set; }
    <span class="kwrd">public</span> Repository2(ISession session){ Session = session; }
}
<span class="kwrd">public</span> <span class="kwrd">class</span> Model1
{
    <span class="kwrd">public</span> IRepository First { get; <span class="kwrd">private</span> set; }
    <span class="kwrd">public</span> IRepository Second { get; <span class="kwrd">private</span> set; }
    <span class="kwrd">public</span> Model1(IRepository first, IRepository second) { First = first; Second = second; }
}
<span class="kwrd">public</span> <span class="kwrd">class</span> Model2
{
    <span class="kwrd">public</span> IRepository Second { get; <span class="kwrd">private</span> set; }
    <span class="kwrd">public</span> Model2(IRepository second) { Second = second; }
}</pre><style type="text/css">
.csharpcode, .csharpcode pre
{
 font-size: small;
 color: black;
 font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
 background-color: #ffffff;
 /*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
 background-color: #f4f4f4;
 width: 100%;
 margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>And here’s the unit test I want to pass:<br />
<pre class="csharpcode">[Test]
        <span class="kwrd">public</span> <span class="kwrd">void</span> ResolutionsByContext()
        {
            IWindsorContainer root = <span class="kwrd">new</span> WindsorContainer();
            root.Register(Component.For&lt;Model1&gt;().LifeStyle.Transient,
                          Component.For&lt;Model2&gt;().LifeStyle.Transient,
                          Component.For&lt;IRepository&gt;().ImplementedBy&lt;Repository1&gt;().LifeStyle.Transient,
                          Component.For&lt;IRepository&gt;().ImplementedBy&lt;Repository2&gt;().LifeStyle.Transient,
                          Component.For&lt;ISession&gt;().ImplementedBy&lt;Session&gt;().LifeStyle.PerContextScope());

            Model1 model1;
            Model2 model2;
            ISession session1, session2;
            <span class="kwrd">using</span> (var context1 = root.BeginLifetimeScope())
            {
                model1 = context1.Resolve&lt;Model1&gt;();
                session1 = model1.First.Session;
                Assert.AreSame(model1.First.Session, model1.Second.Session);
                Assert.AreSame(context1.Resolve&lt;ISession&gt;(), context1.Resolve&lt;ISession&gt;());

                <span class="kwrd">using</span> (var context2 = root.BeginLifetimeScope())
                {
                    model2 = context2.Resolve&lt;Model2&gt;();
                    session2 = model2.Second.Session;
                    Assert.AreNotSame(model1.First.Session, model2.Second.Session);

                    var anotherModel2 = context2.Resolve&lt;Model2&gt;();
                    Assert.AreSame(anotherModel2.Second.Session, model2.Second.Session);

                    Assert.AreSame(session2, context2.Resolve&lt;ISession&gt;());
                    Assert.AreNotSame(context1.Resolve&lt;ISession&gt;(), context2.Resolve&lt;ISession&gt;());
                }
                Assert.IsTrue(session2.IsDisposed);
                Assert.IsFalse(session1.IsDisposed);
            }
            Assert.IsTrue(session1.IsDisposed);
        }</pre><style type="text/css">
.csharpcode, .csharpcode pre
{
 font-size: small;
 color: black;
 font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
 background-color: #ffffff;
 /*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
 background-color: #f4f4f4;
 width: 100%;
 margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>  <br />
I copied the name BeginLifetimeScope from Autofac, which inherently supports contextual scopes as a first-class citizen (of which the test passes).&nbsp; The question now, is how do we get Castle Windsor to do the same?<br />
Initially, I took a look at ISubDependencyResolver and caching variables.&nbsp; Unfortunately, this didn’t work too well because sub resolvers never got hit if they were resolved from the container directly.<br />
The next step I tried was with lifestyle managers, but alas, the CreationContext was always transient and I was unable to store any state that distinguished between different context resolutions.<br />
After digging deeper into the Windsor codebase and getting into the subsystems and handlers, I found a solution that seems to work.&nbsp; It passes the test above, but that’s about it.&nbsp; Test well if you’re gonna use this in production code!!!<br />
Here goes!<br />
First, you have a lifestyle manager to distinguish between other lifestyles.<br />
<pre class="csharpcode"><span class="kwrd">public</span> <span class="kwrd">class</span> ContextualLifestyleManager : AbstractLifestyleManager
    {
        <span class="kwrd">private</span> <span class="kwrd">object</span> instance;
        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">object</span> Resolve(CreationContext context)
        {
            <span class="kwrd">return</span> instance ?? (instance = <span class="kwrd">base</span>.Resolve(context));
        }
        <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">void</span> Dispose()
        {
        }
    }</pre>And finally, the magic happens with this:<br />
<pre class="csharpcode"><span class="kwrd">public</span> <span class="kwrd">static</span> <span class="kwrd">class</span> ContextualExtensions
    {
        <span class="kwrd">public</span> <span class="kwrd">static</span> ComponentRegistration&lt;T&gt; PerContextScope&lt;T&gt;(<span class="kwrd">this</span> LifestyleGroup&lt;T&gt; group)
        {
            <span class="kwrd">return</span> group.Custom&lt;ContextualLifestyleManager&gt;();
        }
        <span class="kwrd">public</span> <span class="kwrd">static</span> IWindsorContainer BeginLifetimeScope(<span class="kwrd">this</span> IWindsorContainer parent)
        {
            var child = <span class="kwrd">new</span> WindsorContainer();
            var ss = (INamingSubSystem)parent.Kernel.GetSubSystem(SubSystemConstants.NamingKey);
            <span class="kwrd">foreach</span> (var handler <span class="kwrd">in</span> ss.GetHandlers())
            {
                <span class="kwrd">if</span> (handler.ComponentModel.CustomLifestyle == <span class="kwrd">typeof</span>(ContextualLifestyleManager))
                {
                    child.Kernel.AddCustomComponent(handler.ComponentModel);
                }
            }
            parent.AddChildContainer(child);
            <span class="kwrd">return</span> child;
        }
    }</pre>First method is just a helper method to be a little more fluent in the registration for when you want many things to have contextual lifestyle.&nbsp; The second method is the guts.&nbsp; Long story short, we create a child container, and duplicate all component models of contextual lifestyle.&nbsp; Thus, whenever components are resolved, the “override” is found in the child and resolved.&nbsp; Anything else will be found in the parent.<br />
I was initially pretty happy with this, until I profiled the performance.&nbsp; With Autofac, creating and disposing 100,000 contexts took 5ms on my computer.&nbsp; Doing the same with with Windsor took 3.8 <strong>seconds</strong>.&nbsp; Out of curiosity, I profiled again, but this time just creating child containers without copying handlers down: 1.9 seconds.&nbsp; So while this implementation works, it’s not as performant as I’d like it to be….<br />
Maybe I’ll come up with another solution, but for now if the performance is acceptable maybe this would be useful for others!</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>bling</div>
<div class='content'>
LOL I need to check these comments more often.  Thanks for responding!</div>
</div>
<div class='comment'>
<div class='author'>Krzysztof Koźmic (2)</div>
<div class='content'>
That&#39;s my quick and dirty impl based on per-web-request lifestyle that is far more lightweight and should have similar perf characteristics to other lifestyles<br /><br />http://gist.github.com/400979<br />http://gist.github.com/400980</div>
</div>
<div class='comment'>
<div class='author'>Krzysztof Koźmic (2)</div>
<div class='content'>
No wonder it is taking so long, you&#39;re doing it in very heavyweight fashion.<br /><br /><br />It can be done w/o nested containers, much more lightweight.</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/04/21/forcing-castle-windsor-to-generate/">Forcing Castle Windsor to Generate Class Proxies</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-04-21T00:00:00-04:00" pubdate data-updated="true">Apr 21<span>st</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
I don&#8217;t know why it took me so long to come up with this idea, but to save others potential headaches&#8230;have you ever thought &#8220;hmmmm, I registered this as an interface with an implementation, but I want Windsor to use a class proxy, not an interface proxy, how do I do that?&#8221;<br />
<br />
For me, initially I <i>almost</i> went as far as implementing my own ProxyFactory to force it to use class proxy no matter what, and then the light bulb hit me and it turns out that there&#8217;s a much easier way to accomplish this.<br />
<br />
c.Register(Component.For&lt;ConcreteImpl, IService&gt;().Interceptors&lt;AnInterceptor&gt;());<br />
<br />
Tada!&nbsp; The actual service is now a concrete type, so Windsor will go, OK, I need to create a class proxy.&nbsp; But since it&#8217;s forwarded to the interface as well, all your dependencies can simply use the interface and everything magically works.<br />
<br />
Yay!</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>bling</div>
<div class='content'>
void IService.SomeLongRunningOperation() {<br />  Action1();<br />  Action2();<br />  Action3();<br />}<br /><br />protected virtual void Action1() {}<br />protected virtual void Action2() {}<br />protected virtual void Action3() {}<br /><br />Without class proxies, those action methods could not be intercepted, and in our case, we would not be able to collect metrics/statistics on those methods.</div>
</div>
<div class='comment'>
<div class='author'>Krzysztof Koźmic (2)</div>
<div class='content'>
Why did you want a class proxy for interface service?</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/04/05/windsordynamicproxymixin-powers/">Windsor/DynamicProxy/Mixin Powers!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-04-05T00:00:00-04:00" pubdate data-updated="true">Apr 5<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
Hmmm, I couldn’t really think of a good title except that this blog post has a little bit of everything of the title.<br />
<br />
As with any multithreaded program, deadlocks are a huge pain in the butt, and when they happen it costs time, money, and stress.<br />
<br />
In my code base I’ve introduced something called an ExtendedLock, which basically has something like this inside:<br />
<div class="csharpcode"><pre class="alt"><span class="lnum">   1:  </span><span class="kwrd">public</span> <span class="kwrd">class</span> ExtendedLock : IExtendedLock {</pre><pre><span class="lnum">   2:  </span>  <span class="kwrd">public</span> IDisposable Lock() {</pre><pre class="alt"><span class="lnum">   3:  </span>    <span class="kwrd">while</span> (!Monitor.TryEnter(<span class="kwrd">this</span>, 5000)) {</pre><pre><span class="lnum">   4:  </span>      IncrementLockTime();</pre><pre class="alt"><span class="lnum">   5:  </span>    }</pre><pre><span class="lnum">   6:  </span>    <span class="kwrd">return</span> <span class="kwrd">new</span> Disposer(() =&gt; Release());</pre><pre class="alt"><span class="lnum">   7:  </span>  }</pre><pre><span class="lnum">   8:    public event Deadlock;</span></pre><pre>9<span class="lnum">: </span>}</pre></div><style type="text/css">
.csharpcode, .csharpcode pre
{
font-size: small;
color: black;
font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
background-color: #ffffff;
/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
background-color: #f4f4f4;
width: 100%;
margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style><br />
<br />
Pretty simple.&nbsp; IncrementLockTime, as the name implies keeps track of how long the current thread has been attempting to acquire the lock.&nbsp; It returns a Disposer which takes an Action, which releases the lock.&nbsp; This allows us to take advantage of the <b>using</b> syntax, and avoid boiler plate try/finally (oh, and it avoids typos in Monitor.Exit).&nbsp; After some configurable amount of time, if the lock cannot be acquired within, say, 2 minutes, it’s probably a good probability your application is blocked somewhere.<br />
<br />
Now, using this class basically means replacing lock(_syncRoot) type code with _elock.Lock().&nbsp; Also, I believe it’s a good candidate for “mixing” into any other component.&nbsp; Mixins are sort of like multiple-inheritance, but not.&nbsp; I like to think of mixins as a “can do” rather than “is a.”<br />
<br />
Now, we know that C# doesn’t let you do multiple inheritance, but with libraries like Castle’s DynamicProxy2, it lets you do something very similar, and is extremely powerful.&nbsp; In a sense, it will automatically generate the following code for you:<br />
<br />
<div class="csharpcode"><br />
<pre class="alt"><span class="lnum">   1:  </span><span class="kwrd">public</span> <span class="kwrd">class</span> SomeService : ISomeService, IExtendedLock {</pre><pre><span class="lnum">   2:  </span>  IExtendedLock _lock = <span class="kwrd">new</span> ExtendedLock();</pre><pre class="alt"><span class="lnum">   3:  </span>  <span class="kwrd">public</span> <span class="kwrd">void</span> DoSomething() { }</pre><pre><span class="lnum">   4:  </span>  IDisposable IExtendedLock.Lock() { <span class="kwrd">return</span> _lock.Lock(); }</pre><pre class="alt"><span class="lnum">   5:  </span>}</pre><br />
</div><style type="text/css">
.csharpcode, .csharpcode pre
{
font-size: small;
color: black;
font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
background-color: #ffffff;
/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
background-color: #f4f4f4;
width: 100%;
margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style><style type="text/css">
.csharpcode, .csharpcode pre
{
font-size: small;
color: black;
font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
background-color: #ffffff;
/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
background-color: #f4f4f4;
width: 100%;
margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style><br />
<br />
_lock is a private instance variable, SomeService implements IExtendedLock, and simply redirects all the interface methods to _lock.&nbsp; This seems pretty simple and straightforward, but becomes tedious when the type you want to mix in has many methods (as my actual IExtendedLock is).<br />
<br />
With Windsor/DynamicProxy, you can do this automatically with minimal amount of code.&nbsp; For example, first you define something like this:<br />
<br />
<pre class="csharpcode"><span class="kwrd">public</span> <span class="kwrd">interface</span> ILockableDictionary : IDictionary, IExtendedLock { }</pre><br />
Then, you register it in the container:<br />
<div class="csharpcode"><br />
<pre class="alt"><span class="lnum">   1:  </span>var container = <span class="kwrd">new</span> WindsorContainer();</pre><pre><span class="lnum">   2:  </span>container.Register(Component.For(<span class="kwrd">typeof</span>(ILockableHashtable))</pre><pre class="alt"><span class="lnum">   3:  </span>                                   .LifeStyle.Transient</pre><pre><span class="lnum">   4:  </span>                                   .Activator&lt;LockableHashtableActivator&gt;());</pre></div><style type="text/css">
.csharpcode, .csharpcode pre
{
font-size: small;
color: black;
font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
background-color: #ffffff;
/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
background-color: #f4f4f4;
width: 100%;
margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style><br />
<br />
Now, whenever you need an instance of a lockable hashtable you can simply do something like this:<br />
<br />
<pre class="csharpcode">var hash = container.Resolve&lt;ILockableHashtable&gt;();
<span class="kwrd">using</span> (hash.Lock()) {
hash[<span class="str">"1"</span>] = 1;
}</pre><style type="text/css">
.csharpcode, .csharpcode pre
{
font-size: small;
color: black;
font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
background-color: #ffffff;
/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
background-color: #f4f4f4;
width: 100%;
margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style><br />
<br />
You might be wondering why it’s worth all this trouble, and what’s wrong with regular locks and Monitor.&nbsp; For our system it’s pretty critical that it stays running 24/7, and every minute it’s down is money lost, so it is in our best interest to detect any problematic condition.<br />
<br />
Last but not least, here’s the important code that actually generates the proxy:<br />
<div class="csharpcode"><br />
<pre class="alt"><span class="lnum">   1:  </span><span class="kwrd">internal</span> <span class="kwrd">class</span> LockableHashtableActivator : DefaultComponentActivator</pre><pre><span class="lnum">   2:  </span>{</pre><pre class="alt"><span class="lnum">   3:  </span>    <span class="kwrd">public</span> LockableHashtableActivator(ComponentModel model, IKernel kernel, ComponentInstanceDelegate onCreation, ComponentInstanceDelegate onDestruction)</pre><pre><span class="lnum">   4:  </span>        : <span class="kwrd">base</span>(model, kernel, onCreation, onDestruction)</pre><pre class="alt"><span class="lnum">   5:  </span>    {</pre><pre><span class="lnum">   6:  </span>    }</pre><pre class="alt"><span class="lnum">   7:  </span>&nbsp;</pre><pre><span class="lnum">   8:  </span>    <span class="kwrd">public</span> <span class="kwrd">override</span> <span class="kwrd">object</span> Create(CreationContext context)</pre><pre class="alt"><span class="lnum">   9:  </span>    {</pre><pre><span class="lnum">  10:  </span>        IExtendedLock lockMixin = Kernel.Resolve&lt;IExtendedLock&gt;();</pre><pre class="alt"><span class="lnum">  11:  </span>&nbsp;</pre><pre><span class="lnum">  12:  </span>        <span class="rem">// an additional object we want to "mix" with the implementation to provide combined functionality</span></pre><pre class="alt"><span class="lnum">  13:  </span>        ProxyGenerationOptions options = <span class="kwrd">new</span> ProxyGenerationOptions();</pre><pre><span class="lnum">  14:  </span>        options.AddMixinInstance(lockMixin);</pre><pre class="alt"><span class="lnum">  15:  </span>        </pre><pre><span class="lnum">  16:  </span>        <span class="kwrd">return</span> Kernel.Resolve&lt;ProxyGenerator&gt;().CreateInterfaceProxyWithTarget(</pre><pre class="alt"><span class="lnum">  17:  </span>            <span class="kwrd">typeof</span>(IDictionary), <span class="rem">// the interface of the implementation</span></pre><pre><span class="lnum">  18:  </span>            <span class="kwrd">new</span>[] { <span class="kwrd">typeof</span>(ILockableHashtable) }, <span class="rem">// additional interfaces to use</span></pre><pre class="alt"><span class="lnum">  19:  </span>            Activator.CreateInstance&lt;Hashtable&gt;(), <span class="rem">// concrete implementation to mix into</span></pre><pre><span class="lnum">  20:  </span>            options);</pre><pre class="alt"><span class="lnum">  21:  </span>    }</pre><pre><span class="lnum">  22:  </span>}</pre><br />
</div><style type="text/css">
.csharpcode, .csharpcode pre
{
font-size: small;
color: black;
font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
background-color: #ffffff;
/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
background-color: #f4f4f4;
width: 100%;
margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style><style type="text/css">
.csharpcode, .csharpcode pre
{
font-size: small;
color: black;
font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
background-color: #ffffff;
/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
background-color: #f4f4f4;
width: 100%;
margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style><br />
For those who are familiar with Windsor and wondering why I didn’t use the fluent Proxy.Mixins method, it’s because those mixins are created once per registration.&nbsp; In this case, it is very important that each mixin (which is an extended lock), is transient, otherwise every lockable hashtable ends up with the same extended lock, which is just asking for trouble.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Krzysztof Koźmic</div>
<div class='content'>
actually, with the trunk version the limitation &quot;one mixin per registration&quot; was lifted off. Now Mixins behave pretty much like interceptors, which means they can have any lifestyle, including being transient.</div>
</div>
</div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/10/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/8/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/16/emacs-as-my-evil-mode/">Emacs as my Leader: evil-mode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/09/vim-in-emacs-bootstrap/">Vim in Emacs Bootstrap</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/16/modularizing-vimscript/">Modularizing VimScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/30/1000-stars-in-1-month/">1000 stars in 1 month</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/21/smart-tab-expansions-in-vim-with-expression-mappings/">Smart tab expansions in Vim with expression mappings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/15/flight-of-an-open-source-project/">The flight of an open-source project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/02/unite-dot-vim-the-plugin-you-didnt-know-you-need/">Unite.vim, The plugin you didn&#8217;t know you need</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/on-typescript/">On TypeScript</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blingdev';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
