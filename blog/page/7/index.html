
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="As part of my demonstration for the NYC .NET Meetup in the next couple of days, I prepared some material to show how to use Mono.Cecil to manually &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io//blog/page/7">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/04/15/introducing-dependencypropertyweaver/">Introducing DependencyPropertyWeaver</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-15T00:00:00+00:00" pubdate data-updated="true">Apr 15<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>As part of my demonstration for the NYC .NET Meetup in the next couple of days, I prepared some material to show how to use Mono.Cecil to manually weave IL as a post-build step.&nbsp; It solves the problem of what I call “WPF Verbosity Hell”: the thing that makes your eyes bleed and makes God kill a kitten every time you declare a new property.</p> <p>Since <a href="http://code.google.com/p/notifypropertyweaver/">notifypropertyweaver</a> already exists, I figured I’d release the other side of the coin, dependencypropertyweaver.&nbsp; I just pushed my changes onto <a href="https://github.com/bling/dependencypropertyweaver">GitHub</a>.</p> <p>There are a couple of reasons to use dependency properties rather than regular properties with INotifyPropertyChanged.&nbsp; If you’re using WPF they make more sense because they perform faster and they give you a lot of extra bells and whistles for free.&nbsp; However, the INPC route tends to be more popular because it doesn’t bring in the dependency of WPF.</p> <p>IL post-build weaving solves the dependency problem because you can selectively choose to weave only the assemblies that get deployed with WPF, and you could even weave INPC into your service layer, and DPs into your client layer.&nbsp; That’s the power of post-build processes.</p> <p>While this little project initially started out as a simple demonstration of using <a href="http://www.mono-project.com/Cecil">Mono.Cecil</a> to perform low-level aspect oriented principles, it didn’t take much more work to tidy things up and make it ‘releasable’ into the wild, so I did just that, and open sourced it.</p> <p>The concept is simple.&nbsp; You take something like this:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> Student
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Name { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">        <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> Age { <span style="color: #0000ff">get</span>; <span style="color: #0000ff">set</span>; }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    }</pre></pre>
<style type="text/css">.csharpcode, .csharpcode pre
{
	font-size: small;
	color: black;
	font-family: consolas, &#8220;Courier New&#8221;, courier, monospace;
	background-color: #ffffff;
	/*white-space: pre;*/
}
.csharpcode pre { margin: 0em; }
.csharpcode .rem { color: #008000; }
.csharpcode .kwrd { color: #0000ff; }
.csharpcode .str { color: #006080; }
.csharpcode .op { color: #0000c0; }
.csharpcode .preproc { color: #cc6633; }
.csharpcode .asp { background-color: #ffff00; }
.csharpcode .html { color: #800000; }
.csharpcode .attr { color: #ff0000; }
.csharpcode .alt 
{
	background-color: #f4f4f4;
	width: 100%;
	margin: 0em;
}
.csharpcode .lnum { color: #606060; }
</style>

<p>And DependencyPropertyWeaver will turn it into this:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">         <span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> Student : DependencyObject
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">	{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">		<span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">readonly</span> DependencyProperty NameDependencyProperty = DependencyProperty.Register("<span style="color: #8b0000">Name</span>", <span style="color: #0000ff">typeof</span>(<span style="color: #0000ff">string</span>), <span style="color: #0000ff">typeof</span>(Student));
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">		<span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">readonly</span> DependencyProperty AgeDependencyProperty = DependencyProperty.Register("<span style="color: #8b0000">Age</span>", <span style="color: #0000ff">typeof</span>(<span style="color: #0000ff">int</span>), <span style="color: #0000ff">typeof</span>(Student));
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">		<span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> Name
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">		{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			[CompilerGenerated]
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			<span style="color: #0000ff">get</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">				<span style="color: #0000ff">return</span> (<span style="color: #0000ff">string</span>)<span style="color: #0000ff">base</span>.GetValue(Student.NameDependencyProperty);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			}
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			[CompilerGenerated]
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			<span style="color: #0000ff">set</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">				<span style="color: #0000ff">base</span>.SetValue(Student.NameDependencyProperty, <span style="color: #0000ff">value</span>);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			}
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">		}
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">		<span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> Age
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">		{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			[CompilerGenerated]
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			<span style="color: #0000ff">get</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">				<span style="color: #0000ff">return</span> (<span style="color: #0000ff">int</span>)<span style="color: #0000ff">base</span>.GetValue(Student.AgeDependencyProperty);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			}
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			[CompilerGenerated]
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			<span style="color: #0000ff">set</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">				<span style="color: #0000ff">base</span>.SetValue(Student.AgeDependencyProperty, <span style="color: #0000ff">value</span>);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">			}
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">		}
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">	}</pre></pre>
<p>Even though the class initially didn’t inherit from DependencyObject, the weaved version does.&nbsp; It will also continually go up the inheritance chain until it finds the abstract base class, and makes that inherit from DependencyObject.</p>
<p>Next on the list is obviously documentation (what open source project doesn’t need more documentation?!), however, I think I can slack off on this one since the core library is only 200-300 lines of code :-)</p>  </div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>bling</div>
<div class='content'>
Welcome to the world of C# :)  In C#, they are called attributes rather than annotations.  The MSBuild task has a property named AttributePatternMatch, which is a regular expression to match on the name of the attribute you want to use to determine whether to weave a property or not.<br /><br />Keep in mind that the code is highly experimental.  Hope that helps!</div>
</div>
<div class='comment'>
<div class='author'>campers</div>
<div class='content'>
Awesome, I&#39;ve just started working on my first c# job after 10 years of Java, so learning all this byte code manipulation again!  Would it be possible to use annotations to determine if a class and its properties should or shouldn&#39;t be processed to create the dependancy properties?</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/03/10/that-commenting-thing/">That Commenting Thing</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-03-10T00:00:00+00:00" pubdate data-updated="true">Mar 10<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>I’m working on a project right now that has near 99% of its code commented.&nbsp; Wow, that’s impressive!&nbsp; Actually, it’s more scary…even some of the private fields are commented….</p> <p>At one point, someone decided that it was a good idea to impose <em>some</em> kind of standard rather than none, so they recommended <a href="http://archive.msdn.microsoft.com/sourceanalysis">StyleCop</a> with all of its default settings, including requiring comments on everything.</p> <p>This seemed like a good idea, and it probably was, until someone found <a href="http://submain.com/products/ghostdoc.aspx">GhostDoc</a>.&nbsp; The plugin definitely gives off that “cool” factor the first time you use it.&nbsp; Wow, with a single key stroke it automagically documented all of my code!!!&nbsp; The problem, and it’s a pretty big one, is that it generates documentation based on the name of the properties, names, and class.&nbsp; Surely if it can do that, you, a much more sophisticated machine, can do that!</p> <p>Alas, the code base ended up getting GhostDocced to death all over the place to the point where I was driven mad and insane that I spent the time to write a VS2010 extension to purposely hide these comments.&nbsp; I’m talking about comments like this:</p> <p><a href="http://lh3.ggpht.com/_WZr-_wsEf1c/TXmZSvlTRnI/AAAAAAAAADQ/hk3vTlVJ5Jc/s1600-h/image%5B4%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_WZr-_wsEf1c/TXmZSurQc8I/AAAAAAAAADU/NCeYxDgaINc/image_thumb%5B2%5D.png?imgmax=800" width="505" height="156"></a></p> <p>The comments add absolutely <strong>no value</strong> and IMO <strong>makes it harder to read</strong>, and has the added deficit that if for whatever reason someone changes the name property, chances are they will forget to update the comments.&nbsp; It gets worse with WCF service contracts with many parameters.</p> <p>So yes, it frustrated me enough that I took some spare time to write an extension to shrink those damn XML comments to such a small size it doesn’t bother me anymore, like this:</p> <p><a href="http://lh4.ggpht.com/_WZr-_wsEf1c/TXmZS7pHAXI/AAAAAAAAADY/IV53KxtUWUQ/s1600-h/image%5B8%5D.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top: 0px; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/_WZr-_wsEf1c/TXmZTTUjF0I/AAAAAAAAADc/h96-4zUY6oM/image_thumb%5B4%5D.png?imgmax=800" width="566" height="200"></a></p> <p>You can grab the code off <a href="https://github.com/bling/XmlCommentShrink">GitHub</a>.</p>  </div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>bling</div>
<div class='content'>
Originally I tried to use code folding to solve the problem, but the best thing that comes built-in is collapsing to definitions (Ctrl+M/O), which will fold everything.  But that also folds the methods as well, so then I&#39;d have to manually unfold them, which quickly got tiresome.<br /><br />The optimal solution I think would be for the extension to automatically collapse only the comments when you open a file, but that is much more complex than just changing the font size&#8230;.maybe an exercise for another weekend when I&#39;m bored with nothing to do&#8230;</div>
</div>
<div class='comment'>
<div class='author'>Vsevolod Parfenov</div>
<div class='content'>
Why don&#39;t you fold them instead of changing font size?</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/11/auto-mocking-nsubstitute-with-castle/">Auto Mocking NSubstitute With Castle Windsor</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-11T00:00:00+00:00" pubdate data-updated="true">Dec 11<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>I was debating whether to make this blog post because it’s so damn simple to implement, but hey, if it saves someone else time, I did some good.</p> <p>First of all, register an ILazyComponentLoader into Windsor:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">var c = <span style="color: #0000ff">new</span> WindsorContainer();
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">c.Register(Component.For&lt;LazyComponentAutoMocker&gt;());</pre></pre>
<p>Then, the implementation of LazyComponentAutoMocker is simply this:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> LazyComponentAutoMocker : ILazyComponentLoader
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  <span style="color: #0000ff">public</span> IRegistration Load(<span style="color: #0000ff">string</span> key, Type service, IDictionary arguments)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">    <span style="color: #0000ff">return</span> Component.For(service).Instance(Substitute.For(<span style="color: #0000ff">new</span>[] { service }, <span style="color: #0000ff">null</span>));
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">}</pre></pre>
<p>And you’re done!&nbsp; Here’s a simple unit test example using <strong>only</strong> the code from above:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">[Test]
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> IDictionary_Add_Invoked()
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  var dict = c.Resolve&lt;IDictionary&gt;();
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  dict.Add(1, 1);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  dict.Received().Add(1, 1);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">}</pre></pre>
<p>That was almost too easy.</p>  </div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Randy</div>
<div class='content'>
For what it&#39;s worth, I found this helpful. I&#39;m new to Castle Windsor as well as NSubstitute. This post was able to get me going a lot quicker than sifting through documentation. Thanks.</div>
</div>
</div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/05/working-in-git-to-working-in-mercurial/">Working in Git to Working in Mercurial</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-05T00:00:00+00:00" pubdate data-updated="true">Dec 5<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>I took the dive a couple weeks ago and learned how to use Git and fell in love with its simplicity.&nbsp; I don’t know what it is, but after using Git every day it actually started to <em>make sense</em> that <strong>git checkout </strong>is used for so many things, which is ironic because prior to using Git, every introductory tutorial I’ve read has always had me thinking, “checkout does what and what and what now??”.</p> <p>So why did I switch to Mercurial?&nbsp; I need to push/pull from a Subversion repository, and I work on Windows.&nbsp; General day to day work is great, but when I needed to <strong>git svn rebase</strong> or <strong>git svn dcommit</strong> it would take so long that I simply left to get coffee.&nbsp; What’s worse, no matter what I set for core.autocrlf I would <em>always</em> get some weird whitespace merging error, when nothing was wrong.&nbsp; It became a regular part of my workflow to just <strong>git rebase –skip</strong> everything because that’s what fixed things.&nbsp; Scary.</p> <p>The crappy Subversion and whitespace support (at least in Windows) led me to try Mercurial.&nbsp; After getting accustomed to Mercurial, they’re actually a lot more similar than they are different.</p> <p>First things first, you need to add the following to your mercurial.ini file in your home directory:</p> <blockquote> <p>[bookmarks]<br>track.current = True</p></blockquote> <p>Here’s a comparison of my typical Git workflow translated to Mercurial:</p> <table border="1" cellspacing="0" cellpadding="2" width="600"> <tbody> <tr> <td valign="top" width="201">&nbsp;</td> <td valign="top" width="199"><strong>Git</strong></td> <td valign="top" width="198"><strong>Mercurial</strong></td></tr> <tr> <td valign="top" width="201">Work on a new feature/bug</td> <td valign="top" width="199">git checkout –b new_feature</td> <td valign="top" width="198">hg book new_feature</td></tr> <tr> <td valign="top" width="201">Hack hack hack</td> <td valign="top" width="199">git add .</td> <td valign="top" width="198">&nbsp;</td></tr> <tr> <td valign="top" width="201">Commit</td> <td valign="top" width="199">git commit –m “done!”</td> <td valign="top" width="198">hg commit –m “done!”</td></tr> <tr> <td valign="top" width="201">Hack more and commit</td> <td valign="top" width="199">git commit –a –m “more hacking”</td> <td valign="top" width="198">hg commit –m “more hacking”</td></tr> <tr> <td valign="top" width="201">Sync with up stream</td> <td valign="top" width="199">git pull master</td> <td valign="top" width="198">hg pull</td></tr> <tr> <td valign="top" width="201">Merge</td> <td valign="top" width="199">git checkout master</td> <td valign="top" width="198">hg merge new_feature</td></tr> <tr> <td valign="top" width="201">&nbsp;</td> <td valign="top" width="199">git merge new_feature</td> <td valign="top" width="198">hg commit –m “merged”</td></tr> <tr> <td valign="top" width="201">Push</td> <td valign="top" width="199">git push</td> <td valign="top" width="198">hg push</td></tr></tbody></table> <p>Notice that they’re practically exactly the same?&nbsp; There are some minor differences.&nbsp; The obvious one being that you need to add into git’s index before committing.&nbsp; And the other I didn’t have to switch branches in Mercurial (more on that later).&nbsp; But aside from that, it’s pretty much the same, <strong>from a user’s point of view</strong>.&nbsp; Check this fantastic <a href="http://stackoverflow.com/questions/1598759/git-and-mercurial-compare-and-contrast">thread</a> on StackOverflow for one of the best comparisons on the net if you want to dive into technical details.</p> <p>So far, there are only two things that bother me having switched:<br>&nbsp; a) No fast-forward merge.&nbsp; You need to manually rebase and then commit.<br>&nbsp; b) No automatic commit after a conflict free merge.</p> <p>These are fairly minor annoyances, but can be scripted/aliased away.&nbsp; Or if you don’t like those defaults in Git, you can override them in the command arguments or set them in gitconfig.&nbsp; Mercurial similarly can change default arguments in its hgrc/mercurial.ini.</p> <p>One of the biggest advantages of Git is easily switching between all its local lightweight branches at lightning speed.&nbsp; Tangled source code is no more!&nbsp; I was confused with Mercurial’s bookmarks when I first used them because all it does is label your head with something.&nbsp; I don’t know why this is, but it is the same as <strong>git checkout –b</strong>, but for some reason I visualized Git “branching” the latest commit into two paths.&nbsp; But how do you do that if they’re the same?&nbsp; It should only branch <em>after</em> a commit which introduces changes, which is what Mercurial does.&nbsp; In this scenario, Mercurial is more explicit, whereas Git is implicit.</p> <p>Using bookmarks, you can mimic Git’s workflow like this:</p> <table border="1" cellspacing="0" cellpadding="2" width="594"> <tbody> <tr> <td valign="top" width="209">&nbsp;</td> <td valign="top" width="192"><strong>Git</strong></td> <td valign="top" width="191"><strong>Mercurial</strong></td></tr> <tr> <td valign="top" width="212">Create a bunch of ‘working areas’</td> <td valign="top" width="190">git branch feature1</td> <td valign="top" width="189">hg book feature1</td></tr> <tr> <td valign="top" width="214">&nbsp;</td> <td valign="top" width="190">git branch feature2</td> <td valign="top" width="189">hg book feature2</td></tr> <tr> <td valign="top" width="216">Switch/commit/hack/commit</td> <td valign="top" width="189">git checkout feature1</td> <td valign="top" width="188">hg up feature1</td></tr> <tr> <td valign="top" width="217">&nbsp;</td> <td valign="top" width="189">git commit –a –m “feature1”</td> <td valign="top" width="188">hg commit –m “feature1”</td></tr> <tr> <td valign="top" width="218">&nbsp;</td> <td valign="top" width="188">git checkout feature2</td> <td valign="top" width="187">hg up feature2</td></tr> <tr> <td valign="top" width="219">&nbsp;</td> <td valign="top" width="188">git commit –a –m “feature1”</td> <td valign="top" width="187">hg commit –m “feature2”</td></tr> <tr> <td valign="top" width="219">Sync up stream</td> <td valign="top" width="188">git pull master</td> <td valign="top" width="187">hg pull</td></tr> <tr> <td valign="top" width="219">&nbsp;</td> <td valign="top" width="188">git checkout master</td> <td valign="top" width="187">hg up default</td></tr> <tr> <td valign="top" width="219">Merge in 1 feature</td> <td valign="top" width="188">git merge feature1</td> <td valign="top" width="187">hg merge feature1</td></tr> <tr> <td valign="top" width="219">&nbsp;</td> <td valign="top" width="188">&nbsp;</td> <td valign="top" width="187">hg commit –m “merged”</td></tr> <tr> <td valign="top" width="219">Delete branch/bookmark</td> <td valign="top" width="188">git branch –d feature1</td> <td valign="top" width="187">hg book –d feature1</td></tr> <tr> <td valign="top" width="219">Push</td> <td valign="top" width="188">git push</td> <td valign="top" width="187">hg push –r tip</td></tr> <tr> <td valign="top" width="219">Switch back and hack again</td> <td valign="top" width="188">git checkout feature2</td> <td valign="top" width="188">hg up feature2</td></tr></tbody></table> <p>The <strong>–r tip</strong> switch on hg push might have raised an eyebrow.&nbsp; This is to tell Mercurial to push all changes that lead to the tip.&nbsp; This will include the changes in <em>feature1</em> that we just merged in, but exclude all the ones in <em>feature2</em>.&nbsp; If you issue a <strong>hg push</strong> it will complain and warn you that you’re going to create multiple heads on the remote repository.&nbsp; This is not what you want since there may be unfinished features, experimental branches, etc.&nbsp; Of course, you can force it anyways, but that’s not a good idea.</p> <p>At first, the tip was most confusing to me because I tried to associate it with Git’s master, which was simply not the case.&nbsp; Tip refers to the newest change that you know about.&nbsp; This can be on any branch or bookmark.&nbsp; Once I understood that, and <strong>stopped trying to create a Git master</strong> equivalent, everything was straightforward.</p> <p>So let’s start with an example.&nbsp; First I create a bookmark <em>feature1</em> after syncing, and then making a commit looks like this: </p> <p><a href="http://lh3.ggpht.com/_WZr-_wsEf1c/TPwPhlbcWDI/AAAAAAAAACo/3_P3Zvqu1pM/s1600-h/image%5B2%5D.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh6.ggpht.com/_WZr-_wsEf1c/TPwPiMwJxgI/AAAAAAAAACs/DmZxxuMAb2k/image_thumb.png?imgmax=800" width="238" height="101"></a></p> <p>And then if you switch to <em>feature2</em> and make a commit, it becomes like this:</p> <p><a href="http://lh3.ggpht.com/_WZr-_wsEf1c/TPwPiUVV5WI/AAAAAAAAACw/9lf6dwKGApg/s1600-h/image%5B5%5D.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_WZr-_wsEf1c/TPwPi48MmdI/AAAAAAAAAC0/cC_c0bvyvis/image_thumb%5B1%5D.png?imgmax=800" width="243" height="124"></a></p> <p>Here’s where you start thinking, “I don’t have a master which tracks upstream changes, how do I separate my local changes?”&nbsp; And now here’s a situation where Mercurial does more black magic than Git.&nbsp; If there are up stream changes, after issuing <strong>hg pull</strong>, this happens:</p> <p><a href="http://lh5.ggpht.com/_WZr-_wsEf1c/TPwPjPEMdfI/AAAAAAAAAC4/f2d3b4qfeCE/s1600-h/image%5B8%5D.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh4.ggpht.com/_WZr-_wsEf1c/TPwPjRxmonI/AAAAAAAAAC8/IrEz8ig5Zo0/image_thumb%5B2%5D.png?imgmax=800" width="244" height="144"></a></p> <p>Mercurial automatically split my local changes into their own separate branches (actually, <em>heads</em> is the accurate term).&nbsp; After this operation, <strong>tip</strong> is now tracking the changes that I just pulled in from upstream, instead of my bookmark.</p> <p>From here, it’s simply <strong>hg up tip</strong> to switch to the “master” branch.&nbsp; Then a <strong>hg merge feature1; hg commit</strong>, and it becomes like this:</p> <p><a href="http://lh4.ggpht.com/_WZr-_wsEf1c/TPwPjoJRV0I/AAAAAAAAADA/PEV6bis7pJg/s1600-h/image%5B11%5D.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://lh3.ggpht.com/_WZr-_wsEf1c/TPwPkIS-mgI/AAAAAAAAADE/labU8QL9AKQ/image_thumb%5B3%5D.png?imgmax=800" width="244" height="168"></a></p> <p>Then it’s simply <strong>hg push –r tip</strong>, and you’re good to go.&nbsp; Basically, if you bookmark every feature/bug you work on, then you should only have one branch that doesn’t have a bookmark, which is the same as the ‘master’ branch from Git.</p> <h4>What about Subversion?</h4> <p>Whoops, forgot why I switched in the first place.&nbsp; First, install <a href="http://bitbucket.org/durin42/hgsubversion/wiki/Home">hgsubversion</a>, after that’s set up, simply:</p> <p>hg clone <a href="http://path/to/subversion/repository">http://path/to/subversion/repository</a></p> <p>And then it’s just <strong>hg pull</strong> or <strong>hg push</strong>.&nbsp; Is it really that simple?&nbsp; Yes, yes it is.</p>  </div>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/12/04/cqrs-building-transactional-event-store/">CQRS: Building a “Transactional” Event Store With MongoDB</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-12-04T00:00:00+00:00" pubdate data-updated="true">Dec 4<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><div class='post'>
<p>As you all already know if you’re familiar with MongoDB, is that it does not support transactions.&nbsp; The closest thing we have is atomic modifications of a single document.</p> <p>The Event Store in a CQRS architecture has the important responsibility of detecting concurrency violations, where two different sources try to update the same version of the aggregate.&nbsp; The one that gets it late should be denied changes into the store with an exception thrown.&nbsp; This ensures the integrity of the data.</p> <p>Here is a very simple typical implementation of appending events into the event store:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Append(Guid id, <span style="color: #0000ff">long</span> expectedVersion, IEnumerable&lt;IEvent&gt; events)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; <span style="color: #0000ff">try</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp;&nbsp;&nbsp; _events.Insert(events.Select(x =&gt; ...)); <span style="color: #008000">// convert to storage type</span>
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; <span style="color: #0000ff">catch</span> (...)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; <span style="color: #0000ff">&nbsp; if</span> (E11000 duplicate key)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; <span style="color: #0000ff">&nbsp;&nbsp;&nbsp; throw</span> <span style="color: #0000ff">new</span> ConcurrencyException(...);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">}</pre></pre>
<p>Syntax is a mix of C#/pseudo code, but the basic concepts are the same.&nbsp; This assumes that you’ve set up an multi-index on the collection between the ID and the version.&nbsp; Thus, when you insert something that already has a matching ID/version, Mongo will tell you of a duplicate key violation, and all is good.</p>
<p>But wait!&nbsp; Operations are atomic per document!&nbsp; So what happens if you append 100 events, and it fails on the 43rd one?&nbsp; Events 1 through 42 will continue to exist in the data store, which is bad news.</p>
<p>Obviously, this solution is not going to work.&nbsp; The next step was to do something like this:</p><pre style="border-bottom: #cecece 1px solid; border-left: #cecece 1px solid; padding-bottom: 5px; background-color: #fbfbfb; min-height: 40px; padding-left: 5px; width: 650px; padding-right: 5px; overflow: auto; border-top: #cecece 1px solid; border-right: #cecece 1px solid; padding-top: 5px"><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">catch</span> (...)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">{
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&nbsp; if</span> (E11000 duplicate keys)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; {
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&nbsp;&nbsp;&nbsp; foreach</span> (var e <span style="color: #0000ff">in</span> events)
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _events.Delete(<span style="color: #0000ff">new</span> { _id = e._id });
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp;</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"><span style="color: #0000ff">&nbsp;&nbsp;&nbsp; throw</span> <span style="color: #0000ff">new</span> ConcurrencyException(...);
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">&nbsp; }
</pre><pre style="background-color: #fbfbfb; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">}</pre></pre>
<p>So, before inserting into the collection, each events gets a generated ObjectID, so that if it fails, the catch exception can simply tell the data store to delete everything.</p>
<p>At first glance this seems to fix everything, except for one glaring problem.&nbsp; What happens if you lose connection to the database before, or midway sending the deletes?&nbsp; Now you have a problem of <strong>ensuring</strong> that those deletes are guaranteed, and so then the question that arises from that is <strong>where</strong> would you store it?&nbsp; A local file?&nbsp; Another database?&nbsp; The problem is, at that moment, if another process in the system queries all events for the same aggregate it will return invalid data.</p>
<p>So, we’re back to square one.&nbsp; We need to simulate a transaction through a single insert.</p>
<p>The secret is in the schema design.&nbsp; Initially, we started out with a straight forward row-per-event schema.&nbsp; But since we’re operating with <em>documents</em>, we can model it as a <em>batch</em> of events.</p>
<p>Thus, instead of versioning every event individually, we version a batch of events.&nbsp; For example, originally we would insert 3 events, and the data saved would look like this:</p>
<blockquote>
<p>{ _id = 1, aggregate_id = 1, version = 1, event = { … } }<br>{ _id = 2, aggregate_id = 1, version = 2, event = { … } }<br>{ _id = 3, aggregate_id = 1, version = 3, event = { … } }</p></blockquote>
<p>In the new schema, it would look like this:</p>
<blockquote>
<p>{ _id = 1, aggregate_id = 1, version = 1, <strong>events</strong> = [ { … }, { … }, { … }, { … } ] }</p></blockquote>
<p>Now, a downside to this approach is you lose a bit of granularity of stored events, since you are grouping multiple events under a single version.&nbsp; However, I don’t see this as a huge loss since the main reason you want to use event sourcing in the first place is to be able to restore an aggregate to any state in its history, and we still retain that functionality.</p>
<p>In our case, this is working very well for us.&nbsp; When a command gets handled, it generates a bunch of events that get applied and then saved to MongoDB.&nbsp; I can’t think of any scenario where it’d want to replay to the middle of a half-processed command (but of course it’s possible anyways, just reply half of a batch of events).&nbsp; But that’s just asking for trouble.&nbsp; It’s most likely easier to just the re-process the command.</p>
<p>Now, you may be asking why go through the trouble of batching events when you can just store one document per aggregate, and then put all events in one document?&nbsp; Yes, that would solve the problem very effectively…until you hit the 4MB per document limit ;-)</p>  </div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Bailey Ling</div>
<div class='content'>
It wouldn&#39;t be any different from processing a new command.  You will need to load all snapshots/events to get the aggregate root to the latest version.  Events should typically be &quot;fire and forget&quot;.  If you require them to be guaranteed delivery it&#39;s better to restructure them as commands.</div>
</div>
<div class='comment'>
<div class='author'>bodrin</div>
<div class='content'>
Nice, thanks for answering :)<br />I should definitely take a closer look at the MongoDB! Sounds very interesting :)<br /><br />On the other hand I&#39;m still wondering if there is a general approach for this situation - you have done a state transition into the KV/doc DB and you have some events there. Then your system goes down just before it publishes these events on to the wire (some external messaging system). Then when you start again is there an efficient way/query to be done against the KV/doc DB so that you get all the events that haven&#39;t been dispatched yet?</div>
</div>
<div class='comment'>
<div class='author'>Bailey Ling</div>
<div class='content'>
Well, the easiest way is to cheat and use Mongo as your messaging bus ;-)  There&#39;s a bunch of examples on the web.  Basically, you create a direct connection against the database and read the oplog.  This is the mechanism that Mongo uses to do replication, so you get near real-time performance.  Since it&#39;s only one system to manage, rather than two in concert, it&#39;s a bit easier to maintain.  You&#39;ll get the same guarantees as any other write to a Mongo node.<br /><br />If you must go to another messaging system it&#39;ll depend on the guarantees of that implementation.  It&#39;s not the end of the world to tell the user to &quot;try again later&quot;, assuming that&#39;s acceptable for the 0.01% of the time.<br /><br />Also, if the messaging system is down, you can still read from the event store to get the latest information (and is required for stale nodes joining the system).</div>
</div>
<div class='comment'>
<div class='author'>bodrin</div>
<div class='content'>
Hi, I want to ask how do you dispatch the events. I guess the flow is somthing like this:<br /><br />1. receive a command<br />2. load the related AR and process the command which produces some events - a batch<br />3. store the event batch in MongoDB, e.g. at <br />{ &quot;_id&quot;: { &quot;aggregate&quot;: 1234, &quot;version&quot;: 65 } }<br />4. dispatch the events to some messaging system<br />5. mark the { &quot;_id&quot;: { &quot;aggregate&quot;: 1234, &quot;version&quot;: 65 } } as dispatched<br /><br />So if this is similar to what you are doing I&#39;m wondering what if the system goes down just after step 3. ?<br />The events are not dispatched, but how do you find that after restart? Is there an efficient way with MongoDb and/or with other documen / KV stores?</div>
</div>
<div class='comment'>
<div class='author'>bling</div>
<div class='content'>
Thanks for the comments!<br /><br />You are absolutely right in all of your points.<br /><br />Actually, each individual event in my system is meaningless unless it is part of a batch.  The batch is the only thing that is versioned, and the batch version is required to save or get events from the store.<br /><br />As for duplicate handling, since I wrote the post I implemented _id as a complex object like this:<br /><br />{ &quot;_id&quot;: { &quot;aggregate&quot;: 1234, &quot;version&quot;: 65 } }<br /><br />_id is always indexed, and unique.  If version 66 already exists, the 2nd command handler will simply fail, and the event store will continue to have good, consistent data.</div>
</div>
<div class='comment'>
<div class='author'>Jonathan Oliver</div>
<div class='content'>
Awesome post.  <br /><br />When I started writing version 2.0 of my EventStore library, I wanted to ensure that NoSQL databases such as MongoDB could be handled.  Pushing everything up as a single batch is critical.<br /><br />Here is the implementation for Mongo:<br />https://github.com/joliver/EventStore/tree/master/src/proj/EventStore.Persistence.MongoPersistence<br /><br />Here is the design guide:<br />http://jonathan-oliver.blogspot.com/2010/12/cqrs-eventstore-v2-architectural.html<br /><br />There are three quick things I wanted to mention regarding your implementation.  First, because you&#39;re now pushing things up as a batch, you can no longer use the event version as an optimistic control technique.  Instead, you&#39;ll want to number each batch that you push using a sequential, incrementing value.<br /><br />Lastly, if you only push the event information, you may lose some context because there is oftentimes metadata associated with all of the events that you&#39;ll want to store.<br /><br />You&#39;ll also want to consider what happens when a message is processed more than once which causes a batch to be written.  NoSQL doesn&#39;t provide any guarantees related to de-duplication so you&#39;ll need to handle that in your application code/event store code.</div>
</div>
</div>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/8/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/6/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/07/30/1000-stars-in-1-month/">1000 stars in 1 month</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/21/smart-tab-expansions-in-vim-with-expression-mappings/">Smart tab expansions in Vim with expression mappings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/15/flight-of-an-open-source-project/">The flight of an open-source project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/02/unite-dot-vim-the-plugin-you-didnt-know-you-need/">Unite.vim, The plugin you didn&#8217;t know you need</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/on-typescript/">On TypeScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/13/dot-net-slash-wpf-to-html-slash-css-slash-javscript/">.NET/WPF to HTML/CSS/Javscript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/10/jumping-on-the-hacker-blog-bandwagon/">Jumping on the hacker blog bandwagon</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/11/writing-macros-with-vim/">Writing Macros with Vim</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blingdev';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
