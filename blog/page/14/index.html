
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="One of my time-wasting hobbies is running Linux on virtual machines. I play games from time to time so Windows is still my main OS. But otherwise, I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io/blog/page/14">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/05/05/im-doing-vim-challenge/">I&#8217;m Doing the VI Challenge!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-05T00:00:00-04:00" pubdate data-updated="true">May 5<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of my time-wasting hobbies is running Linux on virtual machines.  I play games from time to time so Windows is still my main OS.  But otherwise, I do use my Linux virtual machines for many things like my personal <a href="http://www.selenic.com/mercurial">Mercurial</a> repository is running on <a href="http://www.virtualbox.org">VirtualBox</a>.  For the curious, my distro of choice is <a href="http://www.archlinux.org">Archlinux</a>.</p>

<p>Anyone who&rsquo;s needed to tinker with a Linux distro knows that you spend a lot of time in a text editor changing configuration files.  Typically, the choices are pico/nano for its simplicity, or vi because it&rsquo;s on any POSIX compliant operating system.  I decided, ah what the heck, I&rsquo;m gonna learn vi and use that for editing files instead of nano.</p>

<p>I got decent with vi.  I could move around (albeit I still relied on home/end and arrow keys), save, search, etc., but on Windows I&rsquo;d still use <a href="http://www.flos-freeware.ch/notepad2.html">Notepad2</a>.</p>

<p>In an attempt to improve my productivity in text editing, I&rsquo;m doing the VIM challenge!  All my text editing I will be using <a href="http://www.winvi.de/en">WinVI</a> (I even replaced the notepad.exe with it), and I even got the demo of <a href="http://www.viemu.com">ViEmu</a> running on Visual Studio.  For the next 2 weeks I will be using vi for anything text related.  I&rsquo;ve been going through tutorials and trying to remember all the new things I&rsquo;m learning.  Most importantly, I&rsquo;ll be trying to avoid the home/end/arrow keys as well.</p>

<p>BTW, <code>*</code> is an awesome feature in vi.  It highlights all instances of the current word in the document, and subsequently you can use n or N to back or to the next instance.  Like, take a look at the following screen shot:</p>

<p><img src="http://imgur.com/2cq4b.png" alt="screenshot" /></p>

<p>Boom!  All instances of &ldquo;total&rdquo; highlighted with just a Shift+8.  Let&rsquo;s see you do the same thing with Ctrl+F, mouse-click &ldquo;Find next&rdquo; (or worse, reverse your search).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/04/28/trick-question-with-closures/">A Trick Question With Closures</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-28T00:00:00-04:00" pubdate data-updated="true">Apr 28<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Given the following code, what do you expect the output to be?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">delegate</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Keep that answer in your head!  Now&hellip;what do you expect the output of the following?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">100</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">delegate</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Were your answers the same?  Different?  Why?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/04/27/simple-thread-pool-implementation-2/">A Simple Thread Pool Implementation (Part 2)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-27T00:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I said last time I&rsquo;d compare the performance of my super duper simple implementation against the .NET ThreadPool, so here it is!</p>

<p>Here&rsquo;s the test code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ManualResetEvent</span> <span class="n">evt</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ManualResetEvent</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
</span><span class='line'><span class="kt">int</span> <span class="n">total</span> <span class="p">=</span> <span class="m">100000</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">count</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'><span class="n">DateTime</span> <span class="n">start</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">total</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1">//  ThreadQueue.QueueUserWorkItem(delegate(object obj)</span>
</span><span class='line'>    <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">delegate</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">count</span><span class="p">)</span> <span class="p">==</span> <span class="n">total</span><span class="p">)</span>
</span><span class='line'>            <span class="n">evt</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span><span class='line'>    <span class="p">},</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">evt</span><span class="p">.</span><span class="n">WaitOne</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Time: {0}ms&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span> <span class="p">-</span> <span class="n">start</span><span class="p">).</span><span class="n">TotalMilliseconds</span><span class="p">);</span>
</span><span class='line'><span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are the initial tests.  My CPU is a Core2Duo clocked at 3.6GHz.  I also ran a release build outside of the debugger.  I set my ThreadQueue to have 25 worker threads.  The results were pretty surprising:
&ndash; ThreadPool: 1515.6444ms
&ndash; ThreadQueue: 5093.8152ms</p>

<p>Well, that&rsquo;s interesting.  The .NET ThreadPool whooped my butt!  How can that be?  Let&rsquo;s dig deeper and find out how many threads actually got used.  I used <code>ThreadPool.GetMinThreads</code> and <code>ThreadPool.GetMaxThreads</code>, and I got 2-500 for worker threads, and 2-1000 for completion IO threads.</p>

<p>Then, I tracked how many threads were actually used, like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">threads</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;();</span>
</span><span class='line'><span class="c1">// ...snip</span>
</span><span class='line'>    <span class="n">ThreadPool</span><span class="p">.</span><span class="n">QueueUserWorkItem</span><span class="p">(</span><span class="k">delegate</span><span class="p">(</span><span class="kt">object</span> <span class="n">obj</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class='line'>        <span class="n">threads</span><span class="p">[</span><span class="n">Thread</span><span class="p">.</span><span class="n">CurrentThread</span><span class="p">.</span><span class="n">ManagedThreadId</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">count</span><span class="p">)</span> <span class="p">==</span> <span class="n">total</span><span class="p">)</span>
</span><span class='line'>            <span class="n">evt</span><span class="p">.</span><span class="n">Set</span><span class="p">();</span>
</span><span class='line'>    <span class="p">},</span> <span class="n">i</span><span class="p">);</span>
</span><span class='line'><span class="c1">// ...snip</span>
</span><span class='line'><span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;Threads used: {0}&quot;</span><span class="p">,</span> <span class="n">threads</span><span class="p">.</span><span class="n">Count</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Surprisingly, only 2 threads were used.  So, I set the number of worker threads of my ThreadQueue to 2.  Viola!  1437.5184ms, which is just a little under 100ms faster than the ThreadPool.</p>

<p><em>I guess this shows that more threads does not mean better or faster!</em></p>

<p>For fun I set the number of worker threads to 200 and it took 27906.6072ms!  There was clearly a lot of locking overhead here&hellip;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/04/27/simple-thread-pool-implementation-1/">A Simple Thread Pool Implementation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-27T00:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve always wanted to do this, and finally I&rsquo;ve gotten around to doing it.  Here&rsquo;s a super duper simple implementation of a working thread pool.  I named in ThreadQueue just so it&rsquo;s clearly discernible from the one provided by the framework.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ThreadQueue</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">WorkItem</span><span class="p">&gt;</span> <span class="n">_queue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">WorkItem</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="nc">WorkItem</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">public</span> <span class="n">WaitCallback</span> <span class="n">Worker</span><span class="p">;</span>
</span><span class='line'>        <span class="k">public</span> <span class="kt">object</span> <span class="n">State</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="nf">ThreadQueue</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">25</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadWorker</span><span class="p">);</span>
</span><span class='line'>            <span class="n">t</span><span class="p">.</span><span class="n">IsBackground</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>            <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="k">void</span> <span class="nf">ThreadWorker</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">WorkItem</span> <span class="n">wi</span><span class="p">;</span>
</span><span class='line'>            <span class="k">lock</span> <span class="p">(</span><span class="n">_queue</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">while</span> <span class="p">(</span><span class="n">_queue</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="n">Monitor</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">_queue</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">wi</span> <span class="p">=</span> <span class="n">_queue</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">wi</span><span class="p">.</span><span class="n">Worker</span><span class="p">(</span><span class="n">wi</span><span class="p">.</span><span class="n">State</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">QueueUserWorkItem</span><span class="p">(</span><span class="n">WaitCallback</span> <span class="n">callBack</span><span class="p">,</span> <span class="kt">object</span> <span class="n">state</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">WorkItem</span> <span class="n">wi</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WorkItem</span><span class="p">();</span>
</span><span class='line'>        <span class="n">wi</span><span class="p">.</span><span class="n">Worker</span> <span class="p">=</span> <span class="n">callBack</span><span class="p">;</span>
</span><span class='line'>        <span class="n">wi</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="n">_queue</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">_queue</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">wi</span><span class="p">);</span>
</span><span class='line'>            <span class="n">Monitor</span><span class="p">.</span><span class="n">Pulse</span><span class="p">(</span><span class="n">_queue</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, it&rsquo;s very short and very simple.  Basically, if it&rsquo;s not used, no threads are started, so in a sense it is lazy.  When you use it for the first time, the static initializer will start up 25 threads, and put them all into waiting state (because the queue will initially be empty).  When something needs to be done, it is added to the queue, and then it pulses a waiting thread to perform some work.</p>

<p>And just to warn you, if the worker delegate throws an exception it will crash the pool&hellip;.so if you want to avoid that you will need to wrap the wi.Worker(wi.State) with a try/catch.</p>

<p>I guess at this point you may wonder why one should even bother writing a thread pool.  For one, it&rsquo;s a great exercise and will probably strengthen your understanding of how to write multithreaded applications.  The above thread pool is probably one of the simplest use-cases for Monitor.Pulse and Monitor.Wait, which are crucial for writing high-performance threaded applications.</p>

<p>Another reason is that the .NET ThreadPool is optimized for many quick ending tasks.  All asynchronous operations are done with the ThreadPool (think BeginInvoke, EndInvoke, BeginRead, EndRead, etc.).  It is not well-suited for any operation that takes a long time to complete.  MSDN recommends that you use a full-blown thread to do that.  Unfortunately, there&rsquo;s a relatively big cost of creating threads, which is why we have thread pools in the first place!  Hence, to solve this problem, we can write our own thread pool which contains some alive and waiting threads to performing longer operations, without clogging the .NET ThreadPool.</p>

<p>In my next post I&rsquo;ll compare the above implementation&rsquo;s performance against the built-in ThreadPool.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2009/04/25/sourcegear-vault-part-4/">SourceGear Vault, Part 4, Conclusion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-25T00:00:00-04:00" pubdate data-updated="true">Apr 25<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I suppose I should give a disclaimer since I am <em>not</em> an expert with Vault, and my opinions may be completely due to my lack of understanding of the system.  With that in mind, here&rsquo;s what my experience of using Vault has been so far.</p>

<p>In general, it is not as fast as TortoiseSVN.  There are many operations in SVN that are instant, where the comparable operation in Vault is met with 10 seconds of &ldquo;beginning transaction&rdquo; and &ldquo;ending transaction&rdquo;, sometimes more.</p>

<p>Feature-wise, Vault has much more to offer than Subversion does.  Basically, it can do most of what Subversion can do, plus features from SourceSafe (like sharing, pinning, labeling, etc.).  However, like I mentioned before, Vault has no offline support whatsoever, and you cannot generate patches, so it effectively cuts off any kind of outside collaboration.</p>

<p>You could say that this is fine because SourceGear&rsquo;s target audience is small organizations where everyone will have access to the network anyway, but that doesn&rsquo;t mean that you won&rsquo;t be sent off to the middle of nowhere with no internet access and you need to fix bugs now!  Not to say that Subversion is much better in that scenario, but at least you can still revert back to the last updated version.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/15/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/13/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/16/emacs-as-my-leader-evil-mode/">Emacs as my Leader: evil-mode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/09/vim-in-emacs-bootstrap/">Vim in Emacs Bootstrap</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/16/modularizing-vimscript/">Modularizing VimScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/30/1000-stars-in-1-month/">1000 stars in 1 month</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/21/smart-tab-expansions-in-vim-with-expression-mappings/">Smart tab expansions in Vim with expression mappings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/15/flight-of-an-open-source-project/">The flight of an open-source project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/02/unite-dot-vim-the-plugin-you-didnt-know-you-need/">Unite.vim, The plugin you didn&#8217;t know you need</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/on-typescript/">On TypeScript</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blingdev';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
