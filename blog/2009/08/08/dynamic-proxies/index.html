
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dynamic proxies - bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="Life has sure been a roller coaster lately ever since I started working on my new project. I&#8217;ve learned a lot about WCF in the past week. There &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io//blog/2009/08/08/dynamic-proxies">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Dynamic Proxies</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-08-08T00:00:00+00:00" pubdate data-updated="true">Aug 8<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content">Life has sure been a roller coaster lately ever since I started working on my new project.  I&#8217;ve learned a lot about WCF in the past week.  There&#8217;s really nothing that can teach you faster than trying something out yourself.

I&#8217;ve joined the ranks of countless others who have had to deal with implementing service behaviors to handle WCF exceptions (because by default thrown exceptions fault the communication channel), realized that WCF proxy clients breaks the &#8216;using&#8217; keyword because someone thought it was a good idea to throw exceptions in Dispose(), and even Unity&#8217;s InterfaceInterceptor not <a href="http://unity.codeplex.com/WorkItem/View.aspx?WorkItemId=3685">supporting more than 1 interface</a>!

But now that we&#8217;re talking about proxies, I&#8217;ve been thinking for a while about switching out Unity with a more mature IoC container like Windsor or StructureMap.  There are little touches that other containers have that I miss in Unity.  For example, auto-wiring.

But then again, the integration that Unity has with the rest of the Enterprise Library is very nice, of which I&#8217;m using the Logging and Exception Policy blocks, so it made sense in a way that everything in my bin folder just had Microsoft.Practices.*.dll

But now I&#8217;m seriously reconsidering.
<pre>
public interface ITestService {
  int Count { get; set; }
  void DoWork();
  bool ShouldDoWork();
}
public class TestService : ITestService {
  public int Count { get; set; }
  public void DoWork() { ++Count; }
  bool ShouldDoWork() { return true; }
}
public void HowDoTheyCompare() {
  var unity = (ITestService)new Microsoft.Practices.Unity.InterceptionExtension.InterfaceInterceptor()
                   .CreateProxy(typeof(ITestService), new TestService());
  var castle = new Castle.DynamicProxy.ProxyGenerator()
                   .CreateInterfaceProxyWithTarget&lt;ITestService&gt;(new TestService());

  Thread.Sleep(1000);

  Stopwatch sw = new Stopwatch();
  sw.Start();
  for (int i = 0; i < 1000000; ++i) { if (unity.ShouldDoWork()) unity.DoWork(); }
  sw.Stop();
  Console.WriteLine("unity: " + sw.ElapsedMilliseconds);
  sw.Reset();
  sw.Start();
  for (int i = 0; i < 1000000; ++i) { if (castle.ShouldDoWork()) castle.DoWork(); }
  sw.Stop();
  Console.WriteLine("castle: " + sw.ElapsedMilliseconds);
}
</pre>
Results?
unity: 1787
castle: 136

From this test it looks like the Unity interception is 13x slower&#8230;.but wait!  I mentioned before that Unity has a bug where it can only proxy one interface&#8230;.so to resolve that we would need to use the TransparentProxyInterceptor.

Let&#8217;s change it and test again&#8230;

unity: 30462
castle: 142

Hmmmm&#8230;.214x slower.

I guess we can try the VirtualMethodInterceptor for completeness.  After making all methods virtual, here&#8217;s the results.

unity: 3843
castle: 132

Still 29x slower.

Whatever DynamicProxy is doing&#8230;it&#8217;s orders of magnitude faster than what Unity&#8217;s doing.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Krzysztof Ko≈∫mic (2)</div>
<div class='content'>
Not only that. Castle has integration with logging, validation framework, much more mature and powerful IoC container, and also nice proxy library.</div>
</div>
</div>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bailey Ling</span></span>

      








  


<time datetime="2009-08-08T00:00:00+00:00" pubdate data-updated="true">Aug 8<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/castle/'>castle</a>, <a class='category' href='/blog/categories/coding/'>coding</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://bling.github.io//blog/2009/08/08/dynamic-proxies/" data-via="blingcoder" data-counturl="http://bling.github.io//blog/2009/08/08/dynamic-proxies/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2009/08/06/who-woulda-thought-ilist-kills-wcf/" title="Previous Post: Who woulda thought, IList<> kills WCF">&laquo; Who woulda thought, IList<> kills WCF</a>
      
      
        <a class="basic-alignment right" href="/blog/2009/08/15/ddd-tdd-enterprise-library-autofac-and-lokad/" title="Next Post: DDD, TDD, Enterprise Library, Autofac, and Lokad.Shared libs!">DDD, TDD, Enterprise Library, Autofac, and Lokad.Shared libs! &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/06/02/unite-dot-vim-the-secret-weapon/">Unite.vim, The Secret Weapon</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/on-typescript/">On TypeScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/13/dot-net-slash-wpf-to-html-slash-css-slash-javscript/">.NET/WPF to HTML/CSS/Javscript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/10/jumping-on-the-hacker-blog-bandwagon/">Jumping on the hacker blog bandwagon</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/11/writing-macros-with-vim/">Writing Macros with Vim</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/02/10/love-affair-with-vim/">Love Affair with Vim</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/29/snoopshell-evolution/">SnoopShell: Evolution</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/01/snoopshell-marriage-of-snoop-wpf-and/">SnoopShell: The marriage of Snoop WPF and PowerShell</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
