<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>A Simple Thread Pool Implementation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.16-DEV" />
    <link href="" rel="alternate" type="application/rss+xml" title="bling on software" />
    <link href="http://bling.github.io/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://bling.github.io/css/hc.css" rel="stylesheet">
    <link href="http://bling.github.io/css/custom.css" rel="stylesheet">
    <link href="http://bling.github.io/css/highlight.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    
    
  </head>
  <body>
    <div id = "wrapper">

      <div class="navbar navbar-default" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a href="http://bling.github.io/"><p class="navbar-brand">bling on software</p></a>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              
              
            </ul>
          </div>
        </div>
      </div>



      
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <a href="http://bling.github.io/">
              <h1 class="brand">bling on software</h1>
            </a>
            <a href="/about">
              <img src="https://pbs.twimg.com/profile_images/1188386482/Untitled_bigger.png" />
            </a>
            <h3>when pragmatism meets minimalism</h3>
          </li>

          <hr />

          <div id="social-wrapper">
            <li> <a href="https://github.com/bling"><i class="fa fa-github-square"></i> github</a> </li>
            <li> <a href="https://twitter.com/blingcoder"><i class="fa fa-twitter-square"></i> @twitter</a></li>
            <li> <a href="https://linkedin.com/in/baileyling"><i class="fa fa-linkedin-square"></i> linkedin</a> </li>
          </div>

          <hr />

          <li class="sidebar-categories">
            <div>
              <span>Categories</span>
              <a href="/post" style="float:right">show all</a>
            </div>
            <div>
              
              <a href="/categories/blend">blend</a>
              
              <a href="/categories/castle">castle</a>
              
              <a href="/categories/castle-coding">castle-coding</a>
              
              <a href="/categories/coding">coding</a>
              
              <a href="/categories/cqrs">cqrs</a>
              
              <a href="/categories/emacs">emacs</a>
              
              <a href="/categories/forex">forex</a>
              
              <a href="/categories/ioc">ioc</a>
              
              <a href="/categories/javascript">javascript</a>
              
              <a href="/categories/logging">logging</a>
              
              <a href="/categories/powershell">powershell</a>
              
              <a href="/categories/rx">rx</a>
              
              <a href="/categories/software-tools">software-tools</a>
              
              <a href="/categories/source-control-management">source-control-management</a>
              
              <a href="/categories/testing">testing</a>
              
              <a href="/categories/twitter">twitter</a>
              
              <a href="/categories/vim">vim</a>
              
              <a href="/categories/visual-studio">visual-studio</a>
              
            </div>
          </li>
        </ul>
      </div>



      <div class="container">



<div class="article">
  <div class="article-title">A Simple Thread Pool Implementation</div>
  <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2009-04-27</small></p> <hr/>
  <div class="post">
    <p>I&rsquo;ve always wanted to do this, and finally I&rsquo;ve gotten around to doing it.  Here&rsquo;s a super duper simple implementation of a working thread pool.  I named in ThreadQueue just so it&rsquo;s clearly discernible from the one provided by the framework.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ThreadQueue</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">WorkItem</span><span class="p">&gt;</span> <span class="n">_queue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">WorkItem</span><span class="p">&gt;();</span>

    <span class="k">struct</span> <span class="nc">WorkItem</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="n">WaitCallback</span> <span class="n">Worker</span><span class="p">;</span>
        <span class="k">public</span> <span class="kt">object</span> <span class="n">State</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="nf">ThreadQueue</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">25</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadWorker</span><span class="p">);</span>
            <span class="n">t</span><span class="p">.</span><span class="n">IsBackground</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">ThreadWorker</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">WorkItem</span> <span class="n">wi</span><span class="p">;</span>
            <span class="k">lock</span> <span class="p">(</span><span class="n">_queue</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">_queue</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Monitor</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">_queue</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">wi</span> <span class="p">=</span> <span class="n">_queue</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">wi</span><span class="p">.</span><span class="n">Worker</span><span class="p">(</span><span class="n">wi</span><span class="p">.</span><span class="n">State</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">QueueUserWorkItem</span><span class="p">(</span><span class="n">WaitCallback</span> <span class="n">callBack</span><span class="p">,</span> <span class="kt">object</span> <span class="n">state</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">WorkItem</span> <span class="n">wi</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WorkItem</span><span class="p">();</span>
        <span class="n">wi</span><span class="p">.</span><span class="n">Worker</span> <span class="p">=</span> <span class="n">callBack</span><span class="p">;</span>
        <span class="n">wi</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
        <span class="k">lock</span> <span class="p">(</span><span class="n">_queue</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_queue</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">wi</span><span class="p">);</span>
            <span class="n">Monitor</span><span class="p">.</span><span class="n">Pulse</span><span class="p">(</span><span class="n">_queue</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>As you can see, it&rsquo;s very short and very simple.  Basically, if it&rsquo;s not used, no threads are started, so in a sense it is lazy.  When you use it for the first time, the static initializer will start up 25 threads, and put them all into waiting state (because the queue will initially be empty).  When something needs to be done, it is added to the queue, and then it pulses a waiting thread to perform some work.</p>

<p>And just to warn you, if the worker delegate throws an exception it will crash the pool&hellip;.so if you want to avoid that you will need to wrap the wi.Worker(wi.State) with a try/catch.</p>

<p>I guess at this point you may wonder why one should even bother writing a thread pool.  For one, it&rsquo;s a great exercise and will probably strengthen your understanding of how to write multithreaded applications.  The above thread pool is probably one of the simplest use-cases for Monitor.Pulse and Monitor.Wait, which are crucial for writing high-performance threaded applications.</p>

<p>Another reason is that the .NET ThreadPool is optimized for many quick ending tasks.  All asynchronous operations are done with the ThreadPool (think BeginInvoke, EndInvoke, BeginRead, EndRead, etc.).  It is not well-suited for any operation that takes a long time to complete.  MSDN recommends that you use a full-blown thread to do that.  Unfortunately, there&rsquo;s a relatively big cost of creating threads, which is why we have thread pools in the first place!  Hence, to solve this problem, we can write our own thread pool which contains some alive and waiting threads to performing longer operations, without clogging the .NET ThreadPool.</p>

<p>In my next post I&rsquo;ll compare the above implementation&rsquo;s performance against the built-in ThreadPool.</p>

  </div>
</div>





    </div>

    <footer>
      <p class="text-muted credit">&copy; bling on software 2015. All rights reserved. </p>
    </footer>

    <script src="http://bling.github.io/js/jquery-1.10.2.min.js"></script>
    <script src="http://bling.github.io/js/bootstrap.min.js"></script>
    <script src="http://bling.github.io/js/bootstrap.js"></script>
    <script type="text/javascript" src="http://bling.github.io/js/hc.js"></script>

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38439430-2', 'auto');
ga('send', 'pageview');
</script>

  </body>
</html>

