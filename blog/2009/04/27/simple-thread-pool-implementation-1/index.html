
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>A Simple Thread Pool Implementation - bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="I&rsquo;ve always wanted to do this, and finally I&rsquo;ve gotten around to doing it. Here&rsquo;s a super duper simple implementation of a working &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io/blog/2009/04/27/simple-thread-pool-implementation-1">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">A Simple Thread Pool Implementation</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-27T00:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2009</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&rsquo;ve always wanted to do this, and finally I&rsquo;ve gotten around to doing it.  Here&rsquo;s a super duper simple implementation of a working thread pool.  I named in ThreadQueue just so it&rsquo;s clearly discernible from the one provided by the framework.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ThreadQueue</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">WorkItem</span><span class="p">&gt;</span> <span class="n">_queue</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Queue</span><span class="p">&lt;</span><span class="n">WorkItem</span><span class="p">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="nc">WorkItem</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">public</span> <span class="n">WaitCallback</span> <span class="n">Worker</span><span class="p">;</span>
</span><span class='line'>        <span class="k">public</span> <span class="kt">object</span> <span class="n">State</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="nf">ThreadQueue</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">25</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Thread</span> <span class="n">t</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="n">ThreadWorker</span><span class="p">);</span>
</span><span class='line'>            <span class="n">t</span><span class="p">.</span><span class="n">IsBackground</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>            <span class="n">t</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">static</span> <span class="k">void</span> <span class="nf">ThreadWorker</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">WorkItem</span> <span class="n">wi</span><span class="p">;</span>
</span><span class='line'>            <span class="k">lock</span> <span class="p">(</span><span class="n">_queue</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">while</span> <span class="p">(</span><span class="n">_queue</span><span class="p">.</span><span class="n">Count</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="n">Monitor</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">_queue</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">wi</span> <span class="p">=</span> <span class="n">_queue</span><span class="p">.</span><span class="n">Dequeue</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">wi</span><span class="p">.</span><span class="n">Worker</span><span class="p">(</span><span class="n">wi</span><span class="p">.</span><span class="n">State</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">QueueUserWorkItem</span><span class="p">(</span><span class="n">WaitCallback</span> <span class="n">callBack</span><span class="p">,</span> <span class="kt">object</span> <span class="n">state</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">WorkItem</span> <span class="n">wi</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WorkItem</span><span class="p">();</span>
</span><span class='line'>        <span class="n">wi</span><span class="p">.</span><span class="n">Worker</span> <span class="p">=</span> <span class="n">callBack</span><span class="p">;</span>
</span><span class='line'>        <span class="n">wi</span><span class="p">.</span><span class="n">State</span> <span class="p">=</span> <span class="n">state</span><span class="p">;</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="n">_queue</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">_queue</span><span class="p">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">wi</span><span class="p">);</span>
</span><span class='line'>            <span class="n">Monitor</span><span class="p">.</span><span class="n">Pulse</span><span class="p">(</span><span class="n">_queue</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, it&rsquo;s very short and very simple.  Basically, if it&rsquo;s not used, no threads are started, so in a sense it is lazy.  When you use it for the first time, the static initializer will start up 25 threads, and put them all into waiting state (because the queue will initially be empty).  When something needs to be done, it is added to the queue, and then it pulses a waiting thread to perform some work.</p>

<p>And just to warn you, if the worker delegate throws an exception it will crash the pool&hellip;.so if you want to avoid that you will need to wrap the wi.Worker(wi.State) with a try/catch.</p>

<p>I guess at this point you may wonder why one should even bother writing a thread pool.  For one, it&rsquo;s a great exercise and will probably strengthen your understanding of how to write multithreaded applications.  The above thread pool is probably one of the simplest use-cases for Monitor.Pulse and Monitor.Wait, which are crucial for writing high-performance threaded applications.</p>

<p>Another reason is that the .NET ThreadPool is optimized for many quick ending tasks.  All asynchronous operations are done with the ThreadPool (think BeginInvoke, EndInvoke, BeginRead, EndRead, etc.).  It is not well-suited for any operation that takes a long time to complete.  MSDN recommends that you use a full-blown thread to do that.  Unfortunately, there&rsquo;s a relatively big cost of creating threads, which is why we have thread pools in the first place!  Hence, to solve this problem, we can write our own thread pool which contains some alive and waiting threads to performing longer operations, without clogging the .NET ThreadPool.</p>

<p>In my next post I&rsquo;ll compare the above implementation&rsquo;s performance against the built-in ThreadPool.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bailey Ling</span></span>

      








  


<time datetime="2009-04-27T00:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2009</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/coding/'>coding</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://bling.github.io/blog/2009/04/27/simple-thread-pool-implementation-1/" data-via="blingcoder" data-counturl="http://bling.github.io/blog/2009/04/27/simple-thread-pool-implementation-1/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2009/04/25/sourcegear-vault-part-4/" title="Previous Post: SourceGear Vault, Part 4, Conclusion">&laquo; SourceGear Vault, Part 4, Conclusion</a>
      
      
        <a class="basic-alignment right" href="/blog/2009/04/27/simple-thread-pool-implementation-2/" title="Next Post: A Simple Thread Pool Implementation (Part 2)">A Simple Thread Pool Implementation (Part 2) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/16/emacs-as-my-leader-evil-mode/">Emacs as my Leader: evil-mode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/09/vim-in-emacs-bootstrap/">Vim in Emacs Bootstrap</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/16/modularizing-vimscript/">Modularizing VimScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/30/1000-stars-in-1-month/">1000 stars in 1 month</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/21/smart-tab-expansions-in-vim-with-expression-mappings/">Smart tab expansions in Vim with expression mappings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/15/flight-of-an-open-source-project/">The flight of an open-source project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/02/unite-dot-vim-the-plugin-you-didnt-know-you-need/">Unite.vim, The plugin you didn't know you need</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/19/on-typescript/">On TypeScript</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
