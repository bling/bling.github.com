<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Building a Real-time Push App with Silverlight: Part 2</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.16-DEV" />
    <link href="" rel="alternate" type="application/rss+xml" title="bling on software" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://bling.github.io/css/hc.css" rel="stylesheet">
    <link href="http://bling.github.io/css/custom.css" rel="stylesheet">
    <link href="http://bling.github.io/css/highlight.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    
    
  </head>
  <body>
    <div id = "wrapper">

      <div class="navbar navbar-default" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a href="http://bling.github.io/"><p class="navbar-brand">bling on software</p></a>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              
              
            </ul>
          </div>
        </div>
      </div>



      
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <a href="http://bling.github.io/">
              <h1 class="brand">bling on software</h1>
            </a>
            <a href="/about">
              <img src="https://pbs.twimg.com/profile_images/1188386482/Untitled_bigger.png" />
            </a>
            <h3>when pragmatism meets minimalism</h3>
          </li>

          <hr />

          <div id="social-wrapper">
            <li> <a href="https://github.com/bling"><i class="fa fa-github-square"></i> github</a> </li>
            <li> <a href="https://twitter.com/blingcoder"><i class="fa fa-twitter-square"></i> @twitter</a></li>
            <li> <a href="https://linkedin.com/in/baileyling"><i class="fa fa-linkedin-square"></i> linkedin</a> </li>
          </div>

          <hr />

          <li class="sidebar-tags">
            <div>
              <span>Tags</span>
              <a href="/post" style="float:right">show all</a>
            </div>
            <div>
              
              <a href="/tags/blend">blend</a>
              
              <a href="/tags/blogging">blogging</a>
              
              <a href="/tags/castle">castle</a>
              
              <a href="/tags/coding">coding</a>
              
              <a href="/tags/cqrs">cqrs</a>
              
              <a href="/tags/emacs">emacs</a>
              
              <a href="/tags/forex">forex</a>
              
              <a href="/tags/ioc">ioc</a>
              
              <a href="/tags/javascript">javascript</a>
              
              <a href="/tags/logging">logging</a>
              
              <a href="/tags/powershell">powershell</a>
              
              <a href="/tags/rx">rx</a>
              
              <a href="/tags/scm">scm</a>
              
              <a href="/tags/software-tools">software-tools</a>
              
              <a href="/tags/testing">testing</a>
              
              <a href="/tags/twitter">twitter</a>
              
              <a href="/tags/vim">vim</a>
              
              <a href="/tags/visual-studio">visual-studio</a>
              
            </div>
          </li>
        </ul>
        <footer>
          <p class="text-muted">&copy; bling on software 2016. All rights reserved. </p>
        </footer>

      </div>



      <div class="container">



<div class="article">
  <div class="article-title">Building a Real-time Push App with Silverlight: Part 2</div>
  <div class="meta">
    <small><i class="fa fa-calendar-o"></i> 2011-08-27</small>
    <div class="article-tags">
      
      <a href="/tags/rx">rx</a>
      
      <a href="/tags/coding">coding</a>
      
    </div>
  </div>
  <hr/>
  <div class="post">
    <p>Let’s review the main Rx code from last time:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">IObservable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">GetJsonStreams</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="n">GetRequest</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="n">FromAsyncPattern</span><span class="p">&lt;</span><span class="n">WebResponse</span><span class="p">&gt;(</span><span class="n">request</span><span class="p">.</span><span class="n">BeginGetResponse</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">EndGetResponse</span><span class="p">)()</span>
        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">wr</span> <span class="p">=&gt;</span> <span class="n">wr</span><span class="p">.</span><span class="n">GetResponseStream</span><span class="p">())</span>
        <span class="p">.</span><span class="n">Select</span><span class="p">(</span><span class="n">str</span> <span class="p">=&gt;</span> <span class="n">Observable</span><span class="p">.</span><span class="n">FromAsyncPattern</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[],</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;(</span><span class="n">str</span><span class="p">.</span><span class="n">BeginRead</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">EndRead</span><span class="p">))</span>
        <span class="p">.</span><span class="n">SelectMany</span><span class="p">(</span><span class="n">ParseJson</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>One thing I didn’t like about this was that the web request object was created regardless of whether the Observable gets a subscription or not.  This is potentially wasted resources, and I wanted to refactor this to be completely lazy.</p>

<p>And with this I started to run into my first &ldquo;huh?&rdquo; moments with Rx: I blocked the UI thread.  How did I do that? I started down the path of exploring some more of the Rx methods, which lead me to <code>Create</code>, which lets you manually call <code>OnNext</code>.  With this train of thought, I came up with something like this:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">return</span> <span class="n">Observable</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">obs</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="n">GetRequest</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">.</span><span class="n">FromAsyncPattern</span><span class="p">&lt;</span><span class="n">WebResponse</span><span class="p">&gt;(</span><span class="n">request</span><span class="p">.</span><span class="n">BeginGetResponse</span><span class="p">,</span> <span class="n">request</span><span class="p">.</span><span class="n">EndGetResponse</span><span class="p">)().</span><span class="n">First</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">str</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">GetResponseStream</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">.</span><span class="n">FromAsyncPattern</span><span class="p">&lt;</span><span class="kt">byte</span><span class="p">[],</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;(</span><span class="n">str</span><span class="p">.</span><span class="n">BeginRead</span><span class="p">,</span> <span class="n">str</span><span class="p">.</span><span class="n">EndRead</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">json</span> <span class="k">in</span> <span class="n">ParseJson</span><span class="p">(</span><span class="n">reader</span><span class="p">))</span>
        <span class="n">obs</span><span class="p">.</span><span class="n">OnNext</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>

        <span class="n">obs</span><span class="p">.</span><span class="n">OnCompleted</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">str</span><span class="p">;</span>
    <span class="p">});</span>
</code></pre></div>

<p>Great! The initialization of the web request only occurs when subscribed! And it will even dispose the stream (by returning <code>str</code>) upon unsubscription.  I ran the app and the UI thread immediately blocked.  What happened?</p>

<p>Rx has the concept of subscription and observation, and provides a way to subscribe and observe on different threads.  Here is the original code that subscribed:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">s</span><span class="p">.</span><span class="n">GetJsonStreams</span><span class="p">()</span>
   <span class="p">.</span><span class="n">ObserveOnDispatcher</span><span class="p">()</span>
   <span class="p">.</span><span class="n">Subscribe</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">Text</span> <span class="p">=</span> <span class="n">x</span><span class="p">);</span>
</code></pre></div>

<p>Can you spot the error? I explicitly told Rx to observe on the dispatcher thread, because I want the action inside <code>Subscribe</code> to be invoked on the UI thread, but I didn’t specify where I want to set up the subscription.  Since I left it out, it uses the current thread, which happens to be the UI thread.  To solve this, it’s as simple as doing this:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">s</span><span class="p">.</span><span class="n">GetJsonStreams</span><span class="p">()</span>
    <span class="p">.</span><span class="n">SubscribeOn</span><span class="p">(</span><span class="n">Scheduler</span><span class="p">.</span><span class="n">ThreadPool</span><span class="p">)</span>
    <span class="p">.</span><span class="n">ObserveOnDispatcher</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Subscribe</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">Text</span> <span class="p">=</span> <span class="n">x</span><span class="p">);</span>
</code></pre></div>

<p>That’s it! Easy! This also follows one of the most important guidelines when using Rx: <em>Subscription and Observation should be done as late as possible</em>, typically just before the <code>Subscribe</code>.  Anything more and you’ll likely make Rx spawn more threads than are necessary or some other nasty bugs.  <a href="http://en.wikipedia.org/wiki/KISS_principle">KISS</a>!</p>

<p>Now with that out of the way, let’s replace the boring TextBlock with something more usable.  First, I need to parse all the JSON streams I’m getting into bindable models.  To do that, I upgraded my StreamReader component and threw in System.Json for some basic parsing:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">TweetParser</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_stack</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">StringBuilder</span> <span class="n">_sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">();</span>

    <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Tweet</span><span class="p">&gt;</span> <span class="n">Parse</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">current</span> <span class="p">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">_sb</span><span class="p">.</span><span class="n">Append</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">current</span> <span class="p">==</span> <span class="sc">&#39;{&#39;</span><span class="p">)</span> <span class="n">_stack</span><span class="p">++;</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">current</span> <span class="p">==</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span> <span class="n">_stack</span><span class="p">--;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">_stack</span> <span class="p">==</span> <span class="m">0</span> <span class="p">&amp;</span><span class="n">_sb</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Tweet</span> <span class="n">tweet</span><span class="p">;</span>
                <span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="n">JsonValue</span><span class="p">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">_sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">());</span>

                <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="k">is</span> <span class="n">JsonObject</span> <span class="p">&amp;</span><span class="n">Tweet</span><span class="p">.</span><span class="n">TryParse</span><span class="p">((</span><span class="n">JsonObject</span><span class="p">)</span><span class="k">value</span><span class="p">,</span> <span class="k">out</span> <span class="n">tweet</span><span class="p">))</span>
                    <span class="k">yield</span> <span class="k">return</span> <span class="n">tweet</span><span class="p">;</span>

                <span class="n">_sb</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Nothing overly complicated.  Next, the Tweet object:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">Tweet</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">JsonObject</span> <span class="n">_json</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="nf">TryParse</span><span class="p">(</span><span class="n">JsonObject</span> <span class="k">value</span><span class="p">,</span> <span class="k">out</span> <span class="n">Tweet</span> <span class="n">tweet</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">)</span> <span class="p">&amp;</span><span class="k">value</span><span class="p">.</span><span class="n">ContainsKey</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">tweet</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Tweet</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">tweet</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="nf">Tweet</span><span class="p">(</span><span class="n">JsonObject</span> <span class="n">json</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_json</span> <span class="p">=</span> <span class="n">json</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">Text</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_json</span><span class="p">[</span><span class="s">&quot;text&quot;</span><span class="p">].</span><span class="n">ToValueString</span><span class="p">();</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">ScreenName</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_json</span><span class="p">[</span><span class="s">&quot;user&quot;</span><span class="p">][</span><span class="s">&quot;screen_name&quot;</span><span class="p">].</span><span class="n">ToValueString</span><span class="p">();</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">internal</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">TweetEx</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ToValueString</span><span class="p">(</span><span class="k">this</span> <span class="n">JsonValue</span> <span class="n">s</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">ToString</span><span class="p">().</span><span class="n">Trim</span><span class="p">(</span><span class="sc">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>To keep things simple I’m only extracting the screen name and text.  I won’t bore you setting up the views since it’s just simple ListBox bound to an <code>ObservableCollection&lt;Tweet&gt;</code>, and a DataTemplate for Tweet.  When it’s all said and done, we see something like this:</p>

<p><img src="http://lh3.ggpht.com/-sVzoQRx_V2s/TlqFswXVhUI/AAAAAAAAAFc/d9nLfBSrARA/image_thumb3.png?imgmax=800" alt="img" /></p>

<p>Performance is still good at 2-5% CPU, even though we’re scrolling through 1000 items in near real-time.</p>

<p>Stay tuned for part 3, when we introduce Expression Blend and go into basics of UI design.  Also, most of this will hit GitHub very soon.</p>

  </div>
</div>




<div class="social-bar">
  <a href="https://twitter.com/share" class="twitter-share-button"{count} data-via="blingcoder">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <g:plusone></g:plusone>
</div>

<ul class="pager">
   &nbsp;<li class="previous"><a href="http://bling.github.io/blog/2011/08/28/building-real-time-push-app-with-rx-3/"> Building a Real-time Push App with Silverlight: Part 3</a></li>
   &nbsp;<li class="next"><a href="http://bling.github.io/blog/2011/08/26/building-real-time-push-app-with-rx-1/"> Building a Real-time Push App with Silverlight: Part 1</a></li>
</ul>


<div id="disqus_thread"></div>
<script type="text/javascript">
 (function() {
   if (window.location.hostname === 'localhost')
     return;

   var disqus_shortname = 'blingdev';
   var disqus_identifier = 'http:\/\/bling.github.io\/blog\/2011\/08\/27\/building-real-time-push-app-with-rx-2\/';
   var disqus_title = 'Building a Real-time Push App with Silverlight: Part 2';
   var disqus_url = 'http:\/\/bling.github.io\/blog\/2011\/08\/27\/building-real-time-push-app-with-rx-2\/';
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>





    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38439430-2', 'auto');
ga('send', 'pageview');
</script>

  </body>
</html>

