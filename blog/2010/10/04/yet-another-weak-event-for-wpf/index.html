<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Yet Another Weak Event Implementation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.16-DEV" />
    <link href="" rel="alternate" type="application/rss+xml" title="bling on software" />
    <link href="http://bling.github.io/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://bling.github.io/css/hc.css" rel="stylesheet">
    <link href="http://bling.github.io/css/custom.css" rel="stylesheet">
    <link href="http://bling.github.io/css/highlight.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    
    
  </head>
  <body>
    <div id = "wrapper">

      <div class="navbar navbar-default" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a href="http://bling.github.io/"><p class="navbar-brand">bling on software</p></a>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              
              
            </ul>
          </div>
        </div>
      </div>



      
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <a href="http://bling.github.io/">
              <h1 class="brand">bling on software</h1>
            </a>
            <a href="/about">
              <img src="https://pbs.twimg.com/profile_images/1188386482/Untitled_bigger.png" />
            </a>
            <h3>when pragmatism meets minimalism</h3>
          </li>

          <hr />

          <div id="social-wrapper">
            <li> <a href="https://github.com/bling"><i class="fa fa-github-square"></i> github</a> </li>
            <li> <a href="https://twitter.com/blingcoder"><i class="fa fa-twitter-square"></i> @twitter</a></li>
            <li> <a href="https://linkedin.com/in/baileyling"><i class="fa fa-linkedin-square"></i> linkedin</a> </li>
          </div>

          <hr />

          <li class="sidebar-categories">
            <div>
              <span>Categories</span>
              <a href="/post" style="float:right">show all</a>
            </div>
            <div>
              
              <a href="/categories/blend">blend</a>
              
              <a href="/categories/castle">castle</a>
              
              <a href="/categories/castle-coding">castle-coding</a>
              
              <a href="/categories/coding">coding</a>
              
              <a href="/categories/cqrs">cqrs</a>
              
              <a href="/categories/emacs">emacs</a>
              
              <a href="/categories/forex">forex</a>
              
              <a href="/categories/ioc">ioc</a>
              
              <a href="/categories/javascript">javascript</a>
              
              <a href="/categories/logging">logging</a>
              
              <a href="/categories/powershell">powershell</a>
              
              <a href="/categories/rx">rx</a>
              
              <a href="/categories/software-tools">software-tools</a>
              
              <a href="/categories/source-control-management">source-control-management</a>
              
              <a href="/categories/testing">testing</a>
              
              <a href="/categories/twitter">twitter</a>
              
              <a href="/categories/vim">vim</a>
              
              <a href="/categories/visual-studio">visual-studio</a>
              
            </div>
          </li>
        </ul>
      </div>



      <div class="container">



<div class="article">
  <div class="article-title">Yet Another Weak Event Implementation</div>
  <p class="meta"><small>&nbsp;<i class="fa fa-calendar-o"></i> 2010-10-04</small></p> <hr/>
  <div class="post">
    <p>I gotta say that WPF is a complete pain in the butt when it comes to memory leaks.  A simple google/bing search shows up more than enough results for weak events, so why am I making yet another blog post about another implementation of a weak event?  Well, if someone else out there happens to have the same requirements/needs that I do right now, maybe this will save them a little time.</p>

<p>In my particular case, I needed to accomplish a couple goals:
- Minimal performance hit.  a.k.a minimal use of reflection.
- Generic and easy to use.
- Thread safe.
- Support for explicit registration and unregistration.</p>

<p>One of the better implementations on weak events I found was from Dustin Campbell&rsquo;s <a href="http://diditwith.net/PermaLink,guid,aacdb8ae-7baa-4423-a953-c18c1c7940ab.aspx">blog post</a>.  Unfortunately, this implementation has one major problem: you cannot explicitly unregister.  In fact, the only way an attached listener no longer receives messages is if it gets garbage collected.  Our application happened to use this for an especially special event on our base entity: the infamous INotifyPropertyChanged event.  Needless to say, all the static WPF dependency objects left a whole bunch of leaked WeakReferences around (ironic?).</p>

<p>But wait, doesn&rsquo;t WPF already have a IWeakEventManager that solves this problem?  The problem with this is a couple things.  It&rsquo;s slow.  It&rsquo;s painful to use.  It&rsquo;s annoying to implement.  Long story short, you need a static WeakEventManager for <em>every</em> unique delegate.  Yes, sure, you can override a lot of the methods to make it more perform faster, but if you need to go that far you might as well write your own that does just what you need, and no more.</p>

<p>If you haven&rsquo;t found it already, Daniel Grunwald&rsquo;s Code Project <a href="http://www.codeproject.com/KB/cs/WeakEvents.aspx">article</a> is yet another great resource.  My implementation was a mix of this and the earlier mentioned link.  Anywho, here it is:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">SynchronizationPriority</span> <span class="n">priority</span><span class="p">,</span> <span class="n">TSender</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">WeakEventEntry</span><span class="p">&lt;</span><span class="n">TTarget</span><span class="p">,</span> <span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TTarget</span> <span class="p">:</span> <span class="k">class</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">OpenForwardingEventHandler</span><span class="p">(</span><span class="n">TTarget</span> <span class="n">target</span><span class="p">,</span> <span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">WeakReference</span> <span class="n">m_TargetRef</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">OpenForwardingEventHandler</span> <span class="n">m_OpenHandler</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MethodInfo</span> <span class="n">m_Method</span><span class="p">;</span>
    <span class="k">public</span> <span class="nf">WeakEventEntry</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_OpenHandler</span> <span class="p">=</span> <span class="p">(</span><span class="n">OpenForwardingEventHandler</span><span class="p">)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">OpenForwardingEventHandler</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">);</span>
        <span class="n">m_TargetRef</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span><span class="p">);</span>
        <span class="n">m_Method</span> <span class="p">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">IsAlive</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span> <span class="p">==</span> <span class="n">m_Method</span> <span class="p">&amp;&amp;</span> <span class="n">handler</span><span class="p">.</span><span class="n">Target</span> <span class="p">==</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">Target</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TTarget</span> <span class="n">target</span> <span class="p">=</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">Target</span> <span class="k">as</span> <span class="n">TTarget</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">m_OpenHandler</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">WeakEvent</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">EMPTY_LIST</span> <span class="p">=</span> <span class="k">new</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[</span><span class="m">0</span><span class="p">];</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;&gt;</span> <span class="n">m_Events</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">EMPTY_LIST</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_InvokeList</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="c1">// static method</span>
        <span class="p">{</span>
            <span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">StrongEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;(</span><span class="n">handler</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">WeakEventEntry</span><span class="p">&lt;,,&gt;).</span><span class="n">MakeGenericType</span><span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span><span class="p">.</span><span class="n">GetType</span><span class="p">(),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TSender</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TArgs</span><span class="p">));</span>
            <span class="n">Add</span><span class="p">((</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;)</span><span class="n">type</span><span class="p">.</span><span class="n">GetConstructors</span><span class="p">()[</span><span class="m">0</span><span class="p">].</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">handler</span> <span class="p">}));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="n">entry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="n">m_Events</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;&gt;(</span><span class="m">8</span><span class="p">);</span>
            <span class="n">m_Events</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
            <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Remove</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Matches</span><span class="p">(</span><span class="n">handler</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="n">m_Events</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Clear</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">m_Events</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">EMPTY_LIST</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Raise</span><span class="p">(</span><span class="n">TSender</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">events</span> <span class="p">=</span> <span class="n">m_InvokeList</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">removeDead</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">events</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
            <span class="n">removeDead</span> <span class="p">|=</span> <span class="p">!</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Invoke</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">removeDead</span><span class="p">)</span>
            <span class="n">RemoveDeadReferences</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">private</span> <span class="k">void</span> <span class="nf">RemoveDeadReferences</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(!</span><span class="n">m_Events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">IsAlive</span><span class="p">)</span>
                        <span class="n">m_Events</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Nothing too special here.  For performance, a copy of all events are stored in an array so that raising events doesn&rsquo;t need to be in a lock.  And while locking on &ldquo;this&rdquo; is usually bad practice, in this case I didn&rsquo;t have any other local variable to use, and creating an object just for the sake of locking in my eyes was not worth it in this scenario.</p>

<p>I tried generating the OpenForwardingDelegate using DynamicMethod and IL, but the result was negligible because it doesn&rsquo;t actually affect invoking speed, which is what we&rsquo;re most concerned with.</p>

<p>Also, if you didn&rsquo;t notice, this implementation also supports static methods attaching, hence why there is an IWeakEventEntry interface.  Here&rsquo;s the StrongEventEntry implementation:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">StrongEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">ClosedForwardingEventHandler</span><span class="p">(</span><span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ClosedForwardingEventHandler</span> <span class="n">m_ClosedHandler</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MethodInfo</span> <span class="n">m_Method</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
    <span class="k">public</span> <span class="nf">StrongEventEntry</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_Method</span> <span class="p">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
        <span class="n">m_ClosedHandler</span> <span class="p">=</span> <span class="p">(</span><span class="n">ClosedForwardingEventHandler</span><span class="p">)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ClosedForwardingEventHandler</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">m_Method</span> <span class="p">==</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">SynchronizationPriority</span> <span class="n">priority</span><span class="p">,</span> <span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">m_ClosedHandler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Last but not least, usage:</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="n">WeakEvent</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">PropertyChangedEventArgs</span><span class="p">&gt;</span> <span class="n">_propertyChanged</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WeakEvent</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">PropertyChangedEventArgs</span><span class="p">&gt;();</span>
<span class="k">public</span> <span class="k">event</span> <span class="n">PropertyChangedEventHandler</span> <span class="n">PropertyChanged</span>
<span class="p">{</span>
    <span class="k">add</span> <span class="p">{</span> <span class="n">_propertyChanged</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">remove</span> <span class="p">{</span> <span class="n">_propertyChanged</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Performance is quite good.  On my machine for 1,000,000,000 invocations, it takes the WeakEvent ~17.3 seconds, vs 4.2 seconds for a standard delegate, for roughly 4x invocation cost.</p>

<p>And there you have it!  A simple, generic, and fast weak event in ~200 lines of code.</p>

  </div>
</div>





    </div>

    <footer>
      <p class="text-muted credit">&copy; bling on software 2015. All rights reserved. </p>
    </footer>

    <script src="http://bling.github.io/js/jquery-1.10.2.min.js"></script>
    <script src="http://bling.github.io/js/bootstrap.min.js"></script>
    <script src="http://bling.github.io/js/bootstrap.js"></script>
    <script type="text/javascript" src="http://bling.github.io/js/hc.js"></script>

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38439430-2', 'auto');
ga('send', 'pageview');
</script>

  </body>
</html>

