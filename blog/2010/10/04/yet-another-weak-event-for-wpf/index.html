
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Yet Another Weak Event Implementation - bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="I gotta say that WPF is a complete pain in the butt when it comes to memory leaks. A simple google/bing search shows up more than enough results for &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io/blog/2010/10/04/yet-another-weak-event-for-wpf">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Yet Another Weak Event Implementation</h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-10-04T00:00:00+00:00" pubdate data-updated="true">Oct 4<span>th</span>, 2010</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I gotta say that WPF is a complete pain in the butt when it comes to memory leaks.  A simple google/bing search shows up more than enough results for weak events, so why am I making yet another blog post about another implementation of a weak event?  Well, if someone else out there happens to have the same requirements/needs that I do right now, maybe this will save them a little time.</p>

<p>In my particular case, I needed to accomplish a couple goals:
&ndash; Minimal performance hit.  a.k.a minimal use of reflection.
&ndash; Generic and easy to use.
&ndash; Thread safe.
&ndash; Support for explicit registration and unregistration.</p>

<p>One of the better implementations on weak events I found was from Dustin Campbell&rsquo;s <a href="http://diditwith.net/PermaLink,guid,aacdb8ae-7baa-4423-a953-c18c1c7940ab.aspx">blog post</a>.  Unfortunately, this implementation has one major problem: you cannot explicitly unregister.  In fact, the only way an attached listener no longer receives messages is if it gets garbage collected.  Our application happened to use this for an especially special event on our base entity: the infamous INotifyPropertyChanged event.  Needless to say, all the static WPF dependency objects left a whole bunch of leaked WeakReferences around (ironic?).</p>

<p>But wait, doesn&rsquo;t WPF already have a IWeakEventManager that solves this problem?  The problem with this is a couple things.  It&rsquo;s slow.  It&rsquo;s painful to use.  It&rsquo;s annoying to implement.  Long story short, you need a static WeakEventManager for <em>every</em> unique delegate.  Yes, sure, you can override a lot of the methods to make it more perform faster, but if you need to go that far you might as well write your own that does just what you need, and no more.</p>

<p>If you haven&rsquo;t found it already, Daniel Grunwald&rsquo;s Code Project <a href="http://www.codeproject.com/KB/cs/WeakEvents.aspx">article</a> is yet another great resource.  My implementation was a mix of this and the earlier mentioned link.  Anywho, here it is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">interface</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">SynchronizationPriority</span> <span class="n">priority</span><span class="p">,</span> <span class="n">TSender</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WeakEventEntry</span><span class="p">&lt;</span><span class="n">TTarget</span><span class="p">,</span> <span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="k">where</span> <span class="n">TTarget</span> <span class="p">:</span> <span class="k">class</span>
</span><span class='line'><span class="err">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">OpenForwardingEventHandler</span><span class="p">(</span><span class="n">TTarget</span> <span class="n">target</span><span class="p">,</span> <span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">WeakReference</span> <span class="n">m_TargetRef</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">OpenForwardingEventHandler</span> <span class="n">m_OpenHandler</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MethodInfo</span> <span class="n">m_Method</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">WeakEventEntry</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">m_OpenHandler</span> <span class="p">=</span> <span class="p">(</span><span class="n">OpenForwardingEventHandler</span><span class="p">)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">OpenForwardingEventHandler</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">);</span>
</span><span class='line'>        <span class="n">m_TargetRef</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span><span class="p">);</span>
</span><span class='line'>        <span class="n">m_Method</span> <span class="p">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">IsAlive</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span> <span class="p">==</span> <span class="n">m_Method</span> <span class="p">&amp;&amp;</span> <span class="n">handler</span><span class="p">.</span><span class="n">Target</span> <span class="p">==</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">Target</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">TTarget</span> <span class="n">target</span> <span class="p">=</span> <span class="n">m_TargetRef</span><span class="p">.</span><span class="n">Target</span> <span class="k">as</span> <span class="n">TTarget</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">m_OpenHandler</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">WeakEvent</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">EMPTY_LIST</span> <span class="p">=</span> <span class="k">new</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[</span><span class="m">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;&gt;</span> <span class="n">m_Events</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">EMPTY_LIST</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">int</span> <span class="n">Count</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">m_InvokeList</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="c1">// static method</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">StrongEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;(</span><span class="n">handler</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">WeakEventEntry</span><span class="p">&lt;,,&gt;).</span><span class="n">MakeGenericType</span><span class="p">(</span><span class="n">handler</span><span class="p">.</span><span class="n">Target</span><span class="p">.</span><span class="n">GetType</span><span class="p">(),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TSender</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TArgs</span><span class="p">));</span>
</span><span class='line'>            <span class="n">Add</span><span class="p">((</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;)</span><span class="n">type</span><span class="p">.</span><span class="n">GetConstructors</span><span class="p">()[</span><span class="m">0</span><span class="p">].</span><span class="n">Invoke</span><span class="p">(</span><span class="k">new</span> <span class="kt">object</span><span class="p">[]</span> <span class="p">{</span> <span class="n">handler</span> <span class="p">}));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Add</span><span class="p">(</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="n">entry</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>                <span class="n">m_Events</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;&gt;(</span><span class="m">8</span><span class="p">);</span>
</span><span class='line'>            <span class="n">m_Events</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
</span><span class='line'>            <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Remove</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Matches</span><span class="p">(</span><span class="n">handler</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">{</span>
</span><span class='line'>                        <span class="n">m_Events</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">m_Events</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>            <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">EMPTY_LIST</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Raise</span><span class="p">(</span><span class="n">TSender</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSender</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;[]</span> <span class="n">events</span> <span class="p">=</span> <span class="n">m_InvokeList</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">bool</span> <span class="n">removeDead</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">events</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
</span><span class='line'>            <span class="n">removeDead</span> <span class="p">|=</span> <span class="p">!</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Invoke</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">removeDead</span><span class="p">)</span>
</span><span class='line'>            <span class="n">RemoveDeadReferences</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">void</span> <span class="nf">RemoveDeadReferences</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">m_Events</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">Count</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">i</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span><span class="p">--)</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(!</span><span class="n">m_Events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">IsAlive</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">m_Events</span><span class="p">.</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">m_InvokeList</span> <span class="p">=</span> <span class="n">m_Events</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing too special here.  For performance, a copy of all events are stored in an array so that raising events doesn&rsquo;t need to be in a lock.  And while locking on &ldquo;this&rdquo; is usually bad practice, in this case I didn&rsquo;t have any other local variable to use, and creating an object just for the sake of locking in my eyes was not worth it in this scenario.</p>

<p>I tried generating the OpenForwardingDelegate using DynamicMethod and IL, but the result was negligible because it doesn&rsquo;t actually affect invoking speed, which is what we&rsquo;re most concerned with.</p>

<p>Also, if you didn&rsquo;t notice, this implementation also supports static methods attaching, hence why there is an IWeakEventEntry interface.  Here&rsquo;s the StrongEventEntry implementation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">StrongEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IWeakEventEntry</span><span class="p">&lt;</span><span class="n">TSource</span><span class="p">,</span> <span class="n">TArgs</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">delegate</span> <span class="k">void</span> <span class="nf">ClosedForwardingEventHandler</span><span class="p">(</span><span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ClosedForwardingEventHandler</span> <span class="n">m_ClosedHandler</span><span class="p">;</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">readonly</span> <span class="n">MethodInfo</span> <span class="n">m_Method</span><span class="p">;</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsAlive</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="nf">StrongEventEntry</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">m_Method</span> <span class="p">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
</span><span class='line'>        <span class="n">m_ClosedHandler</span> <span class="p">=</span> <span class="p">(</span><span class="n">ClosedForwardingEventHandler</span><span class="p">)</span><span class="n">Delegate</span><span class="p">.</span><span class="n">CreateDelegate</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">ClosedForwardingEventHandler</span><span class="p">),</span> <span class="k">null</span><span class="p">,</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Matches</span><span class="p">(</span><span class="n">Delegate</span> <span class="n">handler</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">m_Method</span> <span class="p">==</span> <span class="n">handler</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">SynchronizationPriority</span> <span class="n">priority</span><span class="p">,</span> <span class="n">TSource</span> <span class="n">sender</span><span class="p">,</span> <span class="n">TArgs</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">m_ClosedHandler</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last but not least, usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">private</span> <span class="n">WeakEvent</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">PropertyChangedEventArgs</span><span class="p">&gt;</span> <span class="n">_propertyChanged</span> <span class="p">=</span> <span class="k">new</span> <span class="n">WeakEvent</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">PropertyChangedEventArgs</span><span class="p">&gt;();</span>
</span><span class='line'><span class="k">public</span> <span class="k">event</span> <span class="n">PropertyChangedEventHandler</span> <span class="n">PropertyChanged</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">add</span> <span class="p">{</span> <span class="n">_propertyChanged</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">remove</span> <span class="p">{</span> <span class="n">_propertyChanged</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="k">value</span><span class="p">);</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Performance is quite good.  On my machine for 1,000,000,000 invocations, it takes the WeakEvent ~17.3 seconds, vs 4.2 seconds for a standard delegate, for roughly 4x invocation cost.</p>

<p>And there you have it!  A simple, generic, and fast weak event in ~200 lines of code.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bailey Ling</span></span>

      








  


<time datetime="2010-10-04T00:00:00+00:00" pubdate data-updated="true">Oct 4<span>th</span>, 2010</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/coding/'>coding</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://bling.github.io/blog/2010/10/04/yet-another-weak-event-for-wpf/" data-via="blingcoder" data-counturl="http://bling.github.io/blog/2010/10/04/yet-another-weak-event-for-wpf/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2010/05/14/contextual-lifestyle-with-castle/" title="Previous Post: Contextual Lifestyle with Castle Windsor">&laquo; Contextual Lifestyle with Castle Windsor</a>
      
      
        <a class="basic-alignment right" href="/blog/2010/10/05/memory-leak-with-wpfs-richtextbox/" title="Next Post: Memory Leak with WPF’s RichTextBox">Memory Leak with WPF’s RichTextBox &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/21/asynchronous-eval-with-stylus-and-skewer/">Asynchronous Eval in Emacs with Stylus and Skewer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/27/emacs-as-my-leader-vim-survival-guide/">Emacs as my &lt;Leader&gt;: Vim Survival Guide</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/16/emacs-as-my-leader-evil-mode/">Emacs as my &lt;Leader&gt;: evil-mode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/09/vim-in-emacs-bootstrap/">Vim in Emacs Bootstrap</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/16/modularizing-vimscript/">Modularizing VimScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/30/1000-stars-in-1-month/">1000 stars in 1 month</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/21/smart-tab-expansions-in-vim-with-expression-mappings/">Smart tab expansions in Vim with expression mappings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/15/flight-of-an-open-source-project/">The flight of an open-source project</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
