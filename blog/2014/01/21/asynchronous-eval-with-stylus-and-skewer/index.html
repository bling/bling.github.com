
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Asynchronous Eval in Emacs with Stylus and Skewer - bling on software development</title>
  <meta name="author" content="Bailey Ling">

  
  <meta name="description" content="You haven&rsquo;t experienced Emacs if you haven&rsquo;t experienced the power of C-x C-e. This is the magical keybinding which evalulates the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bling.github.io/blog/2014/01/21/asynchronous-eval-with-stylus-and-skewer">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="bling on software development" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic|Ubuntu:300,400,500,700,300italic,400italic,500italic,700italic' rel='stylesheet' type='text/css'>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38439430-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">bling on software development</a></h1>
  
    <h2>when pragmatism meets minimalism</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bling.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Asynchronous Eval in Emacs With Stylus and Skewer</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-21T16:41:16+00:00" pubdate data-updated="true">Jan 21<span>st</span>, 2014</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>You haven&rsquo;t experienced Emacs if you haven&rsquo;t experienced the power of <code>C-x C-e</code>.  This is the magical keybinding which evalulates the current line.  Another useful companion is <code>C-M-x</code>, which evaluates the current function.</p>

<p>Lisp dialects naturally work with these patterns seamlessly, and once I figured out the possibilities of this I got addicted and wanted it available in <em>all</em> of my languages.  It&rsquo;s like having a debugger available all the time.  But unlike debuggers where you inspect and change variables at run time, and then need to translate your changes back to code, in Lisp you just edit the code directly and eval (and repeat until you like the result).</p>

<h1>Adapting the Pattern to Stylus</h1>

<p>Anyone doing serious web development will not be writing CSS directly.  There are many compelling alternatives; the 3 most popular being SASS/Compass, LESS, and Stylus.  On my current project I&rsquo;m using Stylus, so I adapted this workflow to it.</p>

<p>First, let&rsquo;s start with <a href="https://github.com/skeeto/skewer-mode">skewer-mode</a>.  This minor mode lets you connect to a real browser and evaluate to it.  It can evaluate Javascript or CSS on the fly.  It even has a bookmarklet script that allows you to evaluate arbitrary code against <em>any</em> website.  Yes, that is amazing!</p>

<p>However, it only supports CSS&hellip;so how am I going to use my beloved eval against Stylus code?</p>

<h1>The First Attempt</h1>

<p>The first thing I did was do the simplest thing &mdash; convert Stylus to CSS and show it in a temporary buffer.  This turned out to be pretty straightforward.  I came up with the following code snippet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='cl'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">stylus-compile-and-show-region</span> <span class="p">(</span><span class="nv">start</span> <span class="nv">end</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">interactive</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">call-process-region</span> <span class="nv">start</span> <span class="nv">end</span> <span class="s">&quot;stylus&quot;</span> <span class="no">nil</span> <span class="p">(</span><span class="nv">get-buffer-create</span> <span class="s">&quot;*Stylus*&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">display-buffer</span> <span class="s">&quot;*Stylus*&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">&quot;*Stylus*&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">css-mode</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Easy!  It creates an interactive command which takes in a region, then calls out to the external <code>stylus</code> command and puts the output into a buffer named <code>*Stylus*</code>, and finally shows it and enables <code>css-mode</code>.</p>

<p>Now, I just switch to that buffer and <code>C-x C-e</code> to my heart&rsquo;s content!  But there was a problem here&hellip;.Anything I change in the CSS buffer I would have to translate it back to Stylus, which was very annoying, and I might as well do it in the browser directly with Dev Tools if I&rsquo;m going to do that.</p>

<p>Let&rsquo;s fix that.</p>

<h1>Evaluating Stylus Directly</h1>

<p>First things first, I realized that I don&rsquo;t need to show a buffer to interact with it.  So evaluating from Stylus directly actually involved replacing one line of code.  Instead of <code>(display-buffer)</code>, I put in <code>(skewer-css-eval-buffer)</code>, and viola!!  Now I can eval any Stylus code and have it appear in the browser!</p>

<p>For brevity I&rsquo;ve excluded other necessary code like emptying the buffer before compiling Stylus, but you get the idea.</p>

<p>But, there was one last itch I still needed to scratch&hellip;</p>

<h1>It was blocking!</h1>

<p>All things considered, blocking the UI for 1 second isn&rsquo;t the end of the world.  But it was enough of an annoyance that I felt compelled to fix it!</p>

<p>And with that, I started reading the documentation.  I wish Emacs would provide a categorzied listing of all functions (instead of the <a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Index.html#Index">alphabetical listing</a>), because finding what I needed took longer than expected (if you know of such a listing please let me know).</p>

<p>I eventually stumbled across <code>start-process</code>, which lets you control asynchronous processes.  Digging through the documentation further, I was able to find <code>set-process-sentinel</code>.</p>

<p>And with that, the following snippet was born:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='cl'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">stylus-eval-region-async</span> <span class="p">(</span><span class="nv">begin</span> <span class="nv">end</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">process</span> <span class="p">(</span><span class="nv">start-process</span> <span class="s">&quot;stylus&quot;</span> <span class="s">&quot;*Stylus*&quot;</span> <span class="s">&quot;stylus&quot;</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">set-process-sentinel</span> <span class="nv">process</span> <span class="ss">&#39;stylus-process-sentinel</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">process-send-region</span> <span class="nv">process</span> <span class="nv">begin</span> <span class="nv">end</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">process-send-eof</span> <span class="nv">process</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">stylus-process-sentinel</span> <span class="p">(</span><span class="nv">process</span> <span class="nv">event</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">equal</span> <span class="nv">event</span> <span class="s">&quot;finished\n&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">&quot;*Stylus*&quot;</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">css-mode</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">skewer-css-eval-buffer</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Basically, what&rsquo;s happening here is that I&rsquo;m starting an asynchronous process which writes all output into the <code>*Stylus*</code> buffer.  I send the region as input into the process, and finally, when the process terminates, which is detected by the sentinel function, it evaluates the buffer.</p>

<p>And now I can eval to my heart&rsquo;s content without blocking!</p>

<p>The full source code (with emptying buffers and other housekeeping) can be found in my <a href="https://github.com/bling/dotemacs/blob/master/config/init-stylus.el">dotemacs</a>.</p>

<p>If you haven&rsquo;t already noticed, this is not specific to Stylus and will work with any program which works with stdin/stdout!  Enjoy.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Bailey Ling</span></span>

      








  


<time datetime="2014-01-21T16:41:16+00:00" pubdate data-updated="true">Jan 21<span>st</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/emacs/'>emacs</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://bling.github.io/blog/2014/01/21/asynchronous-eval-with-stylus-and-skewer/" data-via="blingcoder" data-counturl="http://bling.github.io/blog/2014/01/21/asynchronous-eval-with-stylus-and-skewer/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/10/27/emacs-as-my-leader-vim-survival-guide/" title="Previous Post: Emacs as my &lt;Leader&gt;: Vim Survival Guide">&laquo; Emacs as my &lt;Leader&gt;: Vim Survival Guide</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/21/asynchronous-eval-with-stylus-and-skewer/">Asynchronous Eval in Emacs with Stylus and Skewer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/27/emacs-as-my-leader-vim-survival-guide/">Emacs as my &lt;Leader&gt;: Vim Survival Guide</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/16/emacs-as-my-leader-evil-mode/">Emacs as my &lt;Leader&gt;: evil-mode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/09/vim-in-emacs-bootstrap/">Vim in Emacs Bootstrap</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/08/16/modularizing-vimscript/">Modularizing VimScript</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/30/1000-stars-in-1-month/">1000 stars in 1 month</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/21/smart-tab-expansions-in-vim-with-expression-mappings/">Smart tab expansions in Vim with expression mappings</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/15/flight-of-an-open-source-project/">The flight of an open-source project</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/bling">@bling</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bling',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Bailey Ling -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'blingdev';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://bling.github.io/blog/2014/01/21/asynchronous-eval-with-stylus-and-skewer/';
        var disqus_url = 'http://bling.github.io/blog/2014/01/21/asynchronous-eval-with-stylus-and-skewer/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
