<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Asynchronous Eval in Emacs with Stylus and Skewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="generator" content="Hugo 0.16-DEV" />
    <link href="" rel="alternate" type="application/rss+xml" title="bling on software" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://bling.github.io/css/hc.css" rel="stylesheet">
    <link href="http://bling.github.io/css/custom.css" rel="stylesheet">
    <link href="http://bling.github.io/css/highlight.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    
    
  </head>
  <body>
    <div id = "wrapper">

      <div class="navbar navbar-default" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a href="http://bling.github.io/"><p class="navbar-brand">bling on software</p></a>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              
              
            </ul>
          </div>
        </div>
      </div>



      
      <div id="sidebar-wrapper">
        <ul class="sidebar-nav">
          <li class="sidebar-brand">
            <a href="http://bling.github.io/">
              <h1 class="brand">bling on software</h1>
            </a>
            <a href="/about">
              <img src="https://pbs.twimg.com/profile_images/1188386482/Untitled_bigger.png" />
            </a>
            <h3>when pragmatism meets minimalism</h3>
          </li>

          <hr />

          <div id="social-wrapper">
            <li> <a href="https://github.com/bling"><i class="fa fa-github-square"></i> github</a> </li>
            <li> <a href="https://twitter.com/blingcoder"><i class="fa fa-twitter-square"></i> @twitter</a></li>
            <li> <a href="https://linkedin.com/in/baileyling"><i class="fa fa-linkedin-square"></i> linkedin</a> </li>
          </div>

          <hr />

          <li class="sidebar-tags">
            <div>
              <span>Tags</span>
              <a href="/post" style="float:right">show all</a>
            </div>
            <div>
              
              <a href="/tags/blend">blend</a>
              
              <a href="/tags/blogging">blogging</a>
              
              <a href="/tags/castle">castle</a>
              
              <a href="/tags/coding">coding</a>
              
              <a href="/tags/cqrs">cqrs</a>
              
              <a href="/tags/emacs">emacs</a>
              
              <a href="/tags/forex">forex</a>
              
              <a href="/tags/ioc">ioc</a>
              
              <a href="/tags/javascript">javascript</a>
              
              <a href="/tags/logging">logging</a>
              
              <a href="/tags/powershell">powershell</a>
              
              <a href="/tags/rx">rx</a>
              
              <a href="/tags/scm">scm</a>
              
              <a href="/tags/software-tools">software-tools</a>
              
              <a href="/tags/testing">testing</a>
              
              <a href="/tags/twitter">twitter</a>
              
              <a href="/tags/vim">vim</a>
              
              <a href="/tags/visual-studio">visual-studio</a>
              
            </div>
          </li>
        </ul>
        <footer>
          <p class="text-muted">&copy; bling on software 2016. All rights reserved. </p>
        </footer>

      </div>



      <div class="container">



<div class="article">
  <div class="article-title">Asynchronous Eval in Emacs with Stylus and Skewer</div>
  <div class="meta">
    <small><i class="fa fa-calendar-o"></i> 2014-01-21</small>
    <div class="article-tags">
      
      <a href="/tags/emacs">emacs</a>
      
    </div>
  </div>
  <hr/>
  <div class="post">
    

<p>You haven&rsquo;t experienced Emacs if you haven&rsquo;t experienced the power of <code>C-x C-e</code>.  This is the magical keybinding which evalulates the current line.  Another useful companion is <code>C-M-x</code>, which evaluates the current function.</p>

<p>Lisp dialects naturally work with these patterns seamlessly, and once I figured out the possibilities of this I got addicted and wanted it available in <em>all</em> of my languages.  It&rsquo;s like having a debugger available all the time.  But unlike debuggers where you inspect and change variables at run time, and then need to translate your changes back to code, in Lisp you just edit the code directly and eval (and repeat until you like the result).</p>

<h1 id="adapting-the-pattern-to-stylus:6219f9e2c0ad4a4dcda9b93b8ed614eb">Adapting the Pattern to Stylus</h1>

<p>Anyone doing serious web development will not be writing CSS directly.  There are many compelling alternatives; the 3 most popular being SASS/Compass, LESS, and Stylus.  On my current project I&rsquo;m using Stylus, so I adapted this workflow to it.</p>

<p>First, let&rsquo;s start with <a href="https://github.com/skeeto/skewer-mode">skewer-mode</a>.  This minor mode lets you connect to a real browser and evaluate to it.  It can evaluate Javascript or CSS on the fly.  It even has a bookmarklet script that allows you to evaluate arbitrary code against <em>any</em> website.  Yes, that is amazing!</p>

<p>However, it only supports CSS&hellip;so how am I going to use my beloved eval against Stylus code?</p>

<h1 id="the-first-attempt:6219f9e2c0ad4a4dcda9b93b8ed614eb">The First Attempt</h1>

<p>The first thing I did was do the simplest thing &ndash; convert Stylus to CSS and show it in a temporary buffer.  This turned out to be pretty straightforward.  I came up with the following code snippet:</p>
<div class="highlight"><pre><code class="language-cl" data-lang="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">stylus-compile-and-show-region</span> <span class="p">(</span><span class="nv">start</span> <span class="nv">end</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">interactive</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">call-process-region</span> <span class="nv">start</span> <span class="nv">end</span> <span class="s">&quot;stylus&quot;</span> <span class="no">nil</span> <span class="p">(</span><span class="nv">get-buffer-create</span> <span class="s">&quot;*Stylus*&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">display-buffer</span> <span class="s">&quot;*Stylus*&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">&quot;*Stylus*&quot;</span>
    <span class="p">(</span><span class="nv">css-mode</span><span class="p">)))</span>
</code></pre></div>

<p>Easy!  It creates an interactive command which takes in a region, then calls out to the external <code>stylus</code> command and puts the output into a buffer named <code>*Stylus*</code>, and finally shows it and enables <code>css-mode</code>.</p>

<p>Now, I just switch to that buffer and <code>C-x C-e</code> to my heart&rsquo;s content!  But there was a problem here&hellip;.Anything I change in the CSS buffer I would have to translate it back to Stylus, which was very annoying, and I might as well do it in the browser directly with Dev Tools if I&rsquo;m going to do that.</p>

<p>Let&rsquo;s fix that.</p>

<h1 id="evaluating-stylus-directly:6219f9e2c0ad4a4dcda9b93b8ed614eb">Evaluating Stylus Directly</h1>

<p>First things first, I realized that I don&rsquo;t need to show a buffer to interact with it.  So evaluating from Stylus directly actually involved replacing one line of code.  Instead of <code>(display-buffer)</code>, I put in <code>(skewer-css-eval-buffer)</code>, and viola!!  Now I can eval any Stylus code and have it appear in the browser!</p>

<p>For brevity I&rsquo;ve excluded other necessary code like emptying the buffer before compiling Stylus, but you get the idea.</p>

<p>But, there was one last itch I still needed to scratch&hellip;</p>

<h1 id="it-was-blocking:6219f9e2c0ad4a4dcda9b93b8ed614eb">It was blocking!</h1>

<p>All things considered, blocking the UI for 1 second isn&rsquo;t the end of the world.  But it was enough of an annoyance that I felt compelled to fix it!</p>

<p>And with that, I started reading the documentation.  I wish Emacs would provide a categorzied listing of all functions (instead of the <a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Index.html#Index">alphabetical listing</a>), because finding what I needed took longer than expected (if you know of such a listing please let me know).</p>

<p>I eventually stumbled across <code>start-process</code>, which lets you control asynchronous processes.  Digging through the documentation further, I was able to find <code>set-process-sentinel</code>.</p>

<p>And with that, the following snippet was born:</p>
<div class="highlight"><pre><code class="language-cl" data-lang="cl"><span class="p">(</span><span class="nb">defun</span> <span class="nv">stylus-eval-region-async</span> <span class="p">(</span><span class="nv">begin</span> <span class="nv">end</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">process</span> <span class="p">(</span><span class="nv">start-process</span> <span class="s">&quot;stylus&quot;</span> <span class="s">&quot;*Stylus*&quot;</span> <span class="s">&quot;stylus&quot;</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">set-process-sentinel</span> <span class="nv">process</span> <span class="ss">&#39;stylus-process-sentinel</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">process-send-region</span> <span class="nv">process</span> <span class="nv">begin</span> <span class="nv">end</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">process-send-eof</span> <span class="nv">process</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">stylus-process-sentinel</span> <span class="p">(</span><span class="nv">process</span> <span class="nv">event</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">equal</span> <span class="nv">event</span> <span class="s">&quot;finished\n&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">&quot;*Stylus*&quot;</span>
      <span class="p">(</span><span class="nv">css-mode</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">skewer-css-eval-buffer</span><span class="p">))))</span>
</code></pre></div>

<p>Basically, what&rsquo;s happening here is that I&rsquo;m starting an asynchronous process which writes all output into the <code>*Stylus*</code> buffer.  I send the region as input into the process, and finally, when the process terminates, which is detected by the sentinel function, it evaluates the buffer.</p>

<p>And now I can eval to my heart&rsquo;s content without blocking!</p>

<p>The full source code (with emptying buffers and other housekeeping) can be found in my <a href="https://github.com/bling/dotemacs/blob/master/config/init-stylus.el">dotemacs</a>.</p>

<p>If you haven&rsquo;t already noticed, this is not specific to Stylus and will work with any program which works with stdin/stdout!  Enjoy.</p>

  </div>
</div>




<div class="social-bar">
  <a href="https://twitter.com/share" class="twitter-share-button"{count} data-via="blingcoder">Tweet</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <g:plusone></g:plusone>
</div>

<ul class="pager">
   &nbsp;<li class="previous"><a href="http://bling.github.io/blog/2015/01/06/emacs-as-my-leader-1-year-later/"> Emacs as my &lt;Leader&gt; 1 Year Later</a></li>
   &nbsp;<li class="next"><a href="http://bling.github.io/blog/2013/10/27/emacs-as-my-leader-vim-survival-guide/"> Emacs as my &lt;Leader&gt; Vim Survival Guide</a></li>
</ul>


<div id="disqus_thread"></div>
<script type="text/javascript">
 if (window.location.hostname === 'localhost')
   return;

 var disqus_shortname = 'blingdev';
 var disqus_identifier = 'http:\/\/bling.github.io\/blog\/2014\/01\/21\/asynchronous-eval-with-stylus-and-skewer\/';
 var disqus_title = 'Asynchronous Eval in Emacs with Stylus and Skewer';
 var disqus_url = 'http:\/\/bling.github.io\/blog\/2014\/01\/21\/asynchronous-eval-with-stylus-and-skewer\/';

 (function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>





    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>

    
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38439430-2', 'auto');
ga('send', 'pageview');
</script>

  </body>
</html>

